<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Server.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Ing-sw-2019-29</a> &gt; <a href="index.source.html" class="el_package">adrenaline.network.server</a> &gt; <span class="el_source">Server.java</span></div><h1>Server.java</h1><pre class="source lang-java linenums">

        package adrenaline.network.server;

// SOCKET
        import adrenaline.*;
        import adrenaline.gameboard.GameBoard;
        import adrenaline.powerups.Newton;
        import adrenaline.powerups.Teleporter;
        import adrenaline.weapons.MachineGun;
        import adrenaline.weapons.PlasmaGun;
        import adrenaline.weapons.Thor;

        import java.io.*;
        import java.util.*;
        import java.util.concurrent.locks.Lock;
        import java.util.concurrent.locks.ReentrantLock;
        import java.util.stream.*;

        import java.net.ServerSocket;
        import java.net.Socket;
        import java.util.concurrent.ExecutorService;
        import java.util.concurrent.Executors;


/**
 * This is a socket server. It is also the main controller.
 * It contains mainly:
 * &lt;ul&gt;
 *     &lt;li&gt; The model
 *     &lt;li&gt; Action, another little controller that helps the main controller.
 * &lt;/ul&gt;
 *
 * @author Eleonora Toscano
 * @author Giulia Valcamonica
 * @version 1.0
 */

public class Server {

    private GameModel model;
    private static Action action;
    private static FreneticAction freneticAction;
<span class="fc" id="L44">    private static int currentPlayer = 0;</span>
<span class="fc" id="L45">    private static boolean firstTurn = true;</span>
<span class="fc" id="L46">    private static boolean respawning = false;</span>

<span class="fc" id="L48">    private static int time = 0;</span>
<span class="fc" id="L49">    private static int connectionsCount = 0;</span>
<span class="fc" id="L50">    private static int boardChosen = 42;</span>
<span class="fc" id="L51">    private static boolean frenzy = false;  // TO KNOW IF I HAVE CHOSEN YET</span>
<span class="fc" id="L52">    private static boolean frenzyState = false;  // TO KNOW IF IT STARTED</span>
<span class="fc" id="L53">    private static boolean firstPlayerFrenzy = false;</span>
<span class="fc" id="L54">    private static boolean gameIsOn = false;</span>
<span class="fc" id="L55">    private static boolean endgame = false;</span>
<span class="fc" id="L56">    private static List&lt;CoordinatesWithRoom&gt; cellsWithoutTiles = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L57">    private static List&lt;String&gt; disconnected = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L58">    private static HashMap&lt;String,Figure.PlayerColor&gt; disconnectedColors = new HashMap&lt;&gt;();</span>

    // STRING LIST OF THE COLORS A PLAYER CAN CHOOSE AND LIST OF THOSE ALREADY CHOSEN
<span class="fc" id="L61">    private static List&lt;String&gt; possibleColors = Stream.of(Figure.PlayerColor.values())</span>
<span class="fc" id="L62">            .map(Figure.PlayerColor::name)</span>
<span class="fc" id="L63">            .collect(Collectors.toList());</span>
<span class="fc" id="L64">    private static ArrayList&lt;String&gt; colorsChosen = new ArrayList&lt;&gt;();</span>

    // All client names, so we can check for duplicates upon registration.
<span class="fc" id="L67">    private static ArrayList&lt;String&gt; names = new ArrayList&lt;&gt;();</span>

    // The set of all the print writers for all the clients, used for broadcast.
<span class="fc" id="L70">    private static HashMap&lt;String,ObjectOutputStream&gt; writers = new HashMap&lt;String,ObjectOutputStream&gt;();</span>

<span class="fc" id="L72">    private static HashMap&lt;String,ObjectInputStream&gt; writers2 = new HashMap&lt;&gt;();</span>


    private static ServerSocket serverSocket;
    private Server server;
    private ExecutorService threadPool;

<span class="fc" id="L79">    static ReentrantLock lock = new ReentrantLock();;</span>



    public void setup(String[] args) throws Exception {
<span class="nc" id="L84">        time =Integer.parseInt(args[0]);</span>
<span class="nc" id="L85">        possibleColors.remove(&quot;NONE&quot;);</span>

<span class="nc" id="L87">        server = new Server();</span>

<span class="nc" id="L89">        start();</span>
<span class="nc" id="L90">    }</span>

<span class="fc" id="L92">    public Server() {</span>
<span class="fc" id="L93">        threadPool = Executors.newCachedThreadPool();</span>
<span class="fc" id="L94">    }</span>


    public void start() {
        try {
<span class="nc" id="L99">            serverSocket = new ServerSocket(4321);</span>
<span class="nc" id="L100">        } catch (IOException e) {</span>
<span class="nc" id="L101">            System.out.println(&quot;Couldn't start server.&quot;);</span>
            // Server non si avvia
<span class="nc" id="L103">        }</span>
<span class="nc" id="L104">        System.out.println(&quot;SERVER ONLINE&quot;);</span>
        while (true) {

            try {
<span class="nc" id="L108">                Socket socket = serverSocket.accept();</span>

<span class="nc" id="L110">                new RequestHandler(socket).start();</span>
<span class="nc" id="L111">            } catch (IOException e) {</span>
<span class="nc" id="L112">                System.out.println(&quot;Couldn't accept socket connection.&quot;);</span>
<span class="nc" id="L113">                break;</span>
<span class="nc" id="L114">            }</span>
        }
<span class="nc" id="L116">    }</span>
    public static synchronized boolean isFirstTurn(){
<span class="nc" id="L118">        return firstTurn;</span>
    }
    public static void endFirstTurn(){
<span class="nc" id="L121">        firstTurn= false;</span>
<span class="nc" id="L122">    }</span>
    public static void setRespawning(boolean state){
<span class="nc" id="L124">            respawning = state;</span>
<span class="nc" id="L125">    }</span>
    public boolean getRespawning(){
<span class="nc" id="L127">        synchronized (this) {</span>
<span class="nc" id="L128">            return respawning;</span>
        }
    }

    public static void stopHandler(RequestHandler handler){
<span class="nc" id="L133">        handler.interrupt();</span>
<span class="nc" id="L134">    }</span>

    /**
     * This is a Thread that controls a socket connection with one client.
     */
    public class RequestHandler extends Thread {

        Figure.PlayerColor color;
        String nickname;
<span class="nc" id="L143">        boolean flag = false;</span>
        PlayerCountdown countdown;
<span class="nc" id="L145">        int numberOfActions =0;</span>
<span class="nc" id="L146">        int numberOfActionsFrenzy =0;</span>

        private final Socket socket;

        private final ObjectInputStream inputStream;

        private final ObjectOutputStream outputStream;

<span class="nc" id="L154">        public RequestHandler(Socket socket) throws IOException {</span>

<span class="nc" id="L156">            this.socket = socket;</span>
<span class="nc" id="L157">            this.outputStream = new ObjectOutputStream(new BufferedOutputStream(socket.getOutputStream()));</span>
<span class="nc" id="L158">            this.outputStream.flush();</span>
<span class="nc" id="L159">            this.inputStream = new ObjectInputStream(new BufferedInputStream(socket.getInputStream()));</span>

<span class="nc" id="L161">        }</span>

        @Override
        public void run() {
            try {
                try {

                    while (true) {
<span class="nc" id="L169">                        String msg = (String) inputStream.readObject();</span>
<span class="nc" id="L170">                        System.out.println(msg);</span>
<span class="nc" id="L171">                        clientLogin();</span>
<span class="nc" id="L172">                        handleTurns();</span>
<span class="nc" id="L173">                    }</span>
<span class="nc" id="L174">                } catch (IOException | ClassNotFoundException e) {</span>
<span class="nc" id="L175">                    System.out.println(&quot;Handler couldn't reach client. &quot;);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                    if(model.getPlayers().get(currentPlayer).getName().equals(nickname)) {</span>
<span class="nc" id="L177">                        nextPlayer();</span>
<span class="nc" id="L178">                        removeOneConnection();</span>
                    }
<span class="nc" id="L180">                    Server.stopHandler(this);</span>

<span class="nc bnc" id="L182" title="All 4 branches missed.">                    if(connectionsCount&lt;3 &amp;&amp; isGameOn()){</span>
<span class="nc" id="L183">                        System.out.println(&quot;Sent Final Scoring&quot;);</span>
<span class="nc" id="L184">                        sendFinalScoring();</span>
                    }
                }
<span class="nc" id="L187">            } catch (Exception e) {</span>
<span class="nc" id="L188">                System.out.println(&quot;Handler couldn't reach client BIS.&quot;);</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                if(model.getPlayers().get(currentPlayer).getName().equals(nickname)) {</span>
<span class="nc" id="L190">                    nextPlayer();</span>
<span class="nc" id="L191">                    removeOneConnection();</span>
                }
<span class="nc" id="L193">            }</span>
<span class="nc" id="L194">        }</span>

        /**
         * This handles the disconnection of a socket
         */
        public void disconnect(){
            try {
<span class="nc bnc" id="L201" title="All 2 branches missed.">                if(nickname!=null) {</span>
<span class="nc" id="L202">                    sendToClient(&quot;DISCONNECTED&quot;);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">                    if (!disconnected.contains(nickname)) {</span>
<span class="nc" id="L204">                        disconnected.add(nickname);</span>
                    }
<span class="nc bnc" id="L206" title="All 2 branches missed.">                    if (!disconnectedColors.containsKey(nickname)) {</span>
<span class="nc" id="L207">                        disconnectedColors.put(nickname, color);</span>
                    }
<span class="nc" id="L209">                    writers.remove(nickname, outputStream);</span>
<span class="nc" id="L210">                    writers2.remove(nickname, inputStream);</span>

               /* for(String s : disconnected){
                    System.out.println(s+ &quot; DISCONNECTED LIST&quot;);
                }

                */
<span class="nc" id="L217">                    System.out.println(&quot;DISCONNECTED CONTAINS &quot; + nickname + &quot; &quot; + disconnected.contains(nickname) + &quot; &quot; + disconnectedColors.containsKey(nickname));</span>

<span class="nc" id="L219">                    removeOneConnection();</span>
<span class="nc" id="L220">                    System.out.println(&quot;Client Disconnected++++ HERE -1&quot;);</span>
                }
<span class="nc" id="L222">                    socket.close();</span>
<span class="nc" id="L223">                Server.stopHandler(this);</span>

<span class="nc bnc" id="L225" title="All 2 branches missed.">                if(lock.isHeldByCurrentThread()) {</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">                    while (lock.getHoldCount() &gt; 0) {</span>
<span class="nc" id="L227">                        lock.unlock();</span>
                    }
                }
<span class="nc bnc" id="L230" title="All 4 branches missed.">                if(connectionsCount&lt;3 &amp;&amp; isGameOn()){</span>
<span class="nc" id="L231">                    System.out.println(&quot;Sent Final Scoring&quot;);</span>
<span class="nc" id="L232">                    sendFinalScoring();</span>
                }

<span class="nc" id="L235">            }catch (IOException e) {</span>
<span class="nc" id="L236">                System.out.println(&quot;Couldn't disconnect.&quot;);</span>
<span class="nc" id="L237">            }</span>
<span class="nc" id="L238">        }</span>

        /**
         * This sends a message (String) to the client.
         * @param message to send
         */
        public void sendToClient(String message){
            try {
<span class="nc" id="L246">                outputStream.writeObject(message);</span>
<span class="nc" id="L247">                outputStream.flush();</span>
<span class="nc" id="L248">            } catch (IOException e) {</span>
                // DISCONNECTED
<span class="nc" id="L250">            }</span>

<span class="nc" id="L252">        }</span>

        /**
         * This sends a list of Strings to the Client
         * @param messages list to send
         * @throws IOException
         */
        public void sendListToClient(List&lt;String&gt; messages) throws IOException {
<span class="nc" id="L260">            outputStream.writeObject(messages);</span>
<span class="nc" id="L261">            outputStream.flush();</span>
<span class="nc" id="L262">        }</span>

        /**
         * To add one to the connections.
         */
        public void countConnections(){

<span class="nc" id="L269">            Server.connectionsCount++;</span>
<span class="nc" id="L270">        }</span>

        /**
         * To remove one from the connectionsCount.
         */
        public void removeOneConnection(){

<span class="nc" id="L277">            Server.connectionsCount--;</span>
<span class="nc" id="L278">        }</span>


        /**
         * This handles the login. Gets the client's name and color, also gets board number and frenzy option.
         */
        public void clientLogin(){
            try {
<span class="nc bnc" id="L286" title="All 2 branches missed.">                if(!isGameOn()) {</span>
                    while (true) {
<span class="nc" id="L288">                        nickname = loginName();</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">                        if (!disconnected.contains(nickname)) {</span>
<span class="nc" id="L290">                            countConnections();</span>
<span class="nc" id="L291">                            System.out.println(connectionsCount +&quot; connections +++ HERE +1&quot;);</span>

<span class="nc bnc" id="L293" title="All 2 branches missed.">                            if(isGameOn()){</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">                                for(String s : disconnected){</span>
<span class="nc" id="L295">                                    System.out.println(s + &quot; disconnected+++++++++++&quot;);</span>
<span class="nc" id="L296">                                }</span>
<span class="nc" id="L297">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L298">                                sendToClient(&quot;Sorry, the game has already started without you&quot;);</span>
<span class="nc" id="L299">                                socket.close();</span>
                            }

<span class="nc" id="L302">                            color = checkColor();</span>
<span class="nc" id="L303">                            chooseBoard(nickname); // it checks if is firstPlayer and asks board</span>
<span class="nc" id="L304">                            chooseFrenzy();</span>

<span class="nc" id="L306">                            sendToClient(&quot;ACCEPTED&quot;);</span>

<span class="nc bnc" id="L308" title="All 2 branches missed.">                            if (connectionsCount == 3) {</span>
<span class="nc" id="L309">                                Countdown c = new Countdown();</span>
                            }
<span class="nc" id="L311">                            addPlayerToGame(nickname, color);</span>
<span class="nc" id="L312">                            writers.put(nickname, outputStream);</span>
<span class="nc" id="L313">                            writers2.put(nickname, inputStream);</span>

<span class="nc" id="L315">                            break;</span>
                        }
<span class="nc bnc" id="L317" title="All 2 branches missed.">                        if (disconnected.contains(nickname)) {</span>
                            // FALLO GIOCARE, WELCOME BACK
<span class="nc" id="L319">                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L320">                            sendToClient(&quot;Welcome back!&quot;);</span>

<span class="nc" id="L322">                            countConnections();</span>
<span class="nc" id="L323">                            System.out.println(connectionsCount +&quot; connections /////HERE +1&quot;);</span>

<span class="nc bnc" id="L325" title="All 4 branches missed.">                            if (disconnectedColors.get(nickname) == Figure.PlayerColor.NONE || disconnectedColors.get(nickname)==null) {</span>
<span class="nc" id="L326">                                color = checkColor();</span>
                            }

<span class="nc" id="L329">                            chooseBoard(nickname); // it checks if is firstPlayer and asks board</span>
<span class="nc" id="L330">                            chooseFrenzy();</span>

<span class="nc" id="L332">                            sendToClient(&quot;ACCEPTED&quot;);</span>

<span class="nc bnc" id="L334" title="All 2 branches missed.">                            if (connectionsCount == 3) {</span>
<span class="nc" id="L335">                                Countdown c = new Countdown();</span>
                            }
<span class="nc" id="L337">                            addPlayerToGame(nickname, color);</span>
<span class="nc" id="L338">                            writers.put(nickname, outputStream);</span>
<span class="nc" id="L339">                            writers2.put(nickname, inputStream);</span>
<span class="nc" id="L340">                            reconnect();</span>
<span class="nc" id="L341">                            break;</span>

                        }
                    }

                    //disconnect(); TO TRY TO DISCONNECT

<span class="nc bnc" id="L348" title="All 4 branches missed.">                }else if(disconnected.isEmpty() &amp;&amp; isGameOn()){</span>
<span class="nc" id="L349">                    sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L350">                    sendToClient(&quot;Sorry, the game has already started without you&quot;);</span>
<span class="nc" id="L351">                    socket.close();</span>

<span class="nc bnc" id="L353" title="All 4 branches missed.">                }else if(!disconnected.isEmpty() &amp;&amp; isGameOn()){</span>
<span class="nc" id="L354">                    nickname = loginName();</span>

<span class="nc bnc" id="L356" title="All 2 branches missed.">                    if (disconnected.contains(nickname)) {</span>
                        // FALLO GIOCARE, WELCOME BACK
<span class="nc" id="L358">                        sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L359">                        sendToClient(&quot;Welcome back!&quot;);</span>

<span class="nc" id="L361">                        countConnections();</span>
<span class="nc" id="L362">                        System.out.println(connectionsCount + &quot; connections *****HERE +1&quot;);</span>

<span class="nc" id="L364">                        writers.put(nickname, outputStream);</span>
<span class="nc" id="L365">                        writers2.put(nickname, inputStream);</span>
<span class="nc" id="L366">                        disconnected.remove(nickname);</span>
<span class="nc" id="L367">                        disconnectedColors.remove(nickname);</span>
                    }else {

<span class="nc" id="L370">                        sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L371">                        sendToClient(&quot;Sorry, the game has already started without you&quot;);</span>
<span class="nc" id="L372">                        socket.close();</span>
                    }
                }

<span class="nc" id="L376">            } catch (Exception e) {</span>
<span class="nc" id="L377">                System.out.println(&quot;Client couldn't log in.&quot;);</span>
<span class="nc" id="L378">            }</span>

<span class="nc" id="L380">        }</span>

        /**
         * This handles the reconnection to the server
         */
        public void reconnect(){
            try {
<span class="nc" id="L387">                writers.put(nickname, outputStream);</span>
<span class="nc" id="L388">                writers2.put(nickname, inputStream);</span>

<span class="nc bnc" id="L390" title="All 2 branches missed.">                if (disconnected.contains(nickname)) {</span>
<span class="nc" id="L391">                    disconnected.remove(nickname);</span>
<span class="nc" id="L392">                    System.out.println(&quot;REMOVED 1&quot;);</span>
                }
<span class="nc bnc" id="L394" title="All 2 branches missed.">                if (disconnectedColors.containsKey(nickname)) {</span>
<span class="nc" id="L395">                    disconnectedColors.remove(nickname);</span>
<span class="nc" id="L396">                    System.out.println(&quot;REMOVED 2&quot;);</span>
                }
<span class="nc" id="L398">            }catch (Exception e){</span>
<span class="nc" id="L399">                System.out.println(&quot;DIDN'T REMOVE FROM DISCONNECT&quot;);</span>
<span class="nc" id="L400">            }</span>
<span class="nc" id="L401">        }</span>

        /**
         * This handles the nickname acceptance.
         * @return the nickname
         */
        public String loginName(){
            try {
<span class="nc" id="L409">                sendToClient(&quot;LOGIN&quot;);</span>
<span class="nc" id="L410">                String name = (String) inputStream.readObject();</span>
                // Keep requesting a name until we get a unique one.
                while (true) {
<span class="nc bnc" id="L413" title="All 2 branches missed.">                    if (name != null) {</span>
<span class="nc" id="L414">                        synchronized (names) {</span>
<span class="nc bnc" id="L415" title="All 4 branches missed.">                            if (!isBlank(name) &amp;&amp; !names.contains(name)) {</span>
<span class="nc" id="L416">                                names.add(name);</span>
<span class="nc" id="L417">                                return name;</span>
<span class="nc bnc" id="L418" title="All 4 branches missed.">                            } else if (names.contains(name) &amp;&amp; !disconnected.contains(name)) {</span>
<span class="nc" id="L419">                                System.out.println(&quot;names contains name &quot; + names.contains(name));</span>
<span class="nc" id="L420">                                System.out.println(&quot;disconnected contains name &quot; + disconnected.contains(name));</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">                                for (String s : disconnected) {</span>
<span class="nc" id="L422">                                    System.out.println(s + &quot; DISCONNECTED LIST&quot;);</span>
<span class="nc" id="L423">                                }</span>

<span class="nc" id="L425">                                sendToClient(&quot;LOGIN&quot;);</span>
<span class="nc" id="L426">                                name = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">                            } else if (disconnected.contains(name)) {</span>
<span class="nc" id="L428">                                return name;</span>
                            }
<span class="nc" id="L430">                        }</span>
                    }
                }
<span class="nc" id="L433">            }catch (Exception e){</span>
<span class="nc" id="L434">                System.out.println(&quot;Couldn't log in&quot;);</span>
            }
<span class="nc" id="L436">            return null;</span>
        }

        /**
         * This handles the color choice.
         * @return the color chosen
         */
        public Figure.PlayerColor checkColor(){
            try {
                while (true) {
<span class="nc" id="L446">                    String csv = String.join(&quot;, &quot;, possibleColors);  // SEND POSSIBLE COLORS</span>
<span class="nc" id="L447">                    sendToClient(&quot;COLOR&quot;);</span>
<span class="nc" id="L448">                    sendToClient(csv);</span>
<span class="nc" id="L449">                    String color = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">                    if (color != null) {</span>
<span class="nc" id="L451">                        synchronized (possibleColors) {</span>
<span class="nc bnc" id="L452" title="All 6 branches missed.">                            if (!possibleColors.isEmpty() &amp;&amp; (possibleColors.contains(color.toUpperCase()) || possibleColors.contains(color))</span>
<span class="nc bnc" id="L453" title="All 6 branches missed.">                                    &amp;&amp; (colorsChosen.isEmpty() || (!colorsChosen.contains(color) &amp;&amp; !colorsChosen.contains(color.toUpperCase())))) {</span>
<span class="nc" id="L454">                                colorsChosen.add(color.toUpperCase());</span>
<span class="nc" id="L455">                                possibleColors.remove(color.toUpperCase());</span>
<span class="nc" id="L456">                                return Figure.PlayerColor.valueOf(color.toUpperCase());</span>
<span class="nc bnc" id="L457" title="All 4 branches missed.">                            } else if ((!possibleColors.contains(color.toUpperCase()) || !possibleColors.contains(color))</span>
<span class="nc bnc" id="L458" title="All 4 branches missed.">                                    &amp;&amp; !colorsChosen.contains(color.toUpperCase()) &amp;&amp; !colorsChosen.contains(color)) {</span>
                                //  ASK AGAIN FOR COLOR, IT WASN'T ACCEPTED

<span class="nc bnc" id="L461" title="All 4 branches missed.">                            } else if (colorsChosen.contains(color.toUpperCase()) || colorsChosen.contains(color)) {</span>
                                //  ASK AGAIN FOR COLOR, IT WAS A DUPLICATE COLOR
                            }
<span class="nc" id="L464">                        }</span>
                    }
<span class="nc" id="L466">                }</span>
<span class="nc" id="L467">            }catch (Exception e){</span>
<span class="nc" id="L468">                System.out.println(&quot;--Color disconnection&quot;);</span>
            }
<span class="nc" id="L470">            return Figure.PlayerColor.NONE;</span>
        }

        /**
         * This method adds a Player to the Game.
         * @param name nickname of the player
         * @param color color of the player
         */
        public void addPlayerToGame(String name, Figure.PlayerColor color){
            try {
<span class="nc" id="L480">                lock.lock();</span>
<span class="nc" id="L481">                model.addPlayer(new Player(name, color));</span>
<span class="nc" id="L482">                lock.unlock();</span>
                /*
                System.out.println(lock.isHeldByCurrentThread() + &quot; held by &quot; + nickname);
                System.out.println(lock.isLocked() + &quot; is locked &quot; + nickname);
                System.out.println(lock.getHoldCount() + &quot; count &quot; + nickname);
*/
<span class="nc bnc" id="L488" title="All 2 branches missed.">                if (lock.isHeldByCurrentThread()) {</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">                    while (lock.getHoldCount() &gt;= 1) {</span>
<span class="nc" id="L490">                        lock.unlock();</span>
                    }
                }

<span class="nc" id="L494">                broadcast(name + &quot; has joined&quot;);</span>
<span class="nc" id="L495">            }catch (Exception e){</span>
<span class="nc" id="L496">                System.out.println(&quot;Couldn't add player to game&quot;);</span>
<span class="nc" id="L497">            }</span>
<span class="nc" id="L498">        }</span>

        /**
         * This method broadcasts messages to the writers (list of Server).
         *
         * @param s message to broadcast
         */
        public synchronized void broadcast(String s){
<span class="nc" id="L506">            lock.lock();</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">            for (Map.Entry me : writers.entrySet()) {</span>
                try {
<span class="nc" id="L509">                    ((ObjectOutputStream)me.getValue()).writeObject(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L510">                    ((ObjectOutputStream)me.getValue()).flush();</span>

<span class="nc" id="L512">                    ((ObjectOutputStream)me.getValue()).writeObject(s);</span>
<span class="nc" id="L513">                    ((ObjectOutputStream)me.getValue()).flush();</span>

<span class="nc" id="L515">                } catch (IOException e) {</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">                    if(nickname!=null) {</span>
                        // CAUSE: DISCONNECTED
                        //ELIMINA ENTRY IN WRITER
                        //AGGIUNGI A DISCONNECTED
                        //AGGIUNGI A DISCONNECTEDCOLORS
<span class="nc" id="L521">                        System.out.println(&quot;Someone disconnected from game and I couldn't reach him.&quot;);</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">                        if (!disconnected.contains(me.getKey().toString())) {</span>
<span class="nc" id="L523">                            disconnected.add(me.getKey().toString());</span>
                        }
<span class="nc bnc" id="L525" title="All 2 branches missed.">                        if (!disconnectedColors.containsKey(me.getKey().toString())) {</span>
<span class="nc" id="L526">                            disconnectedColors.put(me.getKey().toString(), disconnectedColors.get(me.getKey().toString()));</span>
                        }
<span class="nc" id="L528">                        writers.remove(me.getKey().toString(), (ObjectOutputStream) me.getValue());</span>
<span class="nc" id="L529">                        writers2.remove(me.getKey().toString());</span>
                   /* for(String d : disconnected){
                        System.out.println(d+ &quot; DISCONNECTED LIST&quot;);
                    }

                   */
<span class="nc" id="L535">                        System.out.println(&quot;DISCONNECTED CONTAINS &quot; + me.getKey().toString() + &quot; &quot; + disconnected.contains(me.getKey().toString()) + &quot; &quot; + disconnectedColors.containsKey(me.getKey().toString()));</span>
<span class="nc" id="L536">                        removeOneConnection();</span>
<span class="nc" id="L537">                        System.out.println(&quot;Client Disconnected++ HERE -1&quot;);</span>

                    }
<span class="nc bnc" id="L540" title="All 2 branches missed.">                    if(lock.isHeldByCurrentThread()) {</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">                        while (lock.getHoldCount() &gt; 1) {</span>
<span class="nc" id="L542">                            lock.unlock();</span>
                        }
                    }

<span class="nc bnc" id="L546" title="All 4 branches missed.">                    if(connectionsCount&lt;3 &amp;&amp; isGameOn()){</span>
<span class="nc" id="L547">                        System.out.println(&quot;Sent Final Scoring&quot;);</span>
<span class="nc" id="L548">                        sendFinalScoring();</span>
                    }
<span class="nc" id="L550">                }</span>
<span class="nc" id="L551">            }</span>
<span class="nc" id="L552">            lock.unlock();</span>
<span class="nc" id="L553">        }</span>

        /**
         * This handles the end of the game.
         */
        public void ending(){

<span class="nc bnc" id="L560" title="All 2 branches missed.">            if(model.hasFrenzyOn()){</span>
                //FRENZY
                // SI PASSA A DUE TURNI SPECIALI
<span class="nc" id="L563">                frenzyState=true;</span>

            }else {

<span class="nc" id="L567">                sendFinalScoring();</span>
                //setGameIsOn(false); // EXITS????????????
            }
<span class="nc" id="L570">        }</span>

        /**
         * This handle the map choice.
         * @param name of the player
         */
        public void chooseBoard(String name){
<span class="nc" id="L577">            lock.lock();</span>
            try {
<span class="nc bnc" id="L579" title="All 2 branches missed.">                if(boardChosen==42){</span>

<span class="nc bnc" id="L581" title="All 2 branches missed.">                    while(boardChosen==42){</span>
<span class="nc" id="L582">                        int result = 0;</span>
<span class="nc" id="L583">                        sendToClient(&quot;BOARD&quot;);</span>
<span class="nc" id="L584">                        result = (int)inputStream.readObject();</span>
<span class="nc bnc" id="L585" title="All 8 branches missed.">                        if (result == 1 || result == 2 || result == 3 || result == 4) {</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">                            if(boardChosen!=42) return;</span>

<span class="nc" id="L588">                            setBoardChosen(result);</span>
<span class="nc" id="L589">                            System.out.println(&quot;BOARD CHOSEN &quot; + result);</span>

<span class="nc" id="L591">                            return;</span>
                        } else {
                            //  ASK AGAIN BECAUSE NOT ACCEPTED
                        }

<span class="nc" id="L596">                    }</span>

<span class="nc" id="L598">                    lock.unlock();</span>
                }
<span class="nc" id="L600">            }catch (Exception e){</span>
<span class="nc" id="L601">                lock.unlock();</span>
<span class="nc" id="L602">                disconnect();</span>
<span class="nc" id="L603">                System.out.println(&quot;--Board disconnection&quot;);</span>
<span class="nc" id="L604">            }</span>
<span class="nc" id="L605">        }</span>

        /**
         * This handles the frenzy option choice.
         */
        public void chooseFrenzy(){
            try {
<span class="nc bnc" id="L612" title="All 2 branches missed.">                if(!frenzy){</span>
<span class="nc" id="L613">                    lock.lock();</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">                    while(!frenzy){</span>

<span class="nc" id="L616">                        sendToClient(&quot;FRENZY&quot;);</span>
<span class="nc" id="L617">                        String response = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">                        if (response.toUpperCase().equals(&quot;Y&quot;)) {</span>

<span class="nc" id="L620">                            createBoard(true);</span>
<span class="nc" id="L621">                            setFrenzyChosen();</span>
<span class="nc" id="L622">                            lock.unlock();</span>
<span class="nc" id="L623">                            return;</span>
                        } else {
<span class="nc" id="L625">                            createBoard(false);</span>
<span class="nc" id="L626">                            setFrenzyChosen();</span>
<span class="nc" id="L627">                            lock.unlock();</span>
<span class="nc" id="L628">                            return;</span>
                        }

                    }

                }
<span class="nc" id="L634">            }catch (Exception e){</span>
<span class="nc" id="L635">                lock.unlock();</span>
<span class="nc" id="L636">                disconnect();</span>
<span class="nc" id="L637">                System.out.println(&quot;--Frenzy disconnection&quot;);</span>
<span class="nc" id="L638">            }</span>
<span class="nc" id="L639">        }</span>
        ////


        /**
         * This handles the uses of TagbackGrenade, a powerup.
         */
        public void tagbackGrenade() {
            // CAN SEE SHOOTER
<span class="nc" id="L648">            Player me = fromNameToPlayer(nickname);</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">            if(me.hasTagbackGrenade()) {</span>
<span class="nc" id="L650">                Player shooter = fromNameToPlayer(me.getShooter());</span>
<span class="nc" id="L651">                WeaponCard w = new WeaponCard();</span>
<span class="nc" id="L652">                EffectAndNumber en = new EffectAndNumber(AmmoCube.Effect.BASE, 0);</span>
<span class="nc" id="L653">                List&lt;CoordinatesWithRoom&gt; list = w.getPossibleTargetCells(me.getCoordinatesWithRooms(), en, model.getMapUsed().getGameBoard());</span>
<span class="nc" id="L654">                List&lt;Object&gt; t = w.fromCellsToTargets(list, me.getCoordinatesWithRooms(), model.getMapUsed().getGameBoard(), me, model, en);</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">                for (Object o : t) {</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">                    if ((Player) o == shooter) {</span>
                        try {// ASK IF WANT TO USE
<span class="nc" id="L658">                            lock.lock();</span>
<span class="nc" id="L659">                            sendToClient(&quot;TAGBACKGRENADE&quot;);</span>
<span class="nc" id="L660">                            String response = (String) inputStream.readObject();</span>
<span class="nc" id="L661">                            lock.unlock();</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">                            if (response.toUpperCase().equals(&quot;Y&quot;)) {</span>
                                // ADD MARK
<span class="nc" id="L664">                                shooter.addMarks(me, 1);</span>
                                // DISCARD CARD
<span class="nc" id="L666">                                model.powerUpDeck.setUsedPowerUp(me.getTagbackGrenade());</span>
<span class="nc" id="L667">                                me.getPowerUp().remove(me.getTagbackGrenade());</span>

<span class="nc" id="L669">                                me.setDamagedStatus(false);</span>
<span class="nc" id="L670">                                me.setShooter(null);</span>
                            }
<span class="nc" id="L672">                        } catch (Exception e) {</span>
<span class="nc" id="L673">                            System.out.println(&quot;Couldn't use Tagback Grenade.&quot;);</span>
<span class="nc" id="L674">                        }</span>
                    }
<span class="nc" id="L676">                }</span>
            }
<span class="nc" id="L678">        }</span>

        /**
         * This checks the current player
         * @return the current player
         */
        public boolean isCurrentPlayer(){
<span class="nc" id="L685">            synchronized (model.getPlayers().get(currentPlayer)){</span>
<span class="nc" id="L686">                return model.getPlayers().get(currentPlayer).getName().equals(nickname);</span>
            }
        }

        /**
         * This checks if a Player if a player has been damaged.
         * @return boolean if damaged
         */
        public boolean hasBeenDamaged(){
<span class="nc" id="L695">            synchronized (model.getPlayers()){</span>
<span class="nc" id="L696">                return fromNameToPlayer(nickname).damagedStatus();</span>
            }
        }

        /**
         * This gets a Player out of the nickname.
         * @param s nickname
         * @return Player
         */
        public Player fromNameToPlayer(String s){
<span class="nc" id="L706">            lock.lock();</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">            for (Player p : model.getPlayers()){</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                if(p.getName().equals(s)){</span>
<span class="nc" id="L709">                    lock.unlock();</span>
<span class="nc" id="L710">                    return p;</span>
                }
<span class="nc" id="L712">            }</span>
<span class="nc" id="L713">            lock.unlock();</span>
<span class="nc" id="L714">            return new Player();</span>
        }

        /**
         * If Game is ready to start, everybody added, connected.
         *
         * @return boolean starting
         */
        public boolean isGameOn(){
<span class="nc" id="L723">            synchronized (this){</span>
<span class="nc" id="L724">                return gameIsOn;</span>
            }
        }

        /**
         *If Game is ending.
         *
         * @return boolean ending
         */
        public boolean isEndgame(){
<span class="nc" id="L734">            synchronized (this){</span>
<span class="nc" id="L735">                return endgame;</span>
            }
        }

        /**
         * Checks if first player has played his/her frenzy turn.
         *
         * @return boolean
         */
        public boolean hasFirstPlayerPlayedFrenzy(){
<span class="nc" id="L745">            synchronized (this){</span>
<span class="nc" id="L746">                return firstPlayerFrenzy;</span>
            }
        }

        /**
         * If Frenzy has started.
         *
         * @return boolean
         */
        public boolean isFrenzyOn(){
<span class="nc" id="L756">            synchronized (this){</span>
<span class="nc" id="L757">                return frenzyState;</span>
            }
        }

        /**
         * Sets that first player has played frenzy.
         */
        public void firstPlayerPlayedFrenzy(){
<span class="nc" id="L765">            synchronized (this){</span>
<span class="nc" id="L766">                firstPlayerFrenzy=true;</span>
<span class="nc" id="L767">            }</span>
<span class="nc" id="L768">        }</span>

        /**
         * Startts turn countdown.
         *
         * @param handler of current player
         */
        public synchronized void startCountdown(RequestHandler handler){
<span class="nc" id="L776">            countdown = new PlayerCountdown(handler);</span>
<span class="nc" id="L777">            System.out.println(handler.nickname + &quot; &quot;+ handler);</span>
<span class="nc" id="L778">        }</span>

        public void flagFalse(){
<span class="nc" id="L781">            flag=false;</span>
<span class="nc" id="L782">        }</span>

        public void setNumberofActions(int x){
<span class="nc" id="L785">            numberOfActions=x;</span>
<span class="nc" id="L786">        }</span>
        public int getNumberofActions(){
<span class="nc" id="L788">            return numberOfActions;</span>
        }
        public void numberofActionsPlusOne(){
<span class="nc" id="L791">            numberOfActions++;</span>
<span class="nc" id="L792">        }</span>
        public void numberofActionsMinusOne(WeaponCard w){
<span class="nc" id="L794">            numberOfActions--;</span>
<span class="nc" id="L795">            w.setReload();</span>
<span class="nc" id="L796">        }</span>

        public void setNumberOfActionsFrenzy(int x){
<span class="nc" id="L799">            numberOfActionsFrenzy=x;</span>
<span class="nc" id="L800">        }</span>
        public int getNumberOfActionsFrenzy(){
<span class="nc" id="L802">            return numberOfActionsFrenzy;</span>
        }
        public void numberofActionsFrenzyPlusOne(){
<span class="nc" id="L805">            numberOfActionsFrenzy++;</span>
<span class="nc" id="L806">        }</span>
        public void numberofActionsFrenzyMinusOne(WeaponCard w){
<span class="nc" id="L808">            numberOfActionsFrenzy--;</span>
<span class="nc" id="L809">            w.setReload();</span>
<span class="nc" id="L810">        }</span>

        /**
         * This handles the turn of the client.
         * It waits until it is the current player before it sends info to the client.
         * Th input comes in in the clients turn or not if it's broadcast.
         */
        public void handleTurns(){
<span class="nc" id="L818">            setNumberofActions(0);</span>
<span class="nc" id="L819">            boolean counterOn=false;</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">            while(!isEndgame()) {</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">                if (isGameOn()) {</span>

<span class="nc bnc" id="L823" title="All 2 branches missed.">                    if (isCurrentPlayer()) {</span>

<span class="nc bnc" id="L825" title="All 2 branches missed.">                        if(getRespawning()) {</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">                            if (fromNameToPlayer(nickname).isDead()) {</span>
<span class="nc" id="L827">                                respawn(fromNameToPlayer(nickname));</span>
                            }
<span class="nc" id="L829">                            nextPlayer();</span>
                        }else {


<span class="nc bnc" id="L833" title="All 2 branches missed.">                            if (!isFrenzyOn()) {</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">                                if (!counterOn) {</span>
<span class="nc" id="L835">                                    startCountdown(this);</span>
<span class="nc" id="L836">                                    counterOn = true;</span>
                                }

                                try {
<span class="nc bnc" id="L840" title="All 2 branches missed.">                                    if (Server.isFirstTurn()) {</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">                                        if (currentPlayer == 0) {</span>

<span class="nc" id="L843">                                            broadcast(&quot;\nThe board is number &quot; + boardChosen);</span>
                                        }
<span class="nc" id="L845">                                        lock.lock();</span>
<span class="nc" id="L846">                                        sendToClient(&quot;YOURFIRSTTURN&quot;);</span>
<span class="nc" id="L847">                                        System.out.println(&quot;FIRST TURN&quot;);</span>
<span class="nc" id="L848">                                        System.out.println(&quot;\n&quot; + nickname);</span>
<span class="nc" id="L849">                                        sendForBoardSetup();</span>
<span class="nc" id="L850">                                        System.out.println(nickname + &quot;\n&quot;);</span>
<span class="nc" id="L851">                                        lock.unlock();</span>
<span class="nc" id="L852">                                        firstTurn();</span>
<span class="nc" id="L853">                                        setNumberofActions(0);</span>
<span class="nc" id="L854">                                        System.out.println(&quot;CURRENT PLAYER &quot; + currentPlayer);</span>
                                    }
<span class="nc bnc" id="L856" title="All 4 branches missed.">                                    if (getNumberofActions() != 2 &amp;&amp; !firstTurn) {</span>
<span class="nc" id="L857">                                        lock.lock();</span>
<span class="nc" id="L858">                                        sendToClient(&quot;YOURTURN&quot;);</span>

<span class="nc" id="L860">                                        String choice = (String) inputStream.readObject();</span>
<span class="nc" id="L861">                                        lock.unlock();</span>
<span class="nc" id="L862">                                        System.out.println(choice);</span>
<span class="nc bnc" id="L863" title="All 7 branches missed.">                                        switch (choice) {</span>
                                            case &quot;G&quot;:
<span class="nc" id="L865">                                                lock.lock();</span>
<span class="nc" id="L866">                                                sendToClient(&quot;GRAB&quot;);</span>
<span class="nc" id="L867">                                                grab(false, false);</span>
<span class="nc" id="L868">                                                lock.unlock();</span>
<span class="nc" id="L869">                                                numberofActionsPlusOne();</span>
<span class="nc" id="L870">                                                break;</span>
                                            case &quot;R&quot;:
<span class="nc" id="L872">                                                lock.lock();</span>
<span class="nc" id="L873">                                                sendToClient(&quot;RUN&quot;);</span>
<span class="nc" id="L874">                                                playerRun();</span>
<span class="nc" id="L875">                                                lock.unlock();</span>
<span class="nc" id="L876">                                                numberofActionsPlusOne();</span>
<span class="nc" id="L877">                                                break;</span>
                                            case &quot;M&quot;:
<span class="nc" id="L879">                                                lock.lock();</span>
<span class="nc" id="L880">                                                sendToClient(&quot;MAP&quot;);</span>
<span class="nc" id="L881">                                                sendForBoardSetup();</span>
<span class="nc" id="L882">                                                lock.unlock();</span>
<span class="nc" id="L883">                                                break;</span>
                                            case &quot;C&quot;:
<span class="nc" id="L885">                                                lock.lock();</span>
<span class="nc" id="L886">                                                sendToClient(&quot;SCORE&quot;);</span>
<span class="nc" id="L887">                                                sendScoring();</span>
<span class="nc" id="L888">                                                lock.unlock();</span>
<span class="nc" id="L889">                                                break;</span>
                                            case &quot;B&quot;:
<span class="nc" id="L891">                                                lock.lock();</span>
<span class="nc" id="L892">                                                sendToClient(&quot;BOARDS&quot;);</span>
<span class="nc" id="L893">                                                playerBoards();</span>
<span class="nc" id="L894">                                                sendMarks();</span>
<span class="nc" id="L895">                                                sendWeapons();</span>
<span class="nc" id="L896">                                                sendPowerUps();</span>
<span class="nc" id="L897">                                                sendAmmo();</span>
<span class="nc" id="L898">                                                sendPositions();</span>
<span class="nc" id="L899">                                                lock.unlock();</span>
<span class="nc" id="L900">                                                break;</span>
                                            case &quot;P&quot;:
<span class="nc" id="L902">                                                powerup();</span>
<span class="nc" id="L903">                                                break;</span>
                                            case &quot;S&quot;:
                                            default:
<span class="nc" id="L906">                                                shoot();</span>
<span class="nc" id="L907">                                                numberofActionsPlusOne();</span>
                                                break;
                                        }
                                    }
<span class="nc" id="L911">                                } catch (Exception e) {</span>
                                    try {//e.printStackTrace();

<span class="nc" id="L914">                                        countdown.timer.cancel();</span>
<span class="nc" id="L915">                                        counterOn = false;</span>
                                /*
                                System.out.println(&quot;EXCEPTION DISCONNECTION&quot;);
                                System.out.println(&quot;by &quot;+ this.toString());*/

<span class="nc bnc" id="L920" title="All 2 branches missed.">                                        if (lock.isHeldByCurrentThread()) {</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">                                            while (lock.getHoldCount() &gt; 0) {</span>
<span class="nc" id="L922">                                                lock.unlock();</span>
                                            }
                                        }

<span class="nc" id="L926">                                        Server.stopHandler(this);</span>
                                /*
//                                    replaceAmmo();
//                                    replaceWeapons();
//                                    nextPlayer();

                                    numberOfActions = 0;
                                    setNotDamaged();
                                    System.out.println(&quot;CURRENT PLAYER &quot; + currentPlayer + &quot; &quot; + nickname);

                                disconnect();

                                    lock.lock();
                                    sendToClient(&quot;DISCONNECTED&quot;);
                                    lock.unlock();*/
<span class="nc" id="L941">                                        break;</span>
<span class="nc" id="L942">                                    } catch (Exception ex) {</span>
<span class="nc" id="L943">                                        System.out.println(&quot;Couldn't disconnect and pass turn.&quot;);</span>
                                    }
<span class="nc" id="L945">                                }</span>
                                // END OF TURN
<span class="nc bnc" id="L947" title="All 4 branches missed.">                                if (getNumberofActions() == 2 &amp;&amp; !firstTurn) {</span>

                                    // CAN USE SOME POWERUPS BEFORE END OF TURN
<span class="nc" id="L950">                                    powerup();</span>

<span class="nc" id="L952">                                    reload();</span>
<span class="nc" id="L953">                                    countdown.timer.cancel();</span>
<span class="nc" id="L954">                                    counterOn = false;</span>
<span class="nc" id="L955">                                    scoring();</span>
<span class="nc" id="L956">                                    setNotDamaged();</span>
                                    //synchronized (model.getMapUsed()) {model.populateMap();}

                                    //replaceAmmo();
                                    //replaceWeapons();
<span class="nc" id="L961">                                    model.populateMap();</span>

<span class="nc" id="L963">                                    System.out.println(&quot;        ---NEXT PLAYER&quot;);</span>
<span class="nc" id="L964">                                    nextPlayer();</span>
                                    //broadcast(nickname +&quot; ended his turn. Now is the turn of &quot;+model.getPlayers().get(currentPlayer));
<span class="nc" id="L966">                                    setNumberofActions(0);</span>
<span class="nc" id="L967">                                    System.out.println(&quot;CURRENT PLAYER &quot; + currentPlayer);</span>

/*
                            System.out.println(&quot;\n Thread info: &quot;);
                            System.out.println(lock.isHeldByCurrentThread()+ &quot; &quot; + nickname);
                            System.out.println(lock.isLocked() + &quot; &quot; + nickname);
                            System.out.println(lock.getHoldCount() + &quot; &quot; + nickname);
*/
<span class="nc bnc" id="L975" title="All 2 branches missed.">                                    if (lock.isHeldByCurrentThread()) {</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">                                        while (lock.getHoldCount() &gt; 0) {</span>
<span class="nc" id="L977">                                            lock.unlock();</span>
                                        }
                                    }

                                }
<span class="nc bnc" id="L982" title="All 4 branches missed.">                                if (Server.isFirstTurn() &amp;&amp; !flag) {</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">                                    if (currentPlayer == model.getPlayers().size() - 1) {</span>
<span class="nc" id="L984">                                        Server.endFirstTurn();</span>
                                    }
<span class="nc" id="L986">                                    countdown.timer.cancel();</span>
<span class="nc" id="L987">                                    counterOn = false;</span>

<span class="nc" id="L989">                                    System.out.println(&quot;        +++NEXT PLAYER&quot;);</span>
<span class="nc" id="L990">                                    nextPlayer();</span>
                                    //broadcast(nickname +&quot; ended his turn. Now is the turn of &quot;+model.getPlayers().get(currentPlayer));
<span class="nc" id="L992">                                    setNumberofActions(0);</span>
<span class="nc" id="L993">                                    System.out.println(&quot;CURRENT PLAYER &quot; + currentPlayer);</span>
/*
                            System.out.println(&quot;\n Thread info: &quot;);
                            System.out.println(lock.isHeldByCurrentThread()+ &quot; &quot; + nickname);
                            System.out.println(lock.isLocked() + &quot; &quot; + nickname);
                            System.out.println(lock.getHoldCount() + &quot; &quot; + nickname);
*/

<span class="nc bnc" id="L1001" title="All 2 branches missed.">                                    if (lock.isHeldByCurrentThread()) {</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">                                        while (lock.getHoldCount() &gt; 0) {</span>
<span class="nc" id="L1003">                                            lock.unlock();</span>
                                        }
                                    }

                                }

                            } else { // FRENZY ON

<span class="nc bnc" id="L1011" title="All 2 branches missed.">                                if (!counterOn) {</span>
<span class="nc" id="L1012">                                    startCountdown(this);</span>
<span class="nc" id="L1013">                                    counterOn = true;</span>
                                }
                                try {
<span class="nc bnc" id="L1016" title="All 4 branches missed.">                                    if (!hasFirstPlayerPlayedFrenzy() &amp;&amp; !model.getPlayers().get(0).getName().equals(nickname)) {</span>

<span class="nc" id="L1018">                                        lock.lock();</span>
<span class="nc" id="L1019">                                        sendToClient(&quot;FRENZY1&quot;);</span>

<span class="nc" id="L1021">                                        String choice = (String) inputStream.readObject();</span>
<span class="nc" id="L1022">                                        lock.unlock();</span>
<span class="nc" id="L1023">                                        System.out.println(choice);</span>
<span class="nc bnc" id="L1024" title="All 6 branches missed.">                                        switch (choice) {</span>
                                            case &quot;G&quot;:
<span class="nc" id="L1026">                                                lock.lock();</span>
<span class="nc" id="L1027">                                                grabFrenzy();</span>
<span class="nc" id="L1028">                                                numberofActionsPlusOne();</span>
<span class="nc" id="L1029">                                                lock.unlock();</span>
<span class="nc" id="L1030">                                                break;</span>
                                            case &quot;R&quot;:
<span class="nc" id="L1032">                                                lock.lock();</span>
<span class="nc" id="L1033">                                                runFrenzy();</span>
<span class="nc" id="L1034">                                                numberofActionsPlusOne();</span>
<span class="nc" id="L1035">                                                lock.unlock();</span>
<span class="nc" id="L1036">                                                break;</span>
                                            case &quot;M&quot;:
<span class="nc" id="L1038">                                                lock.lock();</span>
<span class="nc" id="L1039">                                                sendToClient(&quot;MAP&quot;);</span>
<span class="nc" id="L1040">                                                sendForBoardSetup();</span>
<span class="nc" id="L1041">                                                lock.unlock();</span>
<span class="nc" id="L1042">                                                break;</span>
                                            case &quot;C&quot;:
<span class="nc" id="L1044">                                                lock.lock();</span>
<span class="nc" id="L1045">                                                sendToClient(&quot;SCORE&quot;);</span>
<span class="nc" id="L1046">                                                sendScoring();</span>
<span class="nc" id="L1047">                                                lock.unlock();</span>
<span class="nc" id="L1048">                                                break;</span>
                                            case &quot;B&quot;:
<span class="nc" id="L1050">                                                lock.lock();</span>
<span class="nc" id="L1051">                                                sendToClient(&quot;BOARDS&quot;);</span>
<span class="nc" id="L1052">                                                playerBoards();</span>
<span class="nc" id="L1053">                                                sendMarks();</span>
<span class="nc" id="L1054">                                                sendWeapons();</span>
<span class="nc" id="L1055">                                                sendPowerUps();</span>
<span class="nc" id="L1056">                                                sendAmmo();</span>
<span class="nc" id="L1057">                                                lock.unlock();</span>
<span class="nc" id="L1058">                                                break;</span>
                                            case &quot;S&quot;:
                                            default:
<span class="nc" id="L1061">                                                lock.lock();</span>
<span class="nc" id="L1062">                                                shootFrenzy();</span>
<span class="nc" id="L1063">                                                numberofActionsPlusOne();</span>
<span class="nc" id="L1064">                                                lock.unlock();</span>
                                                break;
                                        }

<span class="nc bnc" id="L1068" title="All 2 branches missed.">                                        if (numberOfActionsFrenzy == 2) {</span>
<span class="nc" id="L1069">                                            countdown.timer.cancel();</span>
<span class="nc" id="L1070">                                            counterOn = false;</span>
<span class="nc" id="L1071">                                            scoring();</span>
<span class="nc" id="L1072">                                            setNotDamaged();</span>
<span class="nc" id="L1073">                                            replaceAmmo();</span>
<span class="nc" id="L1074">                                            replaceWeapons();</span>

                                        }
<span class="nc" id="L1077">                                    } else { // FIRST PLAYER HAS PLAYED FRENZY</span>

<span class="nc bnc" id="L1079" title="All 2 branches missed.">                                        if (model.getPlayers().get(0).getName().equals(nickname)) {</span>
<span class="nc" id="L1080">                                            firstPlayerPlayedFrenzy();</span>
                                        }


<span class="nc" id="L1084">                                        lock.lock();</span>
<span class="nc" id="L1085">                                        sendToClient(&quot;FRENZY2&quot;);</span>
<span class="nc" id="L1086">                                        int z = (int) inputStream.readObject(); // RITORNA 1 O 2</span>
<span class="nc" id="L1087">                                        lock.unlock();</span>
<span class="nc bnc" id="L1088" title="All 2 branches missed.">                                        if (z == 1) {</span>

<span class="nc" id="L1090">                                            lock.lock();</span>
<span class="nc" id="L1091">                                            shootFrenzy2();</span>
<span class="nc" id="L1092">                                            lock.unlock();</span>

                                        } else {

<span class="nc" id="L1096">                                            lock.lock();</span>
<span class="nc" id="L1097">                                            grabFrenzy2();</span>
<span class="nc" id="L1098">                                            lock.unlock();</span>

                                        }

<span class="nc" id="L1102">                                        countdown.timer.cancel();</span>
<span class="nc" id="L1103">                                        counterOn = false;</span>
<span class="nc" id="L1104">                                        scoring();</span>
<span class="nc" id="L1105">                                        setNotDamaged();</span>
<span class="nc" id="L1106">                                        replaceAmmo();</span>
<span class="nc" id="L1107">                                        replaceWeapons();</span>


<span class="nc bnc" id="L1110" title="All 2 branches missed.">                                        if (model.getPlayers().get(model.getPlayers().size() - 1).getName().equals(nickname)) {</span>
<span class="nc" id="L1111">                                            sendFinalScoring();</span>
                                        }

                                    }
<span class="nc" id="L1115">                                } catch (Exception e) {</span>
                                    try {//e.printStackTrace();

<span class="nc" id="L1118">                                        countdown.timer.cancel();</span>
<span class="nc" id="L1119">                                        counterOn = false;</span>

<span class="nc bnc" id="L1121" title="All 2 branches missed.">                                        if (lock.isHeldByCurrentThread()) {</span>
<span class="nc bnc" id="L1122" title="All 2 branches missed.">                                            while (lock.getHoldCount() &gt; 0) {</span>
<span class="nc" id="L1123">                                                lock.unlock();</span>
                                            }
                                        }

<span class="nc" id="L1127">                                        Server.stopHandler(this);</span>
<span class="nc" id="L1128">                                        break;</span>
<span class="nc" id="L1129">                                    } catch (Exception ex) {</span>
<span class="nc" id="L1130">                                        System.out.println(&quot;Couldn't disconnect and pass turn.&quot;);</span>
                                    }
<span class="nc" id="L1132">                                }</span>
                            }
                        }
                    } // NOT CURRENT PLAYER
<span class="nc bnc" id="L1136" title="All 2 branches missed.">                    else if(hasBeenDamaged()){  //SET DAMAGED AND SHOOTER WHEN YOU SHOOT</span>
<span class="nc" id="L1137">                        tagbackGrenade();</span>
                    }else{
<span class="nc" id="L1139">                        flag=false;</span>
                    }
                    // !Server.action.endOfTheGame(model.getMapUsed().getGameBoard()))
                    // SET endgame parameter in this class
                }

                    //BROADCAST CLASSIFICA
                    //EXIT
                    //setEndgame(true);

            }
            //System.exit(0);
<span class="nc" id="L1151">        }</span>

        /**
         * This handles Grab if Frenzy on.
         */
        public void grabFrenzy(){

<span class="nc" id="L1158">                grab(true,false);</span>
<span class="nc" id="L1159">        }</span>

        /**
         * This handles Run if Frenzy on.
         */
        public void runFrenzy() {
            try {
<span class="nc" id="L1166">                Player p =model.getPlayers().get(currentPlayer);</span>
<span class="nc" id="L1167">                List&lt;CoordinatesWithRoom&gt; four = freneticAction.proposeCellsRunFrenzy(p.getCoordinatesWithRooms());</span>
<span class="nc" id="L1168">                sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L1169">                sendListToClient(fromCellsToNames(four)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L1170">                int x = (int) inputStream.readObject();</span>
<span class="nc" id="L1171">                x--;</span>
<span class="nc" id="L1172">                    p.setPlayerPosition(four.get(x));</span>
<span class="nc" id="L1173">            }catch (Exception e){</span>
<span class="nc" id="L1174">                e.printStackTrace();</span>
<span class="nc" id="L1175">            }</span>
<span class="nc" id="L1176">        }</span>

        /**
         * This handles Shoot if Frenzy on.
         */
        public void shootFrenzy(){
<span class="nc" id="L1182">            Player p = model.getPlayers().get(currentPlayer);</span>
            try {
<span class="nc" id="L1184">                List&lt;CoordinatesWithRoom&gt; one = p.getCoordinatesWithRooms().oneTileDistant(model.getMapUsed().getGameBoard(), false);</span>
<span class="nc bnc" id="L1185" title="All 2 branches missed.">                if (!one.isEmpty()) {</span>
<span class="nc" id="L1186">                    List&lt;String&gt; toSend = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L1187">                    toSend = fromCellsToNames(one);</span>
<span class="nc" id="L1188">                    toSend.add(0,&quot;No, I don't want to move&quot;);</span>

<span class="nc" id="L1190">                    sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L1191">                    sendListToClient(toSend); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L1192">                    int x = (int) inputStream.readObject();</span>
<span class="nc" id="L1193">                    x--;</span>
<span class="nc bnc" id="L1194" title="All 2 branches missed.">                    if(x!=0) {</span>
<span class="nc" id="L1195">                        x--;</span>
<span class="nc" id="L1196">                        p.setPlayerPosition(one.get(x));</span>
                    }
                }
<span class="nc" id="L1199">                reload();</span>

<span class="nc" id="L1201">                shoot();</span>

<span class="nc" id="L1203">            }catch (Exception e){</span>
<span class="nc" id="L1204">                e.printStackTrace();</span>
<span class="nc" id="L1205">            }</span>
<span class="nc" id="L1206">        }</span>

        /**
         * This handles the second option of Shoot if Frenzy on.
         */
        public void shootFrenzy2(){
<span class="nc" id="L1212">            Player p = model.getPlayers().get(currentPlayer);</span>
            try {
<span class="nc" id="L1214">                List&lt;CoordinatesWithRoom&gt; two = p.getCoordinatesWithRooms().oneTileDistant(model.getMapUsed().getGameBoard(), false);</span>
<span class="nc" id="L1215">                two.addAll(p.getCoordinatesWithRooms().xTilesDistant(model.getMapUsed().getGameBoard(),2));</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">                if (!two.isEmpty()) {</span>
<span class="nc" id="L1217">                    List&lt;String&gt; toSend = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L1218">                    toSend = fromCellsToNames(two);</span>
<span class="nc" id="L1219">                    toSend.add(0,&quot;No, I don't want to move&quot;);</span>

<span class="nc" id="L1221">                    sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L1222">                    sendListToClient(toSend); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L1223">                    int x = (int) inputStream.readObject();</span>
<span class="nc" id="L1224">                    x--;</span>
<span class="nc bnc" id="L1225" title="All 2 branches missed.">                    if(x!=0) {</span>
<span class="nc" id="L1226">                        x--;</span>
<span class="nc" id="L1227">                        p.setPlayerPosition(two.get(x));</span>
                    }
                }
<span class="nc" id="L1230">                reload();</span>

<span class="nc" id="L1232">                shoot();</span>

<span class="nc" id="L1234">            }catch (Exception e){</span>
<span class="nc" id="L1235">                e.printStackTrace();</span>
<span class="nc" id="L1236">            }</span>
<span class="nc" id="L1237">        }</span>

        /**
         * This handles the second option of Grab if Frenzy on.
         */
        public void grabFrenzy2(){
<span class="nc" id="L1243">                grab(true,true);</span>
<span class="nc" id="L1244">        }</span>


        /**
         * This sets all the players that have been damaged to non damaged.
         */
        public void setNotDamaged(){
<span class="nc bnc" id="L1251" title="All 2 branches missed.">            for (Player p : model.getPlayers()){</span>
<span class="nc" id="L1252">                p.setDamagedStatus(false);</span>
<span class="nc" id="L1253">                p.setShooter(null);</span>
<span class="nc" id="L1254">            }</span>
<span class="nc" id="L1255">        }</span>

        /**
         * This handles some exceptions. It disconnects from server.
         */
        public void handleException() {
<span class="nc" id="L1261">            lock.lock();</span>
<span class="nc" id="L1262">            sendToClient(&quot;DISCONNECTED&quot;);</span>
<span class="nc" id="L1263">            lock.unlock();</span>
<span class="nc" id="L1264">            disconnected.add(nickname);</span>
<span class="nc" id="L1265">            disconnectedColors.put(nickname, color);</span>
<span class="nc" id="L1266">            writers.remove(nickname,outputStream);</span>
<span class="nc" id="L1267">            writers2.remove(nickname,inputStream);</span>
<span class="nc" id="L1268">            System.out.println(&quot;Client Disconnected&quot;);</span>
            try {
<span class="nc" id="L1270">                socket.close();</span>
<span class="nc" id="L1271">            } catch (IOException e) {</span>
<span class="nc" id="L1272">                System.out.println(&quot;Couldn't close socket.&quot;);</span>
<span class="nc" id="L1273">            }</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">            if (nickname != null) {</span>
<span class="nc" id="L1275">                removeOneConnection();</span>
<span class="nc" id="L1276">                System.out.println(nickname + &quot; REMOVED ++++HERE -1&quot;);</span>
            }
<span class="nc bnc" id="L1278" title="All 2 branches missed.">            if(lock.isHeldByCurrentThread()) {</span>
<span class="nc bnc" id="L1279" title="All 2 branches missed.">                while (lock.getHoldCount() &gt; 0) {</span>
<span class="nc" id="L1280">                    lock.unlock();</span>
                }
            }

<span class="nc bnc" id="L1284" title="All 4 branches missed.">            if(connectionsCount&lt;3 &amp;&amp; isGameOn()){</span>
<span class="nc" id="L1285">                System.out.println(&quot;Sent Final Scoring&quot;);</span>
<span class="nc" id="L1286">                sendFinalScoring();</span>
            }
<span class="nc" id="L1288">        }</span>

        /**
         * This sends some info about the map.
         */
        public void sendForBoardSetup(){
<span class="nc" id="L1294">            sendToClient(Integer.toString(boardChosen));</span>
            try {
<span class="nc" id="L1296">                sendListToClient(colorsChosen);</span>
<span class="nc" id="L1297">                sendListToClient(names);</span>
<span class="nc" id="L1298">                sendSpawnpointWeaponsBlue();</span>
<span class="nc" id="L1299">                sendSpawnpointWeaponsRed();</span>
<span class="nc" id="L1300">                sendSpawnpointWeaponsYellow();</span>
<span class="nc" id="L1301">                sendAmmoTiles();</span>
<span class="nc" id="L1302">            } catch (IOException e) {</span>
<span class="nc" id="L1303">                System.out.println(&quot;Couldn't send info about game.&quot;);</span>
<span class="nc" id="L1304">            }</span>
<span class="nc" id="L1305">        }</span>

        /**
         * This sends the positions of the Players.
         */
        public void sendPositions(){
<span class="nc" id="L1311">            List&lt;String&gt; positions = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">            for(Player p : model.getPlayers()){</span>
<span class="nc bnc" id="L1313" title="All 2 branches missed.">                if(!Server.isFirstTurn()){</span>
<span class="nc" id="L1314">                    positions.add(p.getCoordinatesWithRooms().toString());</span>
                }else{
<span class="nc" id="L1316">                    positions.add(&quot;NOT YET DECIDED&quot;);</span>
                }
<span class="nc" id="L1318">            }</span>
            try {
<span class="nc" id="L1320">            sendListToClient(positions);</span>
<span class="nc" id="L1321">        }catch (Exception e){</span>
<span class="nc" id="L1322">            System.out.println(&quot;Couldn't send positions&quot;);</span>
<span class="nc" id="L1323">        }</span>
<span class="nc" id="L1324">        }</span>

        /**
         * This sends info about AmmoTile to the client.
         */
        public void sendAmmoTiles(){
<span class="nc" id="L1330">            List&lt;String&gt; listOfCells = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L1331">            List&lt;String&gt; listOfItems = new LinkedList&lt;&gt;();</span>
            // PER TUTTE LE CELLE DI TUTTE LE STANZE

<span class="nc bnc" id="L1334" title="All 2 branches missed.">            for(Room r : model.getMapUsed().getGameBoard().getRooms()){</span>
<span class="nc bnc" id="L1335" title="All 2 branches missed.">                for(int x =1; x&lt;=r.getRoomSizeX();x++){</span>
<span class="nc bnc" id="L1336" title="All 2 branches missed.">                    for(int y =1; y&lt;=r.getRoomSizeY();y++) {</span>
<span class="nc" id="L1337">                        CoordinatesWithRoom c = new CoordinatesWithRoom(x,y,r);</span>
<span class="nc" id="L1338">                        listOfCells.add(c.toString());</span>

<span class="nc bnc" id="L1340" title="All 2 branches missed.">                        if (c.isSpawnpointCoordinates(model)) {</span>
<span class="nc" id="L1341">                            listOfItems.add(&quot;Spawnpoint &quot;+c.getSpawnpoint(model).getColor().toString());</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">                        }else if(c.hasAmmoTile()){ // IT HAS AMMOTILES</span>
<span class="nc" id="L1343">                            listOfItems.add(c.getRoom().getAmmoTile(c).toString());</span>
                        }else { // IT DOESN'T HAVE AN AMMOTILE
<span class="nc" id="L1345">                            listOfItems.add(&quot;No tile&quot;);</span>
                        }
                    }
                }
<span class="nc" id="L1349">            }</span>
            try {
<span class="nc" id="L1351">                sendListToClient(listOfItems);</span>
<span class="nc" id="L1352">                sendListToClient(listOfCells);</span>

<span class="nc" id="L1354">                System.out.println(&quot;\nCells&amp;Items on map:&quot;);</span>
<span class="nc bnc" id="L1355" title="All 2 branches missed.">                for(int i =0;i&lt;listOfCells.size();i++){</span>
<span class="nc" id="L1356">                    System.out.println(listOfCells.get(i) + &quot; &quot;+listOfItems.get(i));</span>
                }

<span class="nc" id="L1359">            }catch (Exception e){</span>
<span class="nc" id="L1360">                System.out.println(&quot;Couldn't send tiles&quot;);</span>
<span class="nc" id="L1361">            }</span>
<span class="nc" id="L1362">        }</span>

        /**
         * This replaces the weapons at the end of the turn.
         */
        public void replaceWeapons(){
<span class="nc" id="L1368">            System.out.println(&quot;Replacing weapons...&quot;);</span>
<span class="nc" id="L1369">            int weaponNum =getSpawnpoint(AmmoCube.CubeColor.BLUE).getWeaponCards().size();</span>
<span class="nc bnc" id="L1370" title="All 2 branches missed.">            while (weaponNum&lt;3){</span>
<span class="nc" id="L1371">                getSpawnpoint(AmmoCube.CubeColor.BLUE).getWeaponCards().add(model.weaponDeck.pickUpWeapon());</span>
<span class="nc" id="L1372">                weaponNum++;</span>
            }
<span class="nc" id="L1374">            weaponNum =getSpawnpoint(AmmoCube.CubeColor.RED).getWeaponCards().size();</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">            while (weaponNum&lt;3){</span>
<span class="nc" id="L1376">                getSpawnpoint(AmmoCube.CubeColor.RED).getWeaponCards().add(model.weaponDeck.pickUpWeapon());</span>
<span class="nc" id="L1377">                weaponNum++;</span>
            }
<span class="nc" id="L1379">            weaponNum =getSpawnpoint(AmmoCube.CubeColor.YELLOW).getWeaponCards().size();</span>
<span class="nc bnc" id="L1380" title="All 2 branches missed.">            while (weaponNum&lt;3){</span>
<span class="nc" id="L1381">                getSpawnpoint(AmmoCube.CubeColor.YELLOW).getWeaponCards().add(model.weaponDeck.pickUpWeapon());</span>
<span class="nc" id="L1382">                weaponNum++;</span>
            }
<span class="nc" id="L1384">        }</span>

        /**
         * This replaces grabbed AmmoTiles
         */
        public void replaceAmmo(){
<span class="nc" id="L1390">            System.out.println(&quot;Replacing ammo...&quot;);</span>
<span class="nc bnc" id="L1391" title="All 2 branches missed.">            for(CoordinatesWithRoom c : cellsWithoutTiles){</span>
<span class="nc" id="L1392">                c.getRoom().addAmmoTile(model.ammoTileDeck.pickUpAmmoTile(),c.getX(),c.getY());</span>
<span class="nc" id="L1393">            }</span>
<span class="nc" id="L1394">            cellsWithoutTiles.clear();</span>
<span class="nc" id="L1395">        }</span>


        /**
         * This method send Respawn request to the players that have died during the current player's turn.
         * @param p victim
         */
        public synchronized void respawn(Player p){
<span class="nc" id="L1403">            p.getPowerUp().add(model.powerUpDeck.pickPowerUp());</span>
<span class="nc" id="L1404">            List&lt;String&gt; toSend = fromPowerupsToNames(p.getPowerUp());</span>
<span class="nc" id="L1405">            try {lock.lock();</span>

<span class="nc" id="L1407">                            outputStream.writeObject(&quot;RESPAWN&quot;);</span>
<span class="nc" id="L1408">                            outputStream.flush();</span>

<span class="nc" id="L1410">                            outputStream.writeObject(toSend);</span>
<span class="nc" id="L1411">                            outputStream.flush();</span>

<span class="nc" id="L1413">                                    int x = (int) inputStream.readObject();</span>
<span class="nc" id="L1414">                                    x--;</span>

<span class="nc" id="L1416">                                lock.unlock();</span>
<span class="nc" id="L1417">                                PowerUpCard po = p.getPowerUp().remove(x);</span>
<span class="nc" id="L1418">                                System.out.println(&quot;TO USE AS POSITION &quot; + po.toString());</span>

<span class="nc" id="L1420">                                p.newLife();</span>
<span class="nc" id="L1421">                                setInitialPosition(po.getPowerUpColor(), p);</span>
<span class="nc" id="L1422">            }catch (Exception e){</span>
<span class="nc" id="L1423">                handleException();</span>
<span class="nc" id="L1424">            }</span>
<span class="nc" id="L1425">        }</span>

        /**
         * This handles the first turn, the choice of Respawn position.
         */
        public synchronized void firstTurn(){
<span class="nc" id="L1431">            synchronized (model.getPlayers().get(currentPlayer)) {</span>
<span class="nc" id="L1432">                lock.lock();</span>
<span class="nc" id="L1433">                LinkedList&lt;PowerUpCard&gt; twoCards = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L1434">                twoCards.add(model.powerUpDeck.pickPowerUp());</span>
<span class="nc" id="L1435">                twoCards.add(model.powerUpDeck.pickPowerUp());</span>
<span class="nc" id="L1436">                List&lt;String&gt; cards = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L1437">                cards.add(0, twoCards.get(0).toString());</span>
<span class="nc" id="L1438">                cards.add(1, twoCards.get(1).toString());</span>
<span class="nc" id="L1439">                Player player = model.getPlayers().get(currentPlayer);</span>
                try {
<span class="nc" id="L1441">                    sendListToClient(cards);</span>
<span class="nc" id="L1442">                    int x = (int) inputStream.readObject();</span>
<span class="nc" id="L1443">                    x--;</span>
                    // CHIEDI QUALE CARTA DA TENERE (1 o 2) E QUALE DA USARE COME RESPAWN


<span class="nc" id="L1447">                    PowerUpCard p = twoCards.removeFirst();</span>
                    //System.out.println(&quot;TO KEEP &quot;+p.toString());
<span class="nc bnc" id="L1449" title="All 2 branches missed.">                    if (x == 1) {</span>
<span class="nc" id="L1450">                        model.getPlayers().get(currentPlayer).getPowerUp().add(p);</span>

<span class="nc" id="L1452">                        p = twoCards.removeFirst();</span>
                        //System.out.println(&quot;TO USE AS POSITION &quot;+p.toString());

<span class="nc" id="L1455">                        setInitialPosition(p.getPowerUpColor(), model.getPlayers().get(currentPlayer));</span>
                    } else {
<span class="nc" id="L1457">                        setInitialPosition(p.getPowerUpColor(), model.getPlayers().get(currentPlayer));</span>

<span class="nc" id="L1459">                        p = twoCards.removeFirst();</span>
                        //System.out.println(&quot;TO USE AS POSITION &quot;+p.toString());

<span class="nc" id="L1462">                        model.getPlayers().get(currentPlayer).getPowerUp().add(p);</span>
                    }

<span class="nc" id="L1465">                } catch (Exception e) {</span>
<span class="nc" id="L1466">                    System.out.println(&quot;Couldn't do firstTurn. Default.&quot;);</span>

<span class="nc" id="L1468">                    player.getPowerUp().add(twoCards.get(0));</span>
<span class="nc" id="L1469">                    setInitialPosition(twoCards.get(1).getPowerUpColor(), player);</span>
<span class="nc" id="L1470">                    broadcast(&quot;\n&quot; + player.getName() + &quot; is in &quot; + player.getCoordinatesWithRooms().toString());</span>
<span class="nc" id="L1471">                }</span>
<span class="nc" id="L1472">                lock.unlock();</span>
<span class="nc" id="L1473">            }</span>
<span class="nc" id="L1474">        }</span>

        /**
         * Updates index of next Player.
         * If everybody has played, it resets.
         */
        public void nextPlayer(){
<span class="nc" id="L1481">            try {                System.out.println(&quot;------CHANGING PLAYER&quot;);</span>
<span class="nc bnc" id="L1482" title="All 2 branches missed.">                if (currentPlayer != model.getPlayers().size() - 1) {</span>
<span class="nc" id="L1483">                    currentPlayer++;</span>
                } else {
<span class="nc" id="L1485">                    currentPlayer = 0;</span>
                }
<span class="nc bnc" id="L1487" title="All 2 branches missed.">                if (disconnected.contains(model.getPlayers().get(currentPlayer).getName())) {</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">                    if (currentPlayer != model.getPlayers().size() - 1) {</span>
<span class="nc" id="L1489">                        currentPlayer++;</span>
                    } else {
<span class="nc" id="L1491">                        currentPlayer = 0;</span>
                    }
<span class="nc bnc" id="L1493" title="All 2 branches missed.">                    if (disconnected.contains(model.getPlayers().get(currentPlayer).getName())) {</span>
<span class="nc bnc" id="L1494" title="All 2 branches missed.">                        if (currentPlayer != model.getPlayers().size() - 1) {</span>
<span class="nc" id="L1495">                            currentPlayer++;</span>
                        } else {
<span class="nc" id="L1497">                            currentPlayer = 0;</span>
                        }
<span class="nc bnc" id="L1499" title="All 2 branches missed.">                        if (disconnected.contains(model.getPlayers().get(currentPlayer).getName())) {</span>
<span class="nc bnc" id="L1500" title="All 2 branches missed.">                            if (currentPlayer != model.getPlayers().size() - 1) {</span>
<span class="nc" id="L1501">                                currentPlayer++;</span>
                            } else {
<span class="nc" id="L1503">                                currentPlayer = 0;</span>
                            }
                        }
                    }
                }
<span class="nc" id="L1508">                System.out.println(&quot;-----NEXT PLAYER IS NUMBER &quot;+currentPlayer);</span>
<span class="nc" id="L1509">            System.out.println(currentPlayer);}catch (Exception e){</span>
<span class="nc bnc" id="L1510" title="All 2 branches missed.">                 while (lock.getHoldCount() &gt; 0) {</span>
<span class="nc" id="L1511">                                                            lock.unlock();</span>
                                                        }
<span class="nc" id="L1513">            }</span>
<span class="nc" id="L1514">        }</span>

        /**
         * This sets the initial position of a Player.
         *
         * @param c position
         * @param p player
         */
        public synchronized void setInitialPosition(AmmoCube.CubeColor c, Player p){
<span class="nc bnc" id="L1523" title="All 2 branches missed.">            for (Room r: model.getMapUsed().getGameBoard().getRooms()){</span>
<span class="nc bnc" id="L1524" title="All 2 branches missed.">                for (Spawnpoint s:r.getSpawnpoints()</span>
                     ) {
<span class="nc bnc" id="L1526" title="All 2 branches missed.">                    if(s.getColor().equals(c))</span>
                    {
<span class="nc" id="L1528">                        p.setPlayerPosition(s.getSpawnpointX(),s.getSpawnpointY(),r);</span>
<span class="nc" id="L1529">                        p.setPlayerPositionSpawnpoint(p.getCoordinatesWithRooms());</span>
<span class="nc" id="L1530">                        broadcast(&quot;\n&quot; + p.getName() + &quot; is in &quot;+p.getCoordinatesWithRooms().toString());</span>
<span class="nc" id="L1531">                        System.out.println(&quot;INITIAL POSITION OF &quot;+p.getName()+&quot; IS  &quot;+p.getCoordinatesWithRooms().toString());</span>
<span class="nc" id="L1532">                        return;</span>
                    }
<span class="nc" id="L1534">                }</span>

<span class="nc" id="L1536">            }</span>
<span class="nc" id="L1537">        }</span>

        /**
         * This handles the scoring at the end of the turn.
         */
        public void scoring(){
<span class="nc" id="L1543">            List&lt;Player&gt; victims = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1544" title="All 2 branches missed.">            for(Player p : model.getPlayers()){</span>
<span class="nc bnc" id="L1545" title="All 2 branches missed.">                if(p.isDead()){</span>
<span class="nc" id="L1546">                    victims.add(p);</span>
                }
<span class="nc" id="L1548">            }</span>
<span class="nc" id="L1549">            action.canGetPoints(victims,model.getPlayers());</span>

<span class="nc" id="L1551">            System.out.println(&quot;Scoring&quot;);</span>
<span class="nc bnc" id="L1552" title="All 2 branches missed.">            for(Player p : model.getPlayers()){</span>
<span class="nc" id="L1553">                System.out.println(p.getPoints() + &quot; points of &quot;+ p.getName());</span>
<span class="nc" id="L1554">            }</span>

<span class="nc bnc" id="L1556" title="All 2 branches missed.">            if(!victims.isEmpty()) {</span>
<span class="nc" id="L1557">                setRespawning(true);</span>
<span class="nc" id="L1558">                nextPlayer();</span>
<span class="nc bnc" id="L1559" title="All 2 branches missed.">                while (!isCurrentPlayer()) {</span>

                }
<span class="nc" id="L1562">                lock.lock();</span>
<span class="nc" id="L1563">                setRespawning(false);</span>
<span class="nc" id="L1564">                nextPlayer();</span>
<span class="nc" id="L1565">                lock.unlock();</span>
            }
            // ENDGAME
<span class="nc bnc" id="L1568" title="All 2 branches missed.">            if (action.endOfTheGame(model.getMapUsed().getGameBoard())){</span>

<span class="nc" id="L1570">                ending();</span>
            }

<span class="nc" id="L1573">        }</span>

        /**
         * This sends the scoring to the client.
         */
        public void sendScoring(){
            try {
<span class="nc" id="L1580">                List&lt;String&gt; list = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1581" title="All 2 branches missed.">                for(Player p : model.getPlayers()){</span>
<span class="nc" id="L1582">                    list.add(p.toString());</span>
<span class="nc" id="L1583">                    list.add(Integer.toString(p.getPoints()));</span>
<span class="nc" id="L1584">                }</span>
<span class="nc" id="L1585">                sendListToClient(list);</span>
<span class="nc" id="L1586">            }catch (Exception e){</span>
<span class="nc" id="L1587">                System.out.println(&quot;Couldn't send score.&quot;);</span>
<span class="nc" id="L1588">            }</span>
<span class="nc" id="L1589">        }</span>


        /**
         * This sends the final scoring at the end of the game.
         */
        public void sendFinalScoring(){
<span class="nc" id="L1596">            lock.lock();</span>
<span class="nc" id="L1597">            action.canGetPoints(model.getPlayers(),model.getPlayers());</span>
<span class="nc" id="L1598">            action.finalScoring();</span>
<span class="nc" id="L1599">            lock.lock();</span>
<span class="nc" id="L1600">            sendToClient(&quot;ENDGAME&quot;);</span>

<span class="nc" id="L1602">            List&lt;String&gt; finalList = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1603" title="All 2 branches missed.">            for(Player p : model.getPlayers()){</span>
<span class="nc" id="L1604">                finalList.add(p.getPlayerPos().toString());</span>
<span class="nc" id="L1605">                finalList.add(p.getName());</span>
<span class="nc" id="L1606">                finalList.add(Integer.toString(p.getPoints()));</span>
<span class="nc" id="L1607">            }</span>

<span class="nc bnc" id="L1609" title="All 2 branches missed.">            for (Map.Entry me : writers.entrySet()) {</span>
                try {
<span class="nc" id="L1611">                    ((ObjectOutputStream)me.getValue()).writeObject(&quot;ENDGAME&quot;);</span>
<span class="nc" id="L1612">                    ((ObjectOutputStream)me.getValue()).flush();</span>

<span class="nc" id="L1614">                    ((ObjectOutputStream)me.getValue()).writeObject(finalList);</span>
<span class="nc" id="L1615">                    ((ObjectOutputStream)me.getValue()).flush();</span>

<span class="nc" id="L1617">                } catch (IOException e) {</span>
                    // DON'T CARE ITS ENDGAME
<span class="nc" id="L1619">                }</span>
<span class="nc" id="L1620">            }</span>
<span class="nc" id="L1621">            lock.unlock();</span>
<span class="nc" id="L1622">            lock.unlock();</span>
<span class="nc" id="L1623">        }</span>


        /**
         * This method handles the request and actions of reloading at the end of the turn.
         */
        public void reload(){
<span class="nc" id="L1630">            System.out.println(&quot;Current player reload &quot;+ model.getPlayers().get(currentPlayer).getName());</span>
<span class="nc" id="L1631">            Player player = model.getPlayers().get(currentPlayer);</span>
            try{
<span class="nc" id="L1633">                lock.lock();</span>
<span class="nc" id="L1634">                List&lt;WeaponCard&gt; weapons = new LinkedList&lt;&gt;(player.getHand());</span>
<span class="nc bnc" id="L1635" title="All 2 branches missed.">                for (WeaponCard w : player.getHand()){</span>
<span class="nc bnc" id="L1636" title="All 2 branches missed.">                    if(w.getReload()){</span>
<span class="nc" id="L1637">                        weapons.remove(w);</span>
                    }else{
<span class="nc" id="L1639">                        System.out.println(w.toString()+&quot; &quot;+w.getReload());</span>
                    }
<span class="nc" id="L1641">                }</span>
<span class="nc bnc" id="L1642" title="All 2 branches missed.">                if(!weapons.isEmpty()) {</span>
<span class="nc bnc" id="L1643" title="All 2 branches missed.">                    for (WeaponCard w : weapons) {</span>
<span class="nc" id="L1644">                        sendToClient(&quot;RELOAD&quot;);</span>
<span class="nc" id="L1645">                        sendToClient(w.toString());</span>
<span class="nc" id="L1646">                        String response = (String) inputStream.readObject();</span>

<span class="nc bnc" id="L1648" title="All 2 branches missed.">                        if (response.toUpperCase().equals(&quot;Y&quot;)) {</span>
<span class="nc" id="L1649">                            LinkedList&lt;PowerUpCard&gt; playerPowerUpCards = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L1650">                            sendToClient(&quot;PAYMENT&quot;);</span>
<span class="nc" id="L1651">                            int z = (int) inputStream.readObject();</span>

                            Action.PayOption payOption;

<span class="nc bnc" id="L1655" title="All 2 branches missed.">                            if (z == 1) {</span>
<span class="nc" id="L1656">                                payOption = Action.PayOption.AMMO;</span>
                            } else {
<span class="nc" id="L1658">                                payOption = Action.PayOption.AMMOPOWER;</span>
                            }

<span class="nc bnc" id="L1661" title="All 2 branches missed.">                            if (payOption.equals(Action.PayOption.AMMOPOWER)) {</span>
<span class="nc" id="L1662">                                playerPowerUpCards = payWithThesePowerUps(player);</span>
                            }
<span class="nc bnc" id="L1664" title="All 2 branches missed.">                            if (!action.canPayGrab(w, player,playerPowerUpCards)) {</span>
                                //MANDA MESSAGGIO
<span class="nc" id="L1666">                                System.out.println(&quot;CAN'T PAY&quot;);</span>
                            }
<span class="nc bnc" id="L1668" title="All 4 branches missed.">                            if (z == 1 &amp;&amp; action.canPayCard(w, player,payOption, AmmoCube.Effect.BASE,playerPowerUpCards)) {</span>
<span class="nc" id="L1669">                                    action.payAmmo(player, w, AmmoCube.Effect.BASE, 0);</span>
<span class="nc" id="L1670">                                    w.setReload();</span>
<span class="nc bnc" id="L1671" title="All 4 branches missed.">                                } else if(z!=1&amp;&amp;action.canPayCard(w, player,payOption, AmmoCube.Effect.BASE,playerPowerUpCards) ) {</span>
<span class="nc" id="L1672">                                    action.payPowerUp(w, playerPowerUpCards, player, AmmoCube.Effect.BASE, 0);</span>
<span class="nc" id="L1673">                                    player.getPowerUp().removeAll(playerPowerUpCards);</span>
<span class="nc" id="L1674">                                    model.powerUpDeck.getUsedPowerUp().addAll(playerPowerUpCards);</span>
<span class="nc" id="L1675">                                    playerPowerUpCards.clear();</span>
<span class="nc" id="L1676">                                    w.setReload();</span>

                            }
                        }
<span class="nc" id="L1680">                    }</span>
                }
<span class="nc" id="L1682">                lock.unlock();</span>
<span class="nc" id="L1683">            } catch (Exception e){</span>
<span class="nc" id="L1684">                e.printStackTrace();</span>
<span class="nc" id="L1685">                System.out.println(&quot;Couldn't reload.&quot;);</span>
<span class="nc" id="L1686">            }</span>

<span class="nc" id="L1688">        }</span>

        /**
         * This handles the use of two powerup in between actions during a turn.
         */
        public void powerup(){
<span class="nc" id="L1694">            Player player = model.getPlayers().get(currentPlayer);</span>
<span class="nc bnc" id="L1695" title="All 2 branches missed.">            if(!player.getPowerUp().isEmpty()){</span>
<span class="nc" id="L1696">                List&lt;PowerUpCard&gt; pows = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1697" title="All 2 branches missed.">                for(PowerUpCard p : player.getPowerUp()){</span>
<span class="nc bnc" id="L1698" title="All 4 branches missed.">                    if(p.toString().equals(&quot;Teleporter, BLUE&quot;) || p.toString().equals(&quot;Teleporter, RED&quot;) ||</span>
<span class="nc bnc" id="L1699" title="All 4 branches missed.">                            p.toString().equals(&quot;Teleporter, YELLOW&quot;) ||p.toString().equals(&quot;Newton, BLUE&quot;) ||</span>
<span class="nc bnc" id="L1700" title="All 4 branches missed.">                            p.toString().equals(&quot;Newton, RED&quot;) ||p.toString().equals(&quot;Newton, YELLOW&quot;)){</span>
<span class="nc" id="L1701">                        pows.add(p);</span>
                    }
<span class="nc" id="L1703">                }lock.lock();</span>
<span class="nc bnc" id="L1704" title="All 2 branches missed.">                if(pows.isEmpty()){</span>
<span class="nc" id="L1705">                    sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L1706">                    sendToClient(&quot;Sorry you can't use any of your powerups now&quot;);</span>
                }else{
<span class="nc" id="L1708">                    sendToClient(&quot;POWERUP&quot;);</span>
                    try {
<span class="nc" id="L1710">                        List&lt;String&gt; toSend = fromPowerupsToNames(pows);</span>
<span class="nc" id="L1711">                        toSend.add(0, &quot;No, I dont't want to use powerups&quot;);</span>
<span class="nc" id="L1712">                        sendListToClient(toSend);</span>
<span class="nc" id="L1713">                        int x = (int)inputStream.readObject();</span>
<span class="nc" id="L1714">                        x--;</span>
<span class="nc bnc" id="L1715" title="All 2 branches missed.">                        if(x!=0) {</span>
<span class="nc" id="L1716">                            x--;</span>
<span class="nc bnc" id="L1717" title="All 2 branches missed.">                            if (pows.get(x) instanceof Teleporter) {</span>
<span class="nc" id="L1718">                                teleporter();</span>
                            }
<span class="nc bnc" id="L1720" title="All 2 branches missed.">                            if (pows.get(x) instanceof Newton) {</span>
<span class="nc" id="L1721">                                newton();</span>
                            }
                        }
<span class="nc" id="L1724">                    } catch (Exception e) {</span>
<span class="nc" id="L1725">                        System.out.println(&quot;Couldn't do powerup.&quot;);</span>
<span class="nc" id="L1726">                    }</span>
<span class="nc" id="L1727">                }lock.unlock();</span>
            }
<span class="nc" id="L1729">        }</span>

        /**
         * This handles the teleporter powerup.
         */
        public void teleporter(){
            try {
<span class="nc" id="L1736">                Player player = model.getPlayers().get(currentPlayer);</span>
<span class="nc" id="L1737">                List&lt;CoordinatesWithRoom&gt; possible = player.getTeleporter().getPossibleCells(model,player);</span>
<span class="nc" id="L1738">                lock.lock();</span>
<span class="nc" id="L1739">                sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L1740">                sendListToClient(fromCellsToNames(possible)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L1741">                int x = (int)inputStream.readObject();</span>
<span class="nc" id="L1742">                x--;</span>
<span class="nc" id="L1743">                lock.unlock();</span>
<span class="nc" id="L1744">                player.setPlayerPosition(possible.get(x));</span>
<span class="nc" id="L1745">                broadcast(&quot;\n&quot; + player.getName() + &quot; teleported in &quot;+possible.get(x).toString());</span>

<span class="nc" id="L1747">                PowerUpCard power = player.getTeleporter();</span>
<span class="nc" id="L1748">                player.getPowerUp().remove(power);</span>
<span class="nc" id="L1749">                model.powerUpDeck.usedPowerUp.add(power);</span>

<span class="nc" id="L1751">            } catch (Exception e) {</span>
<span class="nc" id="L1752">                System.out.println(&quot;Couldn't use Teleporter.&quot;);</span>
<span class="nc" id="L1753">            }</span>
<span class="nc" id="L1754">        }</span>
        /**
         * This handles the newton powerup.
         */
        public void newton(){
            try {
<span class="nc" id="L1760">                Player player = model.getPlayers().get(currentPlayer);</span>
<span class="nc" id="L1761">                List&lt;Object&gt; targets = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L1762">                targets.addAll(model.getPlayers());</span>
<span class="nc" id="L1763">                targets.remove(player);</span>

                // ASK WHICH 1 TARGET TO MOVE
<span class="nc" id="L1766">                lock.lock();</span>
<span class="nc" id="L1767">                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L1768">                sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L1769">                int xh = (int)inputStream.readObject();</span>
<span class="nc" id="L1770">                xh--;</span>
<span class="nc" id="L1771">                lock.unlock();</span>
<span class="nc" id="L1772">                Object tt = targets.get(xh);</span>
<span class="nc" id="L1773">                targets.clear();</span>
<span class="nc" id="L1774">                targets.add(tt);</span>
<span class="nc" id="L1775">                CoordinatesWithRoom c = ((Player)targets.get(0)).getCoordinatesWithRooms();</span>
<span class="nc" id="L1776">                List&lt;CoordinatesWithRoom&gt; cells =c.tilesSameDirection(2,model.getMapUsed().getGameBoard(),false);</span>
<span class="nc" id="L1777">                lock.lock();</span>
<span class="nc" id="L1778">                sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L1779">                sendListToClient(fromCellsToNames(cells)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L1780">                int x = (int)inputStream.readObject();</span>
<span class="nc" id="L1781">                x--;</span>
<span class="nc" id="L1782">                lock.unlock();</span>
<span class="nc" id="L1783">                ((Player)targets.get(0)).setPlayerPosition(cells.get(x));</span>
<span class="nc" id="L1784">                broadcast(&quot;\n&quot; + ((Player) targets.get(0)).getName() + &quot; moved to &quot;+cells.get(x).toString());</span>

<span class="nc" id="L1786">                PowerUpCard power = player.getNewton();</span>
<span class="nc" id="L1787">                player.getPowerUp().remove(power);</span>
<span class="nc" id="L1788">                model.powerUpDeck.usedPowerUp.add(power);</span>

<span class="nc" id="L1790">            } catch (Exception e) {</span>
<span class="nc" id="L1791">                System.out.println(&quot;Couldn't use Newton.&quot;);;</span>
<span class="nc" id="L1792">            }</span>
<span class="nc" id="L1793">        }</span>

        /**
         * This gets a Spawnpoint out of a CubeColor. Just Spawnpoints in BLUE, RED, YELLOW rooms.
         * Just one spawnpoint per room. Just three Spawnpoints on board.
         * @param c color
         * @return Spawnpoint
         */
        public Spawnpoint getSpawnpoint(AmmoCube.CubeColor c) {
<span class="nc bnc" id="L1802" title="All 2 branches missed.">            for (Room r : model.getMapUsed().getGameBoard().getRooms()) {</span>
<span class="nc bnc" id="L1803" title="All 4 branches missed.">                if (!r.getSpawnpoints().isEmpty() &amp;&amp; r.getSpawnpoints().get(0).getColor().equals(c)) {</span>
<span class="nc" id="L1804">                    return r.getSpawnpoints().get(0);</span>
                }
<span class="nc" id="L1806">            }</span>
<span class="nc" id="L1807">            return new Spawnpoint();</span>
        }

        /**
         * This gets the coordinates of a spawnpoint.
         * @param s the spawnpoint
         * @return the coordinates
         */
        public CoordinatesWithRoom getSpawnpointCoordinates(Spawnpoint s) {
<span class="nc bnc" id="L1816" title="All 2 branches missed.">            for (Room r : model.getMapUsed().getGameBoard().getRooms()) {</span>
<span class="nc bnc" id="L1817" title="All 4 branches missed.">                if (!r.getSpawnpoints().isEmpty() &amp;&amp; r.getSpawnpoints().get(0).equals(s)) {</span>
<span class="nc" id="L1818">                    return new CoordinatesWithRoom(s.getSpawnpointX(),s.getSpawnpointY(),r);</span>
                }
<span class="nc" id="L1820">            }</span>
<span class="nc" id="L1821">            return new CoordinatesWithRoom();</span>
        }

        /**
         * This sends info about weapons in spawnpoint BLUE.
         */
        public void sendSpawnpointWeaponsBlue(){
            try {
<span class="nc" id="L1829">                List&lt;String&gt; weapons = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1830" title="All 2 branches missed.">                for(WeaponCard w : getSpawnpoint(AmmoCube.CubeColor.BLUE).getWeaponCards()){</span>
<span class="nc" id="L1831">                    weapons.add(w.toString());</span>
<span class="nc" id="L1832">                }</span>

<span class="nc" id="L1834">                sendListToClient(weapons);</span>
<span class="nc" id="L1835">            } catch (IOException e) {</span>
<span class="nc" id="L1836">                System.out.println(&quot;Couldn't send BLUE weapons.&quot;);</span>
<span class="nc" id="L1837">            }</span>
<span class="nc" id="L1838">        }</span>
        /**
         * This sends info about weapons in spawnpoint RED.
         */
        public void sendSpawnpointWeaponsRed(){
            try {
<span class="nc" id="L1844">                List&lt;String&gt; weapons = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1845" title="All 2 branches missed.">                for(WeaponCard w : getSpawnpoint(AmmoCube.CubeColor.RED).getWeaponCards()){</span>
<span class="nc" id="L1846">                    weapons.add(w.toString());</span>
<span class="nc" id="L1847">                }</span>

<span class="nc" id="L1849">                sendListToClient(weapons);</span>
<span class="nc" id="L1850">            } catch (IOException e) {</span>
<span class="nc" id="L1851">                System.out.println(&quot;Couldn't send RED weapons.&quot;);</span>
<span class="nc" id="L1852">            }</span>
<span class="nc" id="L1853">        }</span>
        /**
         * This sends info about weapons in spawnpoint YELLOW.
         */
        public void sendSpawnpointWeaponsYellow(){
            try {

<span class="nc" id="L1860">                List&lt;String&gt; weapons = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1861" title="All 2 branches missed.">                for(WeaponCard w : getSpawnpoint(AmmoCube.CubeColor.YELLOW).getWeaponCards()){</span>
<span class="nc" id="L1862">                    weapons.add(w.toString());</span>
<span class="nc" id="L1863">                }</span>
<span class="nc" id="L1864">                sendListToClient(weapons);</span>
<span class="nc" id="L1865">            } catch (IOException e) {</span>
<span class="nc" id="L1866">                System.out.println(&quot;Couldn't send YELLOW weapons.&quot;);</span>
<span class="nc" id="L1867">            }</span>
<span class="nc" id="L1868">        }</span>

        /**
         * This sends info about player boards.
         */
        public void playerBoards(){
            try {
<span class="nc" id="L1875">                List&lt;String&gt; list = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L1876">                sendListToClient(fromPlayersToNames(model.getPlayers()));</span>
<span class="nc bnc" id="L1877" title="All 2 branches missed.">                for(Player p : model.getPlayers()){</span>
<span class="nc bnc" id="L1878" title="All 2 branches missed.">                    for(Figure.PlayerColor c : p.getTrack()){</span>
<span class="nc" id="L1879">                        list.add(c.toString());</span>
                    }
<span class="nc" id="L1881">                }</span>
<span class="nc" id="L1882">                sendListToClient(list);</span>
<span class="nc" id="L1883">            }catch (Exception e){</span>
<span class="nc" id="L1884">                System.out.println(&quot;Couldn't send player boards.&quot;);</span>
<span class="nc" id="L1885">            }</span>
<span class="nc" id="L1886">        }</span>

        /**
         * This sends info about marks.
         */
        public void sendMarks(){
            try {
<span class="nc" id="L1893">                List&lt;String&gt; list = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1894" title="All 2 branches missed.">                for(Player p : model.getPlayers()){</span>
<span class="nc" id="L1895">                    synchronized (p.getMarks()) {</span>
<span class="nc bnc" id="L1896" title="All 2 branches missed.">                        for (int i = 0; i &lt; 12; i++) {</span>
<span class="nc" id="L1897">                                list.add(p.getMarks()[i].toString());</span>
                        }
<span class="nc" id="L1899">                    }</span>
<span class="nc" id="L1900">                }</span>
<span class="nc" id="L1901">                sendListToClient(list);</span>
<span class="nc" id="L1902">            }catch (Exception e){</span>
<span class="nc" id="L1903">                System.out.println(&quot;Couldn't send marks.&quot;);</span>
<span class="nc" id="L1904">            }</span>
<span class="nc" id="L1905">        }</span>

        /**
         * This sends info about weapons.
         */
        public void sendWeapons(){
            try {
<span class="nc" id="L1912">                List&lt;String&gt; list = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1913" title="All 2 branches missed.">                for(Player p : model.getPlayers()){</span>
<span class="nc" id="L1914">                    synchronized (p.getHand()) {</span>
<span class="nc bnc" id="L1915" title="All 2 branches missed.">                        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc bnc" id="L1916" title="All 2 branches missed.">                            if (p.getHand().size() &gt; i) {</span>
<span class="nc" id="L1917">                                list.add(p.getHand().get(i).toString());</span>
<span class="nc" id="L1918">                                list.add(Boolean.toString(p.getHand().get(i).getReload()));</span>
                            } else {
<span class="nc" id="L1920">                                list.add(&quot;[   ]&quot;);</span>
<span class="nc" id="L1921">                                list.add(&quot;[   ]&quot;);</span>
                            }
                        }
<span class="nc" id="L1924">                    }</span>
<span class="nc" id="L1925">                }</span>
<span class="nc" id="L1926">                sendListToClient(list);</span>
<span class="nc" id="L1927">            }catch (Exception e){</span>
<span class="nc" id="L1928">                System.out.println(&quot;Couldn't send hand weapons.&quot;);</span>
<span class="nc" id="L1929">            }</span>
<span class="nc" id="L1930">        }</span>

        /**
         * This sends info about powerups.
         */
        public void sendPowerUps(){
            try {
<span class="nc" id="L1937">                List&lt;String&gt; list = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1938" title="All 2 branches missed.">                for(Player p : model.getPlayers()){</span>
<span class="nc" id="L1939">                    synchronized (p.getPowerUp()) {</span>
<span class="nc bnc" id="L1940" title="All 2 branches missed.">                        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc bnc" id="L1941" title="All 2 branches missed.">                            if (p.getPowerUp().size() &gt; i) {</span>
<span class="nc" id="L1942">                                list.add(p.getPowerUp().get(i).toString());</span>
                            } else {
<span class="nc" id="L1944">                                list.add(&quot;[   ]&quot;);</span>
                            }
                        }
<span class="nc" id="L1947">                    }</span>
<span class="nc" id="L1948">                }</span>
<span class="nc" id="L1949">                sendListToClient(list);</span>
<span class="nc" id="L1950">            }catch (Exception e){</span>
<span class="nc" id="L1951">                System.out.println(&quot;Couldn't send hand weapons.&quot;);</span>
<span class="nc" id="L1952">            }</span>
<span class="nc" id="L1953">        }</span>

        /**
         * This sends info about player ammo.
         */
        public void sendAmmo(){
            try {
<span class="nc" id="L1960">                List&lt;String&gt; list = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1961" title="All 2 branches missed.">                for(Player p : model.getPlayers()){</span>
<span class="nc" id="L1962">                    list.add(Integer.toString(p.getCubeBlue()));</span>
<span class="nc" id="L1963">                    list.add(Integer.toString(p.getCubeRed()));</span>
<span class="nc" id="L1964">                    list.add(Integer.toString(p.getCubeYellow()));</span>
<span class="nc" id="L1965">                }</span>
<span class="nc" id="L1966">                sendListToClient(list);</span>
<span class="nc" id="L1967">            }catch (Exception e){</span>
<span class="nc" id="L1968">                System.out.println(&quot;Couldn't send ammo.&quot;);</span>
<span class="nc" id="L1969">            }</span>
<span class="nc" id="L1970">        }</span>

        /**
         * This handles Run action.
         */
        public void playerRun(){
<span class="nc" id="L1976">            System.out.println(&quot;RUN&quot;);</span>
//            System.out.println(&quot;PREVIOUS POSITION &quot;+model.getPlayers().get(currentPlayer).getCoordinatesWithRooms().toString());

<span class="nc" id="L1979">            Player player = model.getPlayers().get(currentPlayer);</span>
<span class="nc" id="L1980">            LinkedList&lt;CoordinatesWithRoom&gt; cells = action.proposeCellsRun(player.getCoordinatesWithRooms());</span>
<span class="nc" id="L1981">            List&lt;String&gt; possibilities = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1982" title="All 2 branches missed.">            for(CoordinatesWithRoom c : cells){</span>
<span class="nc" id="L1983">                possibilities.add(c.toString());</span>
<span class="nc" id="L1984">            }</span>
            try {
<span class="nc" id="L1986">                sendListToClient(possibilities); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L1987">                int x = (int)inputStream.readObject();</span>
<span class="nc" id="L1988">                x--;</span>
<span class="nc" id="L1989">                action.run(player,cells.get(x));</span>

<span class="nc" id="L1991">                broadcast(&quot;\n&quot; + nickname + &quot; moved to &quot;+cells.get(x).toString());</span>
//                System.out.println(&quot;CURRENT POSITION &quot; + player.getCoordinatesWithRooms().toString());
<span class="nc" id="L1993">            } catch (Exception e) {</span>
<span class="nc" id="L1994">                System.out.println(&quot;Couldn't run.&quot;);</span>
<span class="nc" id="L1995">            }</span>
<span class="nc" id="L1996">        }</span>

        /**
         * This handles Grab action.
         * @param frenzy if frenzy grab or not
         * @param second if second frenzy grab or first
         */
         public void grab(boolean frenzy, boolean second){
<span class="nc" id="L2004">                    Player player = model.getPlayers().get(currentPlayer);</span>
<span class="nc" id="L2005">                    List&lt;CoordinatesWithRoom&gt; possibleCells = new LinkedList&lt;&gt;();</span>

<span class="nc bnc" id="L2007" title="All 2 branches missed.">                    if(frenzy){ // FRENZY GRAB - UP TO 2</span>
<span class="nc" id="L2008">                        possibleCells = player.getCoordinatesWithRooms().oneTileDistant(model.getMapUsed().getGameBoard(),false);</span>
<span class="nc" id="L2009">                        possibleCells.addAll(player.getCoordinatesWithRooms().xTilesDistant(model.getMapUsed().getGameBoard(),2));</span>
<span class="nc" id="L2010">                        possibleCells.add(player.getCoordinatesWithRooms());</span>
<span class="nc bnc" id="L2011" title="All 2 branches missed.">                        if(second){</span>
<span class="nc" id="L2012">                            possibleCells.addAll(player.getCoordinatesWithRooms().xTilesDistant(model.getMapUsed().getGameBoard(),3));</span>
                        }

                    }else { //NORMAL GRAB
<span class="nc" id="L2016">                        possibleCells = action.proposeCellsGrab(player);</span>
                    }
<span class="nc" id="L2018">                    List&lt;String&gt; listOfCells = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L2019">                    List&lt;String&gt; listOfItems = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L2020" title="All 2 branches missed.">                    if (!possibleCells.isEmpty()) {</span>
<span class="nc bnc" id="L2021" title="All 2 branches missed.">                        for (CoordinatesWithRoom c : possibleCells) {</span>
<span class="nc" id="L2022">                            listOfCells.add(c.toString());</span>
<span class="nc bnc" id="L2023" title="All 4 branches missed.">                            if (c.isSpawnpointCoordinates(model) &amp;&amp; !c.getSpawnpoint(model).getWeaponCards().isEmpty()) {</span>
<span class="nc" id="L2024">                                Spawnpoint s = c.getSpawnpoint(model);</span>
<span class="nc" id="L2025">                                String weapons = &quot;&quot;;</span>
<span class="nc bnc" id="L2026" title="All 2 branches missed.">                                for (WeaponCard w : s.getWeaponCards()) {</span>
<span class="nc" id="L2027">                                    weapons = weapons.concat(w.toString() + &quot; &quot;);</span>
<span class="nc" id="L2028">                                }</span>
<span class="nc" id="L2029">                                listOfItems.add(weapons);</span>
<span class="nc bnc" id="L2030" title="All 2 branches missed.">                            } else if (c.getRoom().hasAmmoTile(c)) { // IT HAS AMMOTILES</span>
<span class="nc" id="L2031">                                listOfItems.add(c.getRoom().getAmmoTile(c).toString());</span>

                                // System.out.println(&quot;LIST OF ITEMS &quot;+c.getRoom().getAmmoTile(c).toString());

                            } else { // IT DOESN'T HAVE AN AMMOTILE
<span class="nc" id="L2036">                                Server.addCellToList(c);    // IT'LL BE ADDED AT THE END OF TURN</span>
<span class="nc" id="L2037">                                System.out.println(&quot;ADDED TO LIST &quot; + c.toString());</span>
                            }
<span class="nc" id="L2039">                        }</span>
                    }
<span class="nc" id="L2041">                    CoordinatesWithRoom chosenCell = new CoordinatesWithRoom();</span>
                    try {
<span class="nc" id="L2043">                        sendListToClient(listOfItems);</span>
<span class="nc" id="L2044">                        sendListToClient(listOfCells); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2045">                        int x = (int) inputStream.readObject();</span>
<span class="nc" id="L2046">                        x--;</span>
<span class="nc" id="L2047">                        chosenCell = possibleCells.get(x);</span>
                        //System.out.println(&quot;CELL FOR GRAB &quot; + chosenCell.toString());


<span class="nc bnc" id="L2051" title="All 2 branches missed.">                        if (chosenCell.isSpawnpointCoordinates(model)) {</span>
<span class="nc" id="L2052">                            grabFromSpawnpoint(chosenCell, player, listOfItems.get(x));</span>
                        } else {
                            //se non spawnpoint
                            //raccolgo un AmmoTile
                            /*
                             * qui faccio direttamente io l'assegnazione della posizione del player  e rimuovo gia' l'ammotile
                             * dalla mappa e ne aggiungo subito un altro
                             * già incluso pescaggio power up
                             * */
<span class="nc" id="L2061">                            printPlayerAmmo(player);</span>
<span class="nc" id="L2062">                            action.grabTile(player, chosenCell);</span>
<span class="nc" id="L2063">                            printPlayerAmmo(player);</span>

<span class="nc" id="L2065">                            broadcast(stringPlayerAmmo(player));</span>
<span class="nc" id="L2066">                            broadcast(nickname + &quot; moved to &quot;+ player.getCoordinatesWithRooms().toString());</span>
                        }
<span class="nc" id="L2068">                    } catch (Exception e) {</span>
<span class="nc" id="L2069">                        System.out.println(&quot;Couldn't grab or couldn't broadcast it.&quot;);</span>
<span class="nc" id="L2070">                    }</span>

<span class="nc" id="L2072">        }</span>


        /**
         * This handles the requests and actions of Shoot action.
         */
        public void shoot(){
<span class="nc" id="L2079">            synchronized (model){</span>
<span class="nc" id="L2080">            Player player = model.getPlayers().get(currentPlayer);</span>
<span class="nc" id="L2081">            LinkedList&lt;WeaponCard&gt;playerWeaponCards=new LinkedList&lt;&gt;();</span>
<span class="nc" id="L2082">            WeaponCard weaponCard=new WeaponCard();</span>
<span class="nc" id="L2083">            LinkedList&lt;EffectAndNumber&gt; paidEffectAndNumber=new LinkedList&lt;&gt;();</span>
<span class="nc" id="L2084">            CoordinatesWithRoom cp=player.getCoordinatesWithRooms();</span>
<span class="nc" id="L2085">            int z = 0;</span>

<span class="nc bnc" id="L2087" title="All 2 branches missed.">            if(player.checkDamage()==2) {</span>
<span class="nc" id="L2088">                lock.lock();</span>
<span class="nc" id="L2089">                sendToClient(&quot;RUN&quot;);</span>
                {
<span class="nc" id="L2091">                    LinkedList&lt;CoordinatesWithRoom&gt; cells = action.proposeCellsRunBeforeShoot(player);</span>
<span class="nc" id="L2092">                    List&lt;String&gt; possibilities = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L2093" title="All 2 branches missed.">                    for (CoordinatesWithRoom c : cells) {</span>
<span class="nc" id="L2094">                        possibilities.add(c.toString());</span>
<span class="nc" id="L2095">                    }</span>
<span class="nc" id="L2096">                    possibilities.add(0, player.getCoordinatesWithRooms().toString() + &quot;  This is your position&quot;);</span>
                    try {
<span class="nc" id="L2098">                        sendListToClient(possibilities); // RITORNA 1 OPPURE 2 OPPURE 3 .... il primo è la pos iniziale</span>
<span class="nc" id="L2099">                        int x = (int) inputStream.readObject();</span>
<span class="nc" id="L2100">                        x--;</span>
<span class="nc bnc" id="L2101" title="All 2 branches missed.">                        if (x &gt; 0) {</span>
<span class="nc" id="L2102">                            action.run(player, cells.get(x));</span>
<span class="nc" id="L2103">                            lock.unlock();</span>
<span class="nc" id="L2104">                            broadcast(&quot;\n&quot; + nickname + &quot; moved to &quot; + cells.get(x).toString());</span>
                        }
//                System.out.println(&quot;CURRENT POSITION &quot; + player.getCoordinatesWithRooms().toString());
<span class="nc" id="L2107">                    } catch (Exception e) {</span>
<span class="nc" id="L2108">                        System.out.println(&quot;Couldn't run.&quot;);</span>
<span class="nc" id="L2109">                        lock.unlock();</span>

<span class="nc" id="L2111">                    }</span>


                }
            }
            try {
                //CHIEDI CARTA DA PAGARE
<span class="nc" id="L2118">                synchronized (player.getHand()) {</span>
<span class="nc bnc" id="L2119" title="All 2 branches missed.">                    for (WeaponCard w : player.getHand()) {</span>
<span class="nc bnc" id="L2120" title="All 2 branches missed.">                        if (w.getReload()) {</span>
<span class="nc" id="L2121">                            playerWeaponCards.add(w);</span>
                        }
<span class="nc" id="L2123">                    }</span>
<span class="nc" id="L2124">                }</span>
<span class="nc bnc" id="L2125" title="All 2 branches missed.">                if (playerWeaponCards.isEmpty()) {</span>
<span class="nc" id="L2126">                    lock.lock();</span>
<span class="nc" id="L2127">                    sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2128">                    sendToClient(&quot;Sorry, you don't have reloaded weapons in your hand&quot;);</span>
<span class="nc" id="L2129">                    numberofActionsMinusOne(new WeaponCard());</span>
<span class="nc" id="L2130">                    action.run(player,cp);</span>
<span class="nc" id="L2131">                    lock.unlock();</span>
                } else {
<span class="nc" id="L2133">                    lock.lock();</span>
<span class="nc" id="L2134">                    sendToClient(&quot;CHOOSEWEAPON&quot;);</span>
<span class="nc" id="L2135">                    sendListToClient(fromWeaponsToNames(playerWeaponCards));</span>
<span class="nc" id="L2136">                    z = (int) inputStream.readObject();</span>
<span class="nc" id="L2137">                    z--;</span>
<span class="nc" id="L2138">                    weaponCard = playerWeaponCards.get(z);</span>
<span class="nc" id="L2139">                    lock.unlock();</span>

<span class="nc" id="L2141">                    int number = 0;</span>
<span class="nc" id="L2142">                    paidEffectAndNumber.add(shootBase(number));</span>

                    AmmoCube.Effect effect;

<span class="nc bnc" id="L2146" title="All 2 branches missed.">                    if (weaponCard.canShootOp1()){</span>
<span class="nc" id="L2147">                        effect= AmmoCube.Effect.OP1;</span>
<span class="nc" id="L2148">                        lock.lock();</span>
<span class="nc" id="L2149">                        sendToClient(&quot;OP1&quot;);</span>
<span class="nc" id="L2150">                        String response = (String) inputStream.readObject();</span>
<span class="nc" id="L2151">                        lock.unlock();</span>
<span class="nc bnc" id="L2152" title="All 2 branches missed.">                        if(response.toUpperCase().equals(&quot;Y&quot;)){</span>
<span class="nc" id="L2153">                            shootOtherEffect(effect,weaponCard, player, paidEffectAndNumber);</span>

                        }
                    }
<span class="nc bnc" id="L2157" title="All 2 branches missed.">                    if (weaponCard.canShootOp2()){</span>
<span class="nc" id="L2158">                        effect= AmmoCube.Effect.OP2;</span>
<span class="nc" id="L2159">                        lock.lock();</span>
<span class="nc" id="L2160">                        sendToClient(&quot;OP2&quot;);</span>
<span class="nc" id="L2161">                        String response = (String) inputStream.readObject();</span>
<span class="nc" id="L2162">                        lock.unlock();</span>
<span class="nc bnc" id="L2163" title="All 2 branches missed.">                        if(response.toUpperCase().equals(&quot;Y&quot;)){</span>
<span class="nc" id="L2164">                            shootOtherEffect(effect,weaponCard, player, paidEffectAndNumber);</span>

                        }
                    }
<span class="nc bnc" id="L2168" title="All 2 branches missed.">                    if (weaponCard.canShootAlt()){</span>
<span class="nc" id="L2169">                        effect= AmmoCube.Effect.ALT;</span>
<span class="nc" id="L2170">                        lock.lock();</span>
<span class="nc" id="L2171">                        sendToClient(&quot;ALT&quot;);</span>
<span class="nc" id="L2172">                        String response = (String) inputStream.readObject();</span>
<span class="nc" id="L2173">                        lock.unlock();</span>
<span class="nc bnc" id="L2174" title="All 2 branches missed.">                        if(response.toUpperCase().equals(&quot;Y&quot;)){</span>
<span class="nc" id="L2175">                            shootOtherEffect(effect,weaponCard, player, paidEffectAndNumber);</span>

                        }
                    }
                    // REMOVES BASE IF I PAID FOR ALT
<span class="nc bnc" id="L2180" title="All 2 branches missed.">                    for(EffectAndNumber en : paidEffectAndNumber){</span>
<span class="nc bnc" id="L2181" title="All 2 branches missed.">                        if(en.getEffect()== AmmoCube.Effect.ALT){</span>
<span class="nc" id="L2182">                            EffectAndNumber temp = en;</span>
<span class="nc" id="L2183">                            paidEffectAndNumber.clear();</span>
<span class="nc" id="L2184">                            paidEffectAndNumber.add(temp);</span>
                        }
<span class="nc" id="L2186">                    }</span>
<span class="nc bnc" id="L2187" title="All 2 branches missed.">                    if(paidEffectAndNumber.size()&gt;1) {</span>
                        // NOW PAIDEFFECTSANDNUMBER HAS ALL THE EFFECTS PAID FOR
<span class="nc" id="L2189">                        changeOrderOfEffects(paidEffectAndNumber, weaponCard);</span>
                    }

<span class="nc" id="L2192">                    List&lt;Object&gt; pastTragets = new LinkedList&lt;&gt;();</span>
                    // SHOOT
<span class="nc bnc" id="L2194" title="All 2 branches missed.">                    for(int i = 0; i&lt;paidEffectAndNumber.size();i++){</span>
<span class="nc bnc" id="L2195" title="All 2 branches missed.">                        if(i==0){</span>
<span class="nc" id="L2196">                            weaponCard.setNotReload();</span>
<span class="nc" id="L2197">                            weaponCard.setReloadAlt(false);</span>
                        }
<span class="nc" id="L2199">                        List&lt;Object&gt; temp = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L2200">                        temp = requestsForEveryWeapon(paidEffectAndNumber.get(i),weaponCard,player,model.getMapUsed().getGameBoard(),model,pastTragets);</span>

<span class="nc" id="L2202">                        pastTragets=temp;</span>

                    }

                }
<span class="nc" id="L2207">            }catch(Exception e){</span>
<span class="nc" id="L2208">                System.out.println(&quot;Couldn't shoot.&quot;);</span>
<span class="nc" id="L2209">                e.printStackTrace();</span>
<span class="nc" id="L2210">            }}</span>
<span class="nc" id="L2211">        }</span>

        /**
         * This handles the payment of secondary effects (non base) of a weapon
         * @param e effect to pay for
         * @param weaponCard weapon
         * @param player player
         * @param paidEffects list where to add effect if paid
         */
        public void shootOtherEffect(AmmoCube.Effect e, WeaponCard weaponCard, Player player, List&lt;EffectAndNumber&gt; paidEffects) {

<span class="nc" id="L2222">            LinkedList&lt;PowerUpCard&gt; playerPowerUpCards = new LinkedList&lt;&gt;();</span>
            try {
                //CHIEDI METODO PAGAMENTO
<span class="nc" id="L2225">                lock.lock();</span>
<span class="nc" id="L2226">                sendToClient(&quot;PAYMENT&quot;);</span>
<span class="nc" id="L2227">                int z = (int) inputStream.readObject();</span>
<span class="nc" id="L2228">                lock.unlock();</span>
                Action.PayOption payOption;

<span class="nc bnc" id="L2231" title="All 2 branches missed.">                if (z == 1) {</span>
<span class="nc" id="L2232">                    payOption = Action.PayOption.AMMO;</span>
                } else {
<span class="nc" id="L2234">                    payOption = Action.PayOption.AMMOPOWER;</span>
                }

<span class="nc bnc" id="L2237" title="All 2 branches missed.">                if (payOption.equals(Action.PayOption.AMMOPOWER)) {</span>
<span class="nc" id="L2238">                    playerPowerUpCards = payWithThesePowerUps(player);</span>
                }
                // CONTROLLA SE PUO' PAGARE L'EFFETTO BASE SE NO ESCI E ANNULLA AZIONE
<span class="nc bnc" id="L2241" title="All 2 branches missed.">                if (!action.canPayCard(weaponCard, player, payOption, e, playerPowerUpCards)) {</span>
                    //MANDA MESSAGGIO
<span class="nc" id="L2243">                    System.out.println(&quot;CAN'T PAY&quot;);</span>
<span class="nc" id="L2244">                    return;</span>

                } else {
<span class="nc bnc" id="L2247" title="All 2 branches missed.">                    if(z==1){</span>
<span class="nc" id="L2248">                        paidEffects.add(action.payAmmo(player,weaponCard,e,0));</span>
                    }else{
<span class="nc" id="L2250">                        paidEffects.add(action.payPowerUp(weaponCard,playerPowerUpCards,player,e,0));</span>
<span class="nc" id="L2251">                        player.getPowerUp().removeAll(playerPowerUpCards);</span>
<span class="nc" id="L2252">                        model.powerUpDeck.getUsedPowerUp().addAll(playerPowerUpCards);</span>
<span class="nc" id="L2253">                        playerPowerUpCards.clear();</span>
                    }
                }
<span class="nc" id="L2256">            } catch (Exception ex) {</span>
<span class="nc" id="L2257">                System.out.println(&quot;Couldn't shootOtherEffects.&quot;);</span>
<span class="nc" id="L2258">            }</span>
<span class="nc" id="L2259">        }</span>

        /**
         * This adds base effect, already paid to be able to shoot.
         * @param number usefu for some weapons
         * @return base effect
         */
        public EffectAndNumber shootBase(int number){
<span class="nc" id="L2267">            return  new EffectAndNumber(AmmoCube.Effect.BASE,number);</span>
        }

        /**
         * This handles the possibility of changing order of effects
         * @param list of effects
         * @param w weapon
         */
        public void changeOrderOfEffects(List&lt;EffectAndNumber&gt; list, WeaponCard w){
            // SOME WEAPONS MUST HAVE A CERTAIN ORDER
            // ASK ONLY IF I CAN CHANGE IT
<span class="nc bnc" id="L2278" title="All 4 branches missed.">            if(w instanceof Thor || w instanceof MachineGun)</span>
<span class="nc" id="L2279">                return;</span>


            try{
<span class="nc" id="L2283">                lock.lock();</span>
<span class="nc" id="L2284">                sendToClient(&quot;CHANGE&quot;);</span>
<span class="nc" id="L2285">                String response = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L2286" title="All 2 branches missed.">                if(response.toUpperCase().equals(&quot;Y&quot;)){</span>
<span class="nc" id="L2287">                    int x = list.size();</span>
<span class="nc" id="L2288">                    List&lt;EffectAndNumber&gt; list2 = new LinkedList&lt;&gt;(list);</span>
<span class="nc" id="L2289">                    list.clear();</span>

<span class="nc bnc" id="L2291" title="All 2 branches missed.">                    for(int i=0;i&lt;x;i++){</span>
                        //CHIEDI UN EFFETTO
<span class="nc" id="L2293">                        sendToClient(&quot;CHANGEORDER&quot;);</span>
<span class="nc" id="L2294">                        sendListToClient(fromEffectsAndNumberToNames(list2));</span>
<span class="nc" id="L2295">                        int z = (int) inputStream.readObject();</span>
<span class="nc" id="L2296">                        z--;</span>
<span class="nc" id="L2297">                        list.add(list2.remove(z));</span>
                    }

                }

<span class="nc" id="L2302">            }catch (Exception e){</span>
<span class="nc" id="L2303">                System.out.println(&quot;Couldn't change order of effects.&quot;);</span>
<span class="nc" id="L2304">            }</span>

<span class="nc" id="L2306">            lock.unlock();</span>
<span class="nc" id="L2307">        }</span>


        /**
         * This handles the weapon grab.
         * @param chosenCell of spawnpoint
         * @param player that wants the weapon
         * @param cellItems of what's inside the spawnpoint
         * @return boolean if player got the weapon
         */
   public boolean grabFromSpawnpoint(CoordinatesWithRoom chosenCell, Player player,String cellItems){
            /*
             * controllo io se può pagarla + ricarica ma tu devi:
             * 1-controllare che abbia meno di 3 carte in mano x
             * 2-una volta raccolta devi rimuoverla dalle carte dello spawnpoint
             * 3-una volta finito cio setta la posizione del player nel punto in cui ha scelto di raccogliere
             * se scarta una carta rimettila nel deck x
             * */
<span class="nc" id="L2325">            lock.lock();</span>
<span class="nc" id="L2326">            sendToClient(&quot;GRABWEAPON&quot;);</span>
<span class="nc" id="L2327">            sendToClient(cellItems); // RITORNA 1 O 2 O 3</span>

            try {
<span class="nc" id="L2330">                int x = (int)inputStream.readObject();</span>
<span class="nc" id="L2331">                x--;</span>
<span class="nc" id="L2332">                Spawnpoint s = chosenCell.getSpawnpoint(model);</span>
<span class="nc" id="L2333">                WeaponCard weaponCard=s.getWeaponCards().get(x);</span>

<span class="nc" id="L2335">                LinkedList&lt;PowerUpCard&gt;playerPowerUpCards=new LinkedList&lt;&gt;();</span>

                //CHIEDI METODO PAGAMENTO
<span class="nc" id="L2338">                lock.lock();</span>
<span class="nc" id="L2339">                sendToClient(&quot;PAYMENT&quot;);</span>
<span class="nc" id="L2340">                int z = (int)inputStream.readObject();</span>
                Action.PayOption payOption;

<span class="nc bnc" id="L2343" title="All 2 branches missed.">                if(z==1){</span>
<span class="nc" id="L2344">                    payOption= Action.PayOption.AMMO;</span>
                }else{
<span class="nc" id="L2346">                    payOption= Action.PayOption.AMMOPOWER;</span>
                }

<span class="nc bnc" id="L2349" title="All 2 branches missed.">                if(payOption.equals(Action.PayOption.AMMOPOWER)){</span>
<span class="nc" id="L2350">                    playerPowerUpCards=payWithThesePowerUps(player);</span>
                }
                // CONTROLLA SE PUO' PAGARE L'EFFETTO BASE SE NO ESCI E ANNULLA AZIONE
<span class="nc bnc" id="L2353" title="All 2 branches missed.">                if(!action.canPayCard(weaponCard,player,payOption,AmmoCube.Effect.BASE,playerPowerUpCards)){</span>
                    //MANDA MESSAGGIO
<span class="nc" id="L2355">                    playerPowerUpCards.clear();</span>
<span class="nc" id="L2356">                    return false;}</span>
<span class="nc" id="L2357">                lock.unlock();</span>

                // CONTROLLA SE PUO RACCOGLIERE ALTRIMENTI RICHIEDI DROP ARMA, METTILA IN DCARD
<span class="nc bnc" id="L2360" title="All 2 branches missed.">                if(!player.canGrabWeapon()){</span>
<span class="nc" id="L2361">                    List&lt;String&gt; yourWeapons = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L2362">                    synchronized (player.getHand()) {</span>
<span class="nc bnc" id="L2363" title="All 2 branches missed.">                        for (WeaponCard w : player.getHand()) {</span>
<span class="nc" id="L2364">                            yourWeapons.add(w.toString());</span>
<span class="nc" id="L2365">                        }</span>
<span class="nc" id="L2366">                    }</span>
<span class="nc" id="L2367">                    lock.lock();</span>
<span class="nc" id="L2368">                    sendToClient(&quot;DROPWEAPON&quot;);</span>
<span class="nc" id="L2369">                    sendListToClient(yourWeapons); // RISPOSTA 1 O 2 O 3</span>
<span class="nc" id="L2370">                    int y = (int)inputStream.readObject();</span>
<span class="nc" id="L2371">                    y--;</span>
<span class="nc" id="L2372">                    WeaponCard weaponCard1 = player.getHand().remove(y);</span>
<span class="nc" id="L2373">                    weaponCard1.setNotReload();</span>
<span class="nc" id="L2374">                    weaponCard1.getPrice().get(0).setPaid(true);</span>
<span class="nc" id="L2375">                    s.getWeaponCards().add(weaponCard1);</span>
<span class="nc" id="L2376">                    lock.unlock();</span>
                }

<span class="nc" id="L2379">                lock.lock();</span>


<span class="nc bnc" id="L2382" title="All 2 branches missed.">                if(z==1){</span>
<span class="nc" id="L2383">                    action.payAmmo(player,weaponCard, AmmoCube.Effect.BASE,0);</span>
<span class="nc" id="L2384">                    weaponCard.setReload();</span>

                }else{
<span class="nc" id="L2387">                    action.payPowerUp(weaponCard,playerPowerUpCards,player, AmmoCube.Effect.BASE,0);</span>
<span class="nc" id="L2388">                    weaponCard.setReload();</span>
                }

                //////
<span class="nc" id="L2392">                CoordinatesWithRoom spc = getSpawnpointCoordinates(s);</span>
<span class="nc" id="L2393">                action.grabWeapon(player,weaponCard, s, playerPowerUpCards, spc);</span>
                //////

<span class="nc" id="L2396">                lock.unlock();</span>
<span class="nc" id="L2397">                broadcast(player+&quot; grabbed &quot;+weaponCard.toString()+ &quot; from Spawnpoint &quot;+ s.getColor().toString());</span>

<span class="nc" id="L2399">            } catch (Exception e) {</span>
<span class="nc" id="L2400">                System.out.println(&quot;Couldn't grab from Spawnpoint.&quot;);</span>
<span class="nc" id="L2401">            }</span>
<span class="nc" id="L2402">        lock.unlock();</span>
<span class="nc" id="L2403">            return true;</span>

        }

        public LinkedList&lt;PowerUpCard&gt; payWithThesePowerUps(Player player){
<span class="nc" id="L2408">            LinkedList&lt;PowerUpCard&gt; chosenPower=new LinkedList&lt;&gt;();</span>
            //MANDA CARTE POWER UP IN MANO
<span class="nc bnc" id="L2410" title="All 2 branches missed.">            for (PowerUpCard powerUp : player.getPowerUp()) {</span>
<span class="nc" id="L2411">                lock.lock();</span>
<span class="nc" id="L2412">                sendToClient(&quot;PAYWITHPOWERUP&quot;);</span>
<span class="nc" id="L2413">                sendToClient(powerUp.toString());   // RITORNA Y O N</span>
<span class="nc" id="L2414">                String response = null;</span>
                try {
<span class="nc" id="L2416">                    response = (String) inputStream.readObject();</span>
<span class="nc" id="L2417">                    lock.unlock();</span>
<span class="nc bnc" id="L2418" title="All 2 branches missed.">                    if(response.toUpperCase().equals(&quot;Y&quot;)){</span>
<span class="nc" id="L2419">                        chosenPower.add(powerUp);</span>
                    }
<span class="nc" id="L2421">                } catch (Exception e) {</span>
<span class="nc" id="L2422">                    System.out.println(&quot;Couldn't pay with powerups.&quot;);</span>
<span class="nc" id="L2423">                }</span>
<span class="nc" id="L2424">            }</span>
<span class="nc" id="L2425">            return chosenPower;</span>
        }

        /**
         * This transforms Powerups to Strings.
         * @param list to transform
         * @return list of Strings
         */
        public List&lt;String&gt; fromPowerupsToNames(List&lt;PowerUpCard&gt; list){
<span class="nc" id="L2434">            List&lt;String&gt; pows = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L2435" title="All 2 branches missed.">            for (PowerUpCard o : list) {</span>
<span class="nc" id="L2436">                pows.add(o.toString());</span>
<span class="nc" id="L2437">            }</span>
<span class="nc" id="L2438">            return pows;</span>
        }
        /**
         * This transforms Rooms to Strings.
         * @param list to transform
         * @return list of Strings
         */
        public List&lt;String&gt; fromRoomsToNames(List&lt;Room&gt; list){
<span class="nc" id="L2446">            List&lt;String&gt; rooms = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L2447" title="All 2 branches missed.">            for (Room o : list) {</span>
<span class="nc" id="L2448">                rooms.add(Integer.toString(o.getToken()));</span>
<span class="nc" id="L2449">            }</span>
<span class="nc" id="L2450">            return rooms;</span>
        }
        /**
         * This transforms Targets to Strings.
         * @param list to transform
         * @return list of Strings
         */
        public List&lt;String&gt; fromTargetsToNames(List&lt;Object&gt; list){
<span class="nc" id="L2458">            List&lt;String&gt; targets = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L2459" title="All 2 branches missed.">            for (Object o : list) {</span>
<span class="nc" id="L2460">                targets.add(o.toString());</span>
<span class="nc" id="L2461">            }</span>
<span class="nc" id="L2462">            return targets;</span>
        }
        /**
         * This transforms Players to Strings.
         * @param list to transform
         * @return list of Strings
         */
        public List&lt;String&gt; fromPlayersToNames(List&lt;Player&gt; list){
<span class="nc" id="L2470">            List&lt;String&gt; targets = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L2471" title="All 2 branches missed.">            for (Player o : list) {</span>
<span class="nc" id="L2472">                targets.add(o.toString());</span>
<span class="nc" id="L2473">            }</span>
<span class="nc" id="L2474">            return targets;</span>
        }
        /**
         * This transforms cells to Strings.
         * @param list to transform
         * @return list of Strings
         */
        public List&lt;String&gt; fromCellsToNames(List&lt;CoordinatesWithRoom&gt; list){
<span class="nc" id="L2482">            List&lt;String&gt; cells = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L2483" title="All 2 branches missed.">            for (CoordinatesWithRoom c : list) {</span>
<span class="nc" id="L2484">                cells.add(c.toString());</span>
<span class="nc" id="L2485">            }</span>
<span class="nc" id="L2486">            return cells;</span>
        }
        /**
         * This transforms weapons to Strings.
         * @param list to transform
         * @return list of Strings
         */
        public List&lt;String&gt; fromWeaponsToNames(List&lt;WeaponCard&gt; weapons){
<span class="nc" id="L2494">            List&lt;String&gt; list = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L2495" title="All 2 branches missed.">            for (WeaponCard c : weapons) {</span>
<span class="nc" id="L2496">                list.add(c.toString());</span>
<span class="nc" id="L2497">            }</span>
<span class="nc" id="L2498">            return list;</span>
        }
        /**
         * This transforms effects and number to Strings.
         * @param list to transform
         * @return list of Strings
         */
        public List&lt;String&gt; fromEffectsAndNumberToNames(List&lt;EffectAndNumber&gt; e){
<span class="nc" id="L2506">            List&lt;String&gt; list = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L2507" title="All 2 branches missed.">            for (EffectAndNumber c : e) {</span>
<span class="nc" id="L2508">                list.add(c.toString());</span>
<span class="nc" id="L2509">            }</span>
<span class="nc" id="L2510">            return list;</span>
        }


        /**
         * This method handles the actual shooting and its requests.
         *
         * @param e effect to do
         * @param w weaponcard
         * @param p shooter
         * @param g gameboard
         * @param model gamemodel
         * @param pastTargets list of targets that is used sometimes in between effects of the same weapon
         * @return a list if the other effects may need it or an empty list if it's not important to check anything
         */
        public List&lt;Object&gt; requestsForEveryWeapon(EffectAndNumber e, WeaponCard w, Player p, GameBoard g, GameModel model, List&lt;Object&gt; pastTargets){
<span class="nc" id="L2526">            CoordinatesWithRoom playerPosition = p.getCoordinatesWithRooms();</span>
            List&lt;CoordinatesWithRoom&gt; cells;
            List&lt;Object&gt; targets;
            try {
<span class="nc bnc" id="L2530" title="All 22 branches missed.">                switch (w.toString()){</span>

<span class="nc" id="L2532">                    case &quot;Cyberblade&quot;:lock.lock();</span>
<span class="nc bnc" id="L2533" title="All 4 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.BASE || e.getEffect()== AmmoCube.Effect.OP2){</span>
<span class="nc" id="L2534">                            cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L2535">                            targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>

<span class="nc bnc" id="L2537" title="All 2 branches missed.">                            if (!targets.isEmpty()) {</span>
                                // ASK WHICH 1 TARGET TO DAMAGE, REMOVE THE OTHERS
<span class="nc" id="L2539">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L2540">                                sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2541">                                int xh = (int)inputStream.readObject();</span>
<span class="nc" id="L2542">                                xh--;</span>
<span class="nc" id="L2543">                                Object tt = targets.get(xh);</span>
<span class="nc" id="L2544">                                targets.clear();</span>
<span class="nc" id="L2545">                                targets.add(tt);</span>

                                // CHECK TARGETS OP1 AND BASE DIFFERENTI (RITORNA IL GIOCATORE COLPITO COSì LO SALVI IN SHOOT)
                                // SE PASTTARGETS VUOTO OK, SE PIENO TARGET SCELTO DEVE ESSERE DIVERSO DA QUELLO
<span class="nc bnc" id="L2549" title="All 4 branches missed.">                                if(!pastTargets.isEmpty() &amp;&amp; pastTargets.get(0)==targets.get(0)){</span>
<span class="nc" id="L2550">                                    break;</span>
                                }

<span class="nc" id="L2553">                                w.applyDamage(targets,p,e);</span>
<span class="nc" id="L2554">                                useTargetingScope(p,targets);</span>
<span class="nc" id="L2555">                            }else{</span>
<span class="nc" id="L2556">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2557">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L2558">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L2559">                                return new LinkedList&lt;&gt;();</span>
                            }
<span class="nc" id="L2561">                            lock.unlock();</span>
<span class="nc" id="L2562">                            return targets;</span>
                        }
<span class="nc bnc" id="L2564" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.OP1){</span>
                            // MOVE 1 SQUARE
<span class="nc" id="L2566">                            List&lt;CoordinatesWithRoom&gt; one = playerPosition.oneTileDistant(g,false);</span>
<span class="nc bnc" id="L2567" title="All 2 branches missed.">                            if (!one.isEmpty()) {</span>
<span class="nc" id="L2568">                                sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L2569">                                sendListToClient(fromCellsToNames(one)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2570">                                int x = (int)inputStream.readObject();</span>
<span class="nc" id="L2571">                                x--;</span>
<span class="nc" id="L2572">                                p.setPlayerPosition(one.get(x));</span>

<span class="nc" id="L2574">                                lock.unlock();</span>
<span class="nc" id="L2575">                                broadcast(&quot;\n&quot; + p.getName() + &quot; is in &quot;+one.get(x).toString());</span>
<span class="nc" id="L2576">                                lock.lock();</span>
<span class="nc" id="L2577">                            }else{</span>
<span class="nc" id="L2578">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2579">                                sendToClient(&quot;Sorry there are no cells.&quot;);</span>
<span class="nc" id="L2580">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }
<span class="nc" id="L2583">                        lock.unlock();</span>
<span class="nc" id="L2584">                        break;</span>

<span class="nc" id="L2586">                    case &quot;Electroscythe&quot;:lock.lock();</span>
<span class="nc" id="L2587">                        cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L2588">                        targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc" id="L2589">                        w.applyDamage(targets,p,e);</span>
<span class="nc" id="L2590">                        useTargetingScope(p,targets);</span>
<span class="nc" id="L2591">                        lock.unlock();</span>
<span class="nc" id="L2592">                        break;</span>

<span class="nc" id="L2594">                    case &quot;Flamethrower&quot;:lock.lock();</span>
<span class="nc" id="L2595">                        cells = playerPosition.oneTileDistant(g,false);</span>
<span class="nc bnc" id="L2596" title="All 2 branches missed.">                        if (!cells.isEmpty()) {</span>
                            // ASK PLAYER TO CHOSE ONE OR TWO SQUARES  - SHOULD ASK SAYING 1 AND 2 MUST HAVE SAME DIR?
<span class="nc" id="L2598">                            sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L2599">                            sendListToClient(fromCellsToNames(cells)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2600">                            int xe = (int)inputStream.readObject();</span>
<span class="nc" id="L2601">                            xe--;</span>
<span class="nc" id="L2602">                            CoordinatesWithRoom chosen = cells.get(xe);</span>
<span class="nc" id="L2603">                            List&lt;CoordinatesWithRoom&gt; cells1 = new LinkedList&lt;&gt;(cells);</span>
<span class="nc" id="L2604">                            cells.clear();</span>
<span class="nc" id="L2605">                            cells.add(chosen);</span>

<span class="nc" id="L2607">                            List&lt;CoordinatesWithRoom&gt; cellslist2 = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L2608">                            cellslist2.removeAll(cells1);</span>
<span class="nc bnc" id="L2609" title="All 2 branches missed.">                            if (!cellslist2.isEmpty()) {</span>

<span class="nc" id="L2611">                            sendToClient(&quot;CHOOSEANOTHER&quot;);</span>
<span class="nc" id="L2612">                            String response = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L2613" title="All 2 branches missed.">                            if(response.toUpperCase().equals(&quot;Y&quot;)){</span>
<span class="nc" id="L2614">                                    sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L2615">                                    sendListToClient(fromCellsToNames(cellslist2)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2616">                                    int xye = (int)inputStream.readObject();</span>
<span class="nc" id="L2617">                                    xye--;</span>

                                    // CHECK FIRST (DISTANT 1) AND (SECOND DISTANT 2) SAME DIRECTION
                                    // IF NOT, SECOND NOT ADDED
<span class="nc bnc" id="L2621" title="All 2 branches missed.">                                    if(cells.get(0).checkSameDirection(cells.get(0),cellslist2.get(xye),10,g,false)) {</span>
<span class="nc" id="L2622">                                        cells.add(cellslist2.get(xye));</span>
                                    }
                                }
<span class="nc" id="L2625">                            }else{</span>
<span class="nc" id="L2626">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2627">                                sendToClient(&quot;Sorry there are no cells.&quot;);</span>
<span class="nc" id="L2628">                                return new LinkedList&lt;&gt;();</span>
                            }

<span class="nc" id="L2631">                            targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>

<span class="nc bnc" id="L2633" title="All 2 branches missed.">                            if(e.getEffect()== AmmoCube.Effect.BASE){</span>
<span class="nc" id="L2634">                                List&lt;Object&gt; targets2=new LinkedList&lt;&gt;(targets);</span>
<span class="nc" id="L2635">                                targets.clear();</span>
<span class="nc bnc" id="L2636" title="All 2 branches missed.">                                for(int i=0;i&lt;cells.size();i++) {</span>
                                    // ASK 1 TARGET PER OGNI SQUARE (2 FORSE)
<span class="nc" id="L2638">                                    sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc bnc" id="L2639" title="All 2 branches missed.">                                    if (!targets.isEmpty()) {</span>
<span class="nc" id="L2640">                                        sendListToClient(fromTargetsToNames(targets2)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2641">                                        int xh = (int) inputStream.readObject();</span>
<span class="nc" id="L2642">                                        xh--;</span>
<span class="nc" id="L2643">                                        Object tt = targets2.get(xh);</span>
<span class="nc" id="L2644">                                        targets.add(tt);</span>
<span class="nc" id="L2645">                                        targets2.remove(tt);</span>
<span class="nc" id="L2646">                                    }else{</span>
<span class="nc" id="L2647">                                        sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2648">                                        sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L2649">                                        numberofActionsMinusOne(w);</span>
<span class="nc" id="L2650">                                        return new LinkedList&lt;&gt;();</span>

                                    }
                                }
                            }
<span class="nc" id="L2655">                            w.applyDamage(targets,p,e);</span>
<span class="nc" id="L2656">                            useTargetingScope(p,targets);</span>
<span class="nc" id="L2657">                        }else{</span>
<span class="nc" id="L2658">                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2659">                            sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L2660">                            numberofActionsMinusOne(w);</span>
<span class="nc" id="L2661">                            return new LinkedList&lt;&gt;();</span>
                        }
<span class="nc" id="L2663">                        lock.unlock();</span>
<span class="nc" id="L2664">                        break;</span>

<span class="nc" id="L2666">                    case &quot;Furnace&quot;:lock.lock();</span>
<span class="nc bnc" id="L2667" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.BASE) {</span>
<span class="nc" id="L2668">                            LinkedList&lt;Room&gt; possibleRooms = new LinkedList&lt;&gt;();</span>

<span class="nc bnc" id="L2670" title="All 2 branches missed.">                            for (int k = 0; k &lt; g.getDoors().size(); k++) {</span>
<span class="nc bnc" id="L2671" title="All 2 branches missed.">                                if (playerPosition.getX() == g.getDoors().get(k).getCoordinates1().getX() &amp;&amp;</span>
<span class="nc bnc" id="L2672" title="All 2 branches missed.">                                        playerPosition.getY() == g.getDoors().get(k).getCoordinates1().getY() &amp;&amp;</span>
<span class="nc bnc" id="L2673" title="All 2 branches missed.">                                        playerPosition.getRoom().getToken() == g.getDoors().get(k).getCoordinates1().getRoom().getToken()) {</span>

<span class="nc" id="L2675">                                    possibleRooms.add(g.getDoors().get(k).getCoordinates2().getRoom());</span>
                                }

<span class="nc bnc" id="L2678" title="All 2 branches missed.">                                if (playerPosition.getX() == g.getDoors().get(k).getCoordinates2().getX() &amp;&amp;</span>
<span class="nc bnc" id="L2679" title="All 2 branches missed.">                                        playerPosition.getY() == g.getDoors().get(k).getCoordinates2().getY() &amp;&amp;</span>
<span class="nc bnc" id="L2680" title="All 2 branches missed.">                                        playerPosition.getRoom().getToken() == g.getDoors().get(k).getCoordinates2().getRoom().getToken()) {</span>

<span class="nc" id="L2682">                                    possibleRooms.add(g.getDoors().get(k).getCoordinates1().getRoom());</span>

                                }
                            }
<span class="nc bnc" id="L2686" title="All 2 branches missed.">                            if (!possibleRooms.isEmpty()) {</span>
                                // ASK PLAYER FOR A ROOM (DIFFERENT) - METTILA NELLA COORDINATA ROOM
                                // SEND PLAYER LIST OF ROOMS possibleRooms APPENA CREATA
<span class="nc" id="L2689">                                sendToClient(&quot;CHOOSEROOM&quot;);</span>
<span class="nc" id="L2690">                                sendListToClient(fromRoomsToNames(possibleRooms)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2691">                                int xoh = (int) inputStream.readObject();</span>
<span class="nc" id="L2692">                                xoh--;</span>
<span class="nc" id="L2693">                                CoordinatesWithRoom room = new CoordinatesWithRoom(1,1,possibleRooms.get(xoh));</span>

<span class="nc" id="L2695">                                cells = w.getPossibleTargetCells(room, e, g);</span>
<span class="nc" id="L2696">                                targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc" id="L2697">                                w.applyDamage(targets,p,e);</span>
<span class="nc" id="L2698">                                useTargetingScope(p,targets);</span>
<span class="nc" id="L2699">                            }else{</span>
<span class="nc" id="L2700">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2701">                                sendToClient(&quot;Sorry there are no rooms different from yours.&quot;);</span>
<span class="nc" id="L2702">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L2703">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }
<span class="nc bnc" id="L2706" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.ALT) {</span>
<span class="nc" id="L2707">                            cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc bnc" id="L2708" title="All 2 branches missed.">                            if (!cells.isEmpty()) {</span>
                                // ASK PLAYER WHICH TILE, GET ONE BACK IN THAT LIST
<span class="nc" id="L2710">                                sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L2711">                                sendListToClient(fromCellsToNames(cells)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2712">                                int x = (int)inputStream.readObject();</span>
<span class="nc" id="L2713">                                x--;</span>
<span class="nc" id="L2714">                                p.setPlayerPosition(cells.get(x));</span>
<span class="nc" id="L2715">                                broadcast(&quot;\n&quot; + p.getName() + &quot; is in &quot;+cells.get(x).toString());</span>

<span class="nc" id="L2717">                                targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc" id="L2718">                                w.applyDamage(targets,p,e);</span>
<span class="nc" id="L2719">                                useTargetingScope(p,targets);</span>
<span class="nc" id="L2720">                            }else{</span>
<span class="nc" id="L2721">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2722">                                sendToClient(&quot;Sorry there are no cells.&quot;);</span>
<span class="nc" id="L2723">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L2724">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }
<span class="nc" id="L2727">                        lock.unlock();</span>
<span class="nc" id="L2728">                        break;</span>

<span class="nc" id="L2730">                    case &quot;GrenadeLauncher&quot;:lock.lock();</span>
<span class="nc bnc" id="L2731" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.BASE) {</span>
<span class="nc" id="L2732">                            cells = w.getPossibleTargetCells(playerPosition, e, g);</span>
<span class="nc" id="L2733">                            targets = w.fromCellsToTargets(cells, playerPosition, g, p, model, e);</span>
<span class="nc bnc" id="L2734" title="All 2 branches missed.">                            if (!targets.isEmpty()) {</span>
                                // ASK WHICH 1 TARGET TO DAMAGE, REMOVE THE OTHERS
<span class="nc" id="L2736">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L2737">                                sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2738">                                int x = (int)inputStream.readObject();</span>
<span class="nc" id="L2739">                                x--;</span>
<span class="nc" id="L2740">                                Object t = targets.get(x);</span>
<span class="nc" id="L2741">                                targets.clear();</span>
<span class="nc" id="L2742">                                targets.add(t);</span>

<span class="nc" id="L2744">                                w.applyDamage(targets, p, e);</span>
<span class="nc" id="L2745">                                useTargetingScope(p,targets);</span>

                                // ASK SE VUOLE MUOVERE IL TARGET DI 1
<span class="nc" id="L2748">                                sendToClient(&quot;MOVETARGET&quot;);</span>
<span class="nc" id="L2749">                                String res = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L2750" title="All 2 branches missed.">                                if(res.toUpperCase().equals(&quot;Y&quot;)){</span>
<span class="nc" id="L2751">                                    CoordinatesWithRoom c =((Player)targets.get(0)).getCoordinatesWithRooms();</span>
<span class="nc" id="L2752">                                    List&lt;CoordinatesWithRoom&gt; list = c.oneTileDistant(g,false);</span>
<span class="nc bnc" id="L2753" title="All 2 branches missed.">                                    if (!list.isEmpty()) {</span>
<span class="nc" id="L2754">                                        sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L2755">                                        sendListToClient(fromCellsToNames(list)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2756">                                        int xyp = (int)inputStream.readObject();</span>
<span class="nc" id="L2757">                                        xyp--;</span>
<span class="nc" id="L2758">                                        ((Player) targets.get(0)).setPlayerPosition(list.get(xyp));</span>
<span class="nc" id="L2759">                                        broadcast(&quot;\n&quot; + ((Player) targets.get(0)).getName() + &quot; is in &quot;+list.get(xyp).toString());</span>
<span class="nc" id="L2760">                                    }else{</span>
<span class="nc" id="L2761">                                        sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2762">                                        sendToClient(&quot;Sorry there are no cells.&quot;);</span>
<span class="nc" id="L2763">                                        return new LinkedList&lt;&gt;();</span>
                                    }
                                }
<span class="nc" id="L2766">                            }else{</span>
<span class="nc" id="L2767">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2768">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L2769">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L2770">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }
<span class="nc bnc" id="L2773" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.OP1) {</span>
<span class="nc" id="L2774">                            cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc bnc" id="L2775" title="All 2 branches missed.">                            if (!cells.isEmpty()) {</span>
                                // ASK UNA CELLA ANCHE LA TUA
<span class="nc" id="L2777">                                sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L2778">                                sendListToClient(fromCellsToNames(cells)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2779">                                int xr = (int)inputStream.readObject();</span>
<span class="nc" id="L2780">                                xr--;</span>
<span class="nc" id="L2781">                                CoordinatesWithRoom c2 =cells.get(xr);</span>
<span class="nc" id="L2782">                                cells.clear();</span>
<span class="nc" id="L2783">                                cells.add(c2);</span>
<span class="nc" id="L2784">                                targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc" id="L2785">                                w.applyDamage(targets,p,e);</span>
<span class="nc" id="L2786">                                useTargetingScope(p,targets);</span>
<span class="nc" id="L2787">                            }else{</span>
<span class="nc" id="L2788">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2789">                                sendToClient(&quot;Sorry there are no cells.&quot;);</span>
<span class="nc" id="L2790">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L2791">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }
<span class="nc" id="L2794">                        lock.unlock();</span>
<span class="nc" id="L2795">                        break;</span>

<span class="nc" id="L2797">                    case &quot;Heatseeker&quot;:lock.lock();</span>
<span class="nc" id="L2798">                        cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L2799">                        targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc bnc" id="L2800" title="All 2 branches missed.">                        if (!targets.isEmpty()) {</span>
                            // ASK WHICH 1 TARGET TO DAMAGE, REMOVE THE OTHERS
<span class="nc" id="L2802">                            sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L2803">                            sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2804">                            int x = (int)inputStream.readObject();</span>
<span class="nc" id="L2805">                            x--;</span>
<span class="nc" id="L2806">                            Object t = targets.get(x);</span>
<span class="nc" id="L2807">                            targets.clear();</span>
<span class="nc" id="L2808">                            targets.add(t);</span>

<span class="nc" id="L2810">                            w.applyDamage(targets,p,e);</span>
<span class="nc" id="L2811">                            useTargetingScope(p,targets);</span>
<span class="nc" id="L2812">                        }else{</span>
<span class="nc" id="L2813">                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2814">                            sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L2815">                            numberofActionsMinusOne(w);</span>
<span class="nc" id="L2816">                            return new LinkedList&lt;&gt;();</span>
                        }
<span class="nc" id="L2818">                        lock.unlock();</span>
<span class="nc" id="L2819">                        break;</span>

<span class="nc" id="L2821">                    case &quot;Hellion&quot;:lock.lock();</span>
<span class="nc" id="L2822">                        cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L2823">                        targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc bnc" id="L2824" title="All 2 branches missed.">                        if (!targets.isEmpty()) {</span>
                            // ASK WHICH 1 TARGET TO DAMAGE, REMOVE THE OTHERS
<span class="nc" id="L2826">                            sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L2827">                            sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2828">                            int y = (int)inputStream.readObject();</span>
<span class="nc" id="L2829">                            y--;</span>
                            // SAVE IT FOR LATER
<span class="nc" id="L2831">                            Object target = targets.get(y);</span>
<span class="nc" id="L2832">                            List&lt;Object&gt; targets2 = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L2833">                            targets2.add(target);</span>
<span class="nc" id="L2834">                            targets.clear();</span>
<span class="nc" id="L2835">                            targets.add(target);</span>

<span class="nc" id="L2837">                            CoordinatesWithRoom c = ((Player)target).getCoordinatesWithRooms(); // COORD DEL TARGET</span>
<span class="nc" id="L2838">                            List&lt;CoordinatesWithRoom&gt; newList = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L2839">                            newList.add(c); // IT HAS JUST COORD TARGET</span>
<span class="nc" id="L2840">                            targets = w.fromCellsToTargets(newList,playerPosition,g,p,model,e);</span>

<span class="nc bnc" id="L2842" title="All 2 branches missed.">                            for(Object o : targets){</span>
<span class="nc bnc" id="L2843" title="All 4 branches missed.">                                if(o instanceof Player &amp;&amp; ((Player) o).getColor()==((Player) target).getColor()){</span>
<span class="nc" id="L2844">                                    targets.remove(o);</span>
<span class="nc" id="L2845">                                    break;</span>
                                }
<span class="nc" id="L2847">                            }</span>
<span class="nc" id="L2848">                            targets.add(0,target);  // TARGET HAS TO BE IN FRONT</span>

<span class="nc" id="L2850">                            w.applyDamage(targets,p,e);</span>
<span class="nc" id="L2851">                            useTargetingScope(p,targets2); // IT HAS JUST FIRST TARGET (THE DAMAGED ONE)</span>
<span class="nc" id="L2852">                        }else{</span>
<span class="nc" id="L2853">                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2854">                            sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L2855">                            numberofActionsMinusOne(w);</span>
                            //return Collections.emptyList();
<span class="nc" id="L2857">                            return new LinkedList&lt;&gt;();</span>
                        }
<span class="nc" id="L2859">                        lock.unlock();</span>
<span class="nc" id="L2860">                        break;</span>

<span class="nc" id="L2862">                    case &quot;LockRifle&quot;:lock.lock();</span>
<span class="nc" id="L2863">                        cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L2864">                        targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc bnc" id="L2865" title="All 2 branches missed.">                        if (!targets.isEmpty()) {</span>
                            // ASK WHICH 1 TARGET TO DAMAGE, REMOVE THE OTHERS
<span class="nc" id="L2867">                            sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L2868">                            sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2869">                            int r = (int)inputStream.readObject();</span>
<span class="nc" id="L2870">                            r--;</span>
<span class="nc" id="L2871">                            Object tar = targets.get(r);</span>
<span class="nc" id="L2872">                            targets.clear();</span>
<span class="nc" id="L2873">                            targets.add(tar);</span>

                            // CHECK TARGETS OP1 AND BASE DIFFERENTI (RITORNA IL GIOCATORE COLPITO COSì LO SALVI IN SHOOT)
                            // SE PASTTARGETS VUOTO OK, SE PIENO TARGET SCELTO DEVE ESSERE DIVERSO DA QUELLO
<span class="nc bnc" id="L2877" title="All 4 branches missed.">                            if(!pastTargets.isEmpty() &amp;&amp; pastTargets.get(0)==targets.get(0)){</span>
<span class="nc" id="L2878">                                break;</span>
                            }

<span class="nc" id="L2881">                            w.applyDamage(targets,p,e);</span>
<span class="nc bnc" id="L2882" title="All 2 branches missed.">                            if(e.getEffect()== AmmoCube.Effect.BASE){   // ONLY BASE DAMAGES TARGETS</span>
<span class="nc" id="L2883">                                useTargetingScope(p,targets);</span>
                            }
<span class="nc" id="L2885">                        }else{</span>
<span class="nc" id="L2886">                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2887">                            sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L2888">                            numberofActionsMinusOne(w);</span>
<span class="nc" id="L2889">                            return new LinkedList&lt;&gt;();</span>
                        }
<span class="nc" id="L2891">                        lock.unlock();</span>
<span class="nc" id="L2892">                        return targets;</span>

                    case &quot;MachineGun&quot;:  // CONSIDERO BASE PRIMA DEGLI ALTRI EFFETTI
<span class="nc" id="L2895">                        lock.lock();</span>
<span class="nc" id="L2896">                        cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L2897">                        targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>

<span class="nc bnc" id="L2899" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.BASE) {</span>
<span class="nc bnc" id="L2900" title="All 2 branches missed.">                            if (!targets.isEmpty()) {</span>
                                // ASK TO CHOOSE 1 OR 2 TARGETS -BASE
<span class="nc" id="L2902">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L2903">                                sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2904">                                int nu = (int) inputStream.readObject();</span>
<span class="nc" id="L2905">                                nu--;</span>
<span class="nc" id="L2906">                                Object tr = targets.get(nu);</span>
<span class="nc" id="L2907">                                List&lt;Object&gt; targ2 = new LinkedList&lt;&gt;(targets);</span>
<span class="nc" id="L2908">                                targets.clear();</span>
<span class="nc" id="L2909">                                targets.add(tr);</span>
<span class="nc" id="L2910">                                targ2.remove(tr);</span>

<span class="nc bnc" id="L2912" title="All 2 branches missed.">                                if(!targ2.isEmpty()) {</span>
<span class="nc" id="L2913">                                    sendToClient(&quot;CHOOSEANOTHER&quot;);</span>
<span class="nc" id="L2914">                                    String rsp = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L2915" title="All 2 branches missed.">                                    if (rsp.toUpperCase().equals(&quot;Y&quot;)) {</span>
<span class="nc" id="L2916">                                        sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L2917">                                        sendListToClient(fromTargetsToNames(targ2)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2918">                                        int xpo = (int) inputStream.readObject();</span>
<span class="nc" id="L2919">                                        xpo--;</span>
<span class="nc" id="L2920">                                        targets.add(targ2.get(xpo));</span>
                                    }
<span class="nc" id="L2922">                                    w.applyDamage(targets, p, e);</span>
<span class="nc" id="L2923">                                    useTargetingScope(p, targets);</span>
                                }
<span class="nc" id="L2925">                            }else{</span>
<span class="nc" id="L2926">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2927">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L2928">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L2929">                                return new LinkedList&lt;&gt;();</span>
                            }
<span class="nc" id="L2931">                            lock.unlock();</span>
<span class="nc" id="L2932">                            return targets;             //SAVE THEM AS FIRST IN PASTTARGETS</span>
                        }
                        // SHOOT AGAIN ONE OF THEM -OP1 FROM PASTTARGETS
<span class="nc bnc" id="L2935" title="All 4 branches missed.">                        if(!pastTargets.isEmpty() &amp;&amp; e.getEffect()== AmmoCube.Effect.OP1){</span>
<span class="nc bnc" id="L2936" title="All 4 branches missed.">                            if(e.getNumber()==2 &amp;&amp; pastTargets.size()==2){  // NOTHING TO SHOOT (OP2 BEFORE OP1)</span>
<span class="nc" id="L2937">                                break;</span>
                            }
<span class="nc bnc" id="L2939" title="All 4 branches missed.">                            if(e.getNumber()==2 &amp;&amp; pastTargets.size()==3){ // OP2 BEFORE OP1</span>
<span class="nc" id="L2940">                                pastTargets.removeAll(Collections.singleton(pastTargets.size() - 1));   // CAN'T DAMAGE AGAIN TARGET FROM OP2</span>
<span class="nc" id="L2941">                                w.applyDamage(pastTargets,p,e); //JUST ONE</span>
<span class="nc" id="L2942">                                useTargetingScope(p,pastTargets);</span>

<span class="nc" id="L2944">                                break;</span>
                            }
<span class="nc bnc" id="L2946" title="All 2 branches missed.">                            if (!pastTargets.isEmpty()) {</span>
<span class="nc" id="L2947">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L2948">                                sendListToClient(fromTargetsToNames(pastTargets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2949">                                int u = (int)inputStream.readObject();</span>
<span class="nc" id="L2950">                                u--;</span>
<span class="nc" id="L2951">                                Object tor = targets.get(u);</span>
<span class="nc" id="L2952">                                targets.clear();</span>
<span class="nc" id="L2953">                                targets.add(tor);</span>
<span class="nc" id="L2954">                                w.applyDamage(targets,p,e);</span>
<span class="nc" id="L2955">                                useTargetingScope(p,targets);</span>
<span class="nc" id="L2956">                            }else{</span>
<span class="nc" id="L2957">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2958">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L2959">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L2960">                                return new LinkedList&lt;&gt;();</span>
                            }
<span class="nc" id="L2962">                            e.setNumber(1);     // IT MEANS THAT I EXECUTED OP1 (PASTTARGETS FROM OP1)</span>
<span class="nc" id="L2963">                            lock.unlock();</span>
<span class="nc" id="L2964">                            return targets;         // SAVE IT AFTER BASE TARGETS</span>
                        }
                        // ASK TO SHOOT THE OTHER OR AND SOMEONE ELSE
<span class="nc bnc" id="L2967" title="All 4 branches missed.">                        if(!pastTargets.isEmpty() &amp;&amp; e.getEffect()== AmmoCube.Effect.OP2) {</span>
<span class="nc" id="L2968">                            List&lt;Object&gt; pastTargets2 = new LinkedList&lt;&gt;(); // NEED IT LATER IF E.NUMBER!=1</span>

<span class="nc bnc" id="L2970" title="All 2 branches missed.">                            if (e.getNumber() == 1) {</span>
                                // CHECK TARGETS OP1 AND OP2 DIFFERENTI
                                // SE PASTTARGETS VUOTO OK, SE PIENO TARGET SCELTO DEVE ESSERE DIVERSO DA QUELLO
<span class="nc" id="L2973">                                pastTargets.removeAll(Collections.singleton(pastTargets.size() - 1));   // CAN'T DAMAGE AGAIN TARGET FROM OP1 (IT'S THE LAST)</span>
                            }
<span class="nc bnc" id="L2975" title="All 2 branches missed.">                            if(!pastTargets.isEmpty()){</span>
                                // SHOOT MAYBE AGAIN TARGET FROM BASE
<span class="nc" id="L2977">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L2978">                                List&lt;String&gt; toSend = fromTargetsToNames(pastTargets);</span>
<span class="nc" id="L2979">                                toSend.add(0, &quot;No, I dont't want these targets&quot;);</span>
<span class="nc" id="L2980">                                sendListToClient(toSend); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L2981">                                int nu = (int) inputStream.readObject();</span>
<span class="nc" id="L2982">                                nu--;</span>
<span class="nc bnc" id="L2983" title="All 2 branches missed.">                                if (nu != 0) {</span>
<span class="nc" id="L2984">                                    nu--;</span>
<span class="nc" id="L2985">                                    Object tr = pastTargets.get(nu);</span>
<span class="nc" id="L2986">                                    pastTargets2 = new LinkedList&lt;&gt;(pastTargets);    // ORIGINAL PASTTARGETS (I NEED THEM IF E.NUMBER!=1)</span>
<span class="nc" id="L2987">                                    pastTargets2.add(tr);</span>

<span class="nc" id="L2989">                                    pastTargets.clear();</span>
<span class="nc" id="L2990">                                    pastTargets.add(tr);</span>
<span class="nc" id="L2991">                                    w.applyDamage(pastTargets, p, e);</span>
<span class="nc" id="L2992">                                    useTargetingScope(p,pastTargets);</span>
                                }
<span class="nc" id="L2994">                            } else{</span>
<span class="nc" id="L2995">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L2996">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L2997">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L2998">                                return new LinkedList&lt;&gt;();</span>
                            }
                            // SHOOT MAYBE DIFFERENT TARGET FROM BASE
<span class="nc" id="L3001">                            targets.removeAll(pastTargets);</span>
<span class="nc bnc" id="L3002" title="All 2 branches missed.">                            if (!targets.isEmpty()) {</span>
<span class="nc" id="L3003">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3004">                                List&lt;String&gt; toSend2 = fromTargetsToNames(targets);</span>
<span class="nc" id="L3005">                                toSend2.add(0,&quot;No, I dont't want these targets&quot;);</span>
<span class="nc" id="L3006">                                sendListToClient(toSend2); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3007">                                int nku = (int) inputStream.readObject();</span>
<span class="nc" id="L3008">                                nku--;</span>
<span class="nc bnc" id="L3009" title="All 2 branches missed.">                                if(nku!=0) {</span>
<span class="nc" id="L3010">                                    nku--;</span>
<span class="nc" id="L3011">                                    Object tr = targets.get(nku);</span>
<span class="nc" id="L3012">                                    targets.clear();</span>
<span class="nc" id="L3013">                                    targets.add(tr);</span>
<span class="nc" id="L3014">                                    w.applyDamage(targets, p, e);</span>
<span class="nc" id="L3015">                                    useTargetingScope(p,targets);</span>
                                }

<span class="nc bnc" id="L3018" title="All 2 branches missed.">                                if(e.getNumber()!=1){   // MAYBE OP1 AFTER OP2</span>
<span class="nc" id="L3019">                                    e.setNumber(2);</span>
<span class="nc" id="L3020">                                    lock.unlock();</span>
<span class="nc" id="L3021">                                    return pastTargets2;    // IF SIZE 3 (2 BASE + 1) IF SIZE 2 (1 BASE + 1, SAME TARGET)</span>
                                }
<span class="nc" id="L3023">                            }else{</span>
<span class="nc" id="L3024">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3025">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3026">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L3027">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }
<span class="nc" id="L3030">                        lock.unlock();</span>
<span class="nc" id="L3031">                        break;</span>

<span class="nc" id="L3033">                    case &quot;PlasmaGun&quot;:lock.lock();</span>
<span class="nc bnc" id="L3034" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.BASE) {</span>
<span class="nc" id="L3035">                            cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L3036">                            targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc bnc" id="L3037" title="All 2 branches missed.">                            if (!targets.isEmpty()) {</span>
                                // ASK WHICH 1 TARGET TO DAMAGE, (SAVE IT FOR THE OTHER EFFECT)
<span class="nc" id="L3039">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3040">                                sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3041">                                int i = (int)inputStream.readObject();</span>
<span class="nc" id="L3042">                                i--;</span>
<span class="nc" id="L3043">                                Object tg = targets.get(i);</span>
<span class="nc" id="L3044">                                targets.clear();</span>
<span class="nc" id="L3045">                                targets.add(tg);</span>

<span class="nc" id="L3047">                                w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3048">                                useTargetingScope(p,targets);</span>
<span class="nc" id="L3049">                            }else{</span>
<span class="nc" id="L3050">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3051">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3052">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L3053">                                return new LinkedList&lt;&gt;();</span>
                            }
<span class="nc" id="L3055">                            lock.unlock();</span>
<span class="nc" id="L3056">                            return targets;</span>
                        }
<span class="nc bnc" id="L3058" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.OP2){</span>
<span class="nc bnc" id="L3059" title="All 2 branches missed.">                            if(!pastTargets.isEmpty()) {</span>
<span class="nc" id="L3060">                                targets = new LinkedList&lt;&gt;(pastTargets);</span>
<span class="nc" id="L3061">                                w.applyDamage(targets, p, e);</span>
<span class="nc" id="L3062">                                useTargetingScope(p, targets);</span>
                            }
<span class="nc" id="L3064">                            lock.unlock();</span>
                        }
<span class="nc bnc" id="L3066" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.OP1){</span>
<span class="nc" id="L3067">                            cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc bnc" id="L3068" title="All 2 branches missed.">                            if (!cells.isEmpty()) {</span>
                                // ASK WHERE TO MOVE
<span class="nc" id="L3070">                                sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L3071">                                sendListToClient(fromCellsToNames(cells)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3072">                                int xg = (int)inputStream.readObject();</span>
<span class="nc" id="L3073">                                xg--;</span>
<span class="nc" id="L3074">                                lock.unlock();</span>
<span class="nc" id="L3075">                                p.setPlayerPosition(cells.get(xg));</span>
<span class="nc" id="L3076">                                broadcast(&quot;\n&quot; + p.getName() + &quot; is in &quot;+cells.get(xg).toString());</span>
<span class="nc" id="L3077">                            }else{</span>
<span class="nc" id="L3078">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3079">                                sendToClient(&quot;Sorry there are no cells.&quot;);</span>
<span class="nc" id="L3080">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L3081">                                lock.unlock();</span>
<span class="nc" id="L3082">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }
                        break;

<span class="nc" id="L3087">                    case &quot;PowerGlove&quot;:lock.lock();</span>
<span class="nc bnc" id="L3088" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.BASE) {</span>
<span class="nc" id="L3089">                            cells = w.getPossibleTargetCells(playerPosition, e, g);</span>
<span class="nc" id="L3090">                            targets = w.fromCellsToTargets(cells, playerPosition, g, p, model, e);</span>
<span class="nc bnc" id="L3091" title="All 2 branches missed.">                            if (!targets.isEmpty()) {</span>
                                // ASK WHICH 1 TARGET TO DAMAGE, REMOVE THE OTHERS
<span class="nc" id="L3093">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3094">                                sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3095">                                int xh = (int) inputStream.readObject();</span>
<span class="nc" id="L3096">                                xh--;</span>
<span class="nc" id="L3097">                                Object tt = targets.get(xh);</span>
<span class="nc" id="L3098">                                targets.clear();</span>
<span class="nc" id="L3099">                                targets.add(tt);</span>

<span class="nc" id="L3101">                                w.applyDamage(targets, p, e);</span>
<span class="nc" id="L3102">                                useTargetingScope(p, targets);</span>

                                // MOVE PLAYER TO TARGET'S SQUARE
<span class="nc" id="L3105">                                action.run(p, ((Player) tt).getCoordinatesWithRooms());</span>
<span class="nc" id="L3106">                                lock.unlock();</span>
<span class="nc" id="L3107">                                broadcast(&quot;\n&quot; + p.getName() + &quot; moved to &quot;+((Player)tt).getCoordinatesWithRooms());</span>
<span class="nc" id="L3108">                            }else{</span>
<span class="nc" id="L3109">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3110">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3111">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L3112">                                lock.unlock();</span>
<span class="nc" id="L3113">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }
                        // ALSO IF ALT
<span class="nc bnc" id="L3117" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.ALT) {</span>
<span class="nc" id="L3118">                            CoordinatesWithRoom c0 = playerPosition; // SAVED PLAYER'S POSITION</span>
<span class="nc" id="L3119">                            cells = w.getPossibleTargetCells(playerPosition, e, g);</span>
<span class="nc bnc" id="L3120" title="All 2 branches missed.">                            if (!cells.isEmpty()) {</span>
<span class="nc" id="L3121">                                sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L3122">                                sendListToClient(fromCellsToNames(cells)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3123">                                int xpf = (int) inputStream.readObject();</span>
<span class="nc" id="L3124">                                xpf--;</span>
<span class="nc" id="L3125">                                action.run(p, cells.get(xpf));</span>
<span class="nc" id="L3126">                                broadcast(&quot;\n&quot; + p.getName() + &quot; moved to &quot;+cells.get(xpf).toString());</span>

<span class="nc" id="L3128">                                CoordinatesWithRoom cc = cells.get(xpf);</span>
<span class="nc" id="L3129">                                cells.clear();</span>
<span class="nc" id="L3130">                                cells.add(cc);</span>

<span class="nc" id="L3132">                                targets = w.fromCellsToTargets(cells, playerPosition, g, p, model, e);</span>
<span class="nc bnc" id="L3133" title="All 2 branches missed.">                                if (!targets.isEmpty()) {</span>
<span class="nc" id="L3134">                                    sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3135">                                    List&lt;String&gt; toSend = fromTargetsToNames(targets);</span>
<span class="nc" id="L3136">                                    toSend.add(0, &quot;No, I dont't want these targets&quot;);</span>
<span class="nc" id="L3137">                                    sendListToClient(toSend); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3138">                                    int nu = (int) inputStream.readObject();</span>
<span class="nc" id="L3139">                                    nu--;</span>
<span class="nc bnc" id="L3140" title="All 2 branches missed.">                                    if (nu != 0) {</span>
<span class="nc" id="L3141">                                        nu--;</span>
<span class="nc" id="L3142">                                        Object ttt = targets.get(nu);</span>
<span class="nc" id="L3143">                                        targets.clear();</span>
<span class="nc" id="L3144">                                        targets.add(ttt);</span>

<span class="nc" id="L3146">                                        w.applyDamage(targets, p, e);</span>
<span class="nc" id="L3147">                                        useTargetingScope(p, targets);</span>

<span class="nc" id="L3149">                                        CoordinatesWithRoom c2 = c0.getNextCell(c0,cc,g, false);</span>
<span class="nc bnc" id="L3150" title="All 4 branches missed.">                                        if(c2.getX()==0 || c2.getY()==0){</span>
<span class="nc" id="L3151">                                            lock.unlock();</span>
<span class="nc" id="L3152">                                            return new LinkedList&lt;&gt;();</span>
                                        }
<span class="nc" id="L3154">                                        cells.clear();</span>
<span class="nc" id="L3155">                                        cells.add(c2);</span>

<span class="nc" id="L3157">                                        toSend.clear();</span>
<span class="nc" id="L3158">                                        toSend = fromCellsToNames(cells);</span>
<span class="nc" id="L3159">                                        toSend.add(0, &quot;No, I dont't want to move there&quot;);</span>
<span class="nc" id="L3160">                                        sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L3161">                                        sendListToClient(toSend); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3162">                                        int xif = (int) inputStream.readObject();</span>
<span class="nc" id="L3163">                                        xif--;</span>
<span class="nc bnc" id="L3164" title="All 2 branches missed.">                                        if(xif!=0) {</span>
<span class="nc" id="L3165">                                            xif--;</span>
<span class="nc" id="L3166">                                            action.run(p, c2);</span>
<span class="nc" id="L3167">                                            lock.unlock();</span>
<span class="nc" id="L3168">                                            broadcast(&quot;\n&quot; + p.getName() + &quot; moved to &quot;+c2.toString());</span>
<span class="nc" id="L3169">                                            lock.lock();</span>
<span class="nc" id="L3170">                                            targets = w.fromCellsToTargets(cells, playerPosition, g, p, model, e);</span>
<span class="nc bnc" id="L3171" title="All 2 branches missed.">                                            if (!targets.isEmpty()) {</span>
<span class="nc" id="L3172">                                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3173">                                                toSend.clear();</span>
<span class="nc" id="L3174">                                                toSend = fromTargetsToNames(targets);</span>
<span class="nc" id="L3175">                                                toSend.add(0, &quot;No, I dont't want these targets&quot;);</span>
<span class="nc" id="L3176">                                                sendListToClient(toSend); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3177">                                                int nur = (int) inputStream.readObject();</span>
<span class="nc" id="L3178">                                                nur--;</span>
<span class="nc bnc" id="L3179" title="All 2 branches missed.">                                                if (nur != 0) {</span>
<span class="nc" id="L3180">                                                    nur--;</span>
<span class="nc" id="L3181">                                                    Object trtt = targets.get(nur);</span>
<span class="nc" id="L3182">                                                    targets.clear();</span>
<span class="nc" id="L3183">                                                    targets.add(trtt);</span>

<span class="nc" id="L3185">                                                    w.applyDamage(targets, p, e);</span>
<span class="nc" id="L3186">                                                    useTargetingScope(p, targets);</span>
                                                }
<span class="nc" id="L3188">                                            }else{</span>
<span class="nc" id="L3189">                                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3190">                                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3191">                                                return new LinkedList&lt;&gt;();</span>
                                            }
                                        }
                                    }
<span class="nc" id="L3195">                                }else{</span>
<span class="nc" id="L3196">                                    sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3197">                                    sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3198">                                    numberofActionsMinusOne(w);</span>
<span class="nc" id="L3199">                                    return new LinkedList&lt;&gt;();</span>
                                }
<span class="nc" id="L3201">                            }else{</span>
<span class="nc" id="L3202">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3203">                                sendToClient(&quot;Sorry there are no cells.&quot;);</span>
<span class="nc" id="L3204">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L3205">                                return new LinkedList&lt;&gt;();</span>
                            }
<span class="nc" id="L3207">                        }</span>
                        break;

<span class="nc" id="L3210">                    case &quot;Railgun&quot;:lock.lock();</span>
<span class="nc" id="L3211">                        cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L3212">                        targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>

                        // ASK TO CHOOSE 1 (BASE) OR 1-2 (ALT) TARGETS, REMOVE OTHERS
<span class="nc bnc" id="L3215" title="All 2 branches missed.">                        if (!targets.isEmpty()) {</span>
                            // ASK WHICH 1 TARGET TO DAMAGE
<span class="nc" id="L3217">                            sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3218">                            sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3219">                            int i = (int)inputStream.readObject();</span>
<span class="nc" id="L3220">                            i--;</span>
<span class="nc" id="L3221">                            Object tg = targets.get(i);</span>
<span class="nc" id="L3222">                            List&lt;Object&gt; targets3 = new LinkedList&lt;&gt;(targets);</span>
<span class="nc" id="L3223">                            targets.clear();</span>
<span class="nc" id="L3224">                            targets.add(tg);</span>

                            // ASK IF WANT ANOTHER TARGET IF ALT EFFECT
<span class="nc bnc" id="L3227" title="All 2 branches missed.">                            if(e.getEffect()== AmmoCube.Effect.ALT) {</span>
<span class="nc" id="L3228">                                targets3.remove(tg);</span>
<span class="nc bnc" id="L3229" title="All 2 branches missed.">                                if (!targets3.isEmpty()) {</span>
<span class="nc" id="L3230">                                    sendToClient(&quot;CHOOSEANOTHER&quot;);</span>
<span class="nc" id="L3231">                                    String rsp = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L3232" title="All 2 branches missed.">                                    if (rsp.toUpperCase().equals(&quot;Y&quot;)) {</span>
<span class="nc" id="L3233">                                        sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3234">                                        sendListToClient(fromTargetsToNames(targets3)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3235">                                        int xeo = (int) inputStream.readObject();</span>
<span class="nc" id="L3236">                                        xeo--;</span>
<span class="nc" id="L3237">                                        targets.add(targets3.get(xeo));</span>
                                    }
<span class="nc" id="L3239">                                }else{</span>
<span class="nc" id="L3240">                                    sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3241">                                    sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3242">                                    return new LinkedList&lt;&gt;();</span>
                                }
                            }
<span class="nc bnc" id="L3245" title="All 4 branches missed.">                            if(e.getEffect()== AmmoCube.Effect.ALT &amp;&amp; targets.size()==2 &amp;&amp;</span>

<span class="nc bnc" id="L3247" title="All 2 branches missed.">                                    !playerPosition.checkSameDirection(((Player)targets.get(0)).getCoordinatesWithRooms(),((Player)targets.get(1)).getCoordinatesWithRooms(),10,g,false)){</span>
                                // 2 TARGETS OF ALT EFFECT HAVE TO BE IN THE SAME DIRECTION!!!!!
                                // IF checkSameDirection FALSE REMOVE SECOND TARGET
<span class="nc" id="L3250">                                targets.remove(1);</span>
                            }
<span class="nc" id="L3252">                            w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3253">                            useTargetingScope(p,targets);</span>
<span class="nc" id="L3254">                        }else{</span>
<span class="nc" id="L3255">                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3256">                            sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3257">                            numberofActionsMinusOne(w);</span>
<span class="nc" id="L3258">                            return new LinkedList&lt;&gt;();</span>
                        }
<span class="nc" id="L3260">                        lock.unlock();</span>
<span class="nc" id="L3261">                        break;</span>

<span class="nc" id="L3263">                    case &quot;RocketLauncher&quot;: lock.lock();</span>
<span class="nc bnc" id="L3264" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.BASE) {</span>
                            // ASK 1 TARGET (SAVE IT - POSITION - FOR OP2 EFFECT)
<span class="nc bnc" id="L3266" title="All 2 branches missed.">                            if(pastTargets.isEmpty()){  // PRIMA BASE- SE NON VIENE PASSATO NULLA RITORNA IL GIOCATORE COLPITO</span>

<span class="nc" id="L3268">                                cells = w.getPossibleTargetCells(playerPosition,e,g);</span>

                            }else{// PRIMA OP2- SE GLI PASSANO UN GIOCATORE ALLORA PRENDI LA SUA POS,
                                // METTILA IN CELLS TO TARGETS, FAI SCEGLIERE UN TARGET E COLPISCILO E MUOVI SE VUOI
<span class="nc" id="L3272">                                cells = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L3273">                                cells.add(((Player)pastTargets.get(0)).getCoordinatesWithRooms());</span>
                            }
<span class="nc" id="L3275">                            targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc bnc" id="L3276" title="All 2 branches missed.">                            if (!targets.isEmpty()) {</span>
                                // ASK WHICH 1 TARGET TO DAMAGE, REMOVE THE OTHERS
<span class="nc" id="L3278">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3279">                                sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3280">                                int n = (int)inputStream.readObject();</span>
<span class="nc" id="L3281">                                n--;</span>
<span class="nc" id="L3282">                                Object oj = targets.get(n);</span>
<span class="nc" id="L3283">                                targets.clear();</span>
<span class="nc" id="L3284">                                targets.add(oj);</span>

<span class="nc" id="L3286">                                w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3287">                                useTargetingScope(p,targets);</span>

                                // ASK IF MOVE TARGET 1 SQUARE IF PRIMA BASE
<span class="nc" id="L3290">                                sendToClient(&quot;MOVETARGET&quot;);</span>
<span class="nc" id="L3291">                                String rs = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L3292" title="All 2 branches missed.">                                if (rs.toUpperCase().equals(&quot;Y&quot;)) {</span>
<span class="nc" id="L3293">                                    CoordinatesWithRoom ctarget = ((Player)oj).getCoordinatesWithRooms();</span>
<span class="nc" id="L3294">                                    List&lt;CoordinatesWithRoom&gt; one = ctarget.oneTileDistant(g, false);</span>
<span class="nc bnc" id="L3295" title="All 2 branches missed.">                                    if (!one.isEmpty()) {</span>
<span class="nc" id="L3296">                                        sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L3297">                                        sendListToClient(fromCellsToNames(one)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3298">                                        int xf = (int) inputStream.readObject();</span>
<span class="nc" id="L3299">                                        xf--;</span>
<span class="nc" id="L3300">                                        ((Player) targets.get(0)).setPlayerPosition(one.get(xf));</span>
<span class="nc" id="L3301">                                        lock.unlock();</span>
<span class="nc" id="L3302">                                        broadcast(&quot;\n&quot; + ((Player) targets.get(0)).getName() + &quot; is in &quot;+one.get(xf).toString());</span>

<span class="nc" id="L3304">                                        w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3305">                                        useTargetingScope(p,targets);</span>

                                        // IF PRIMA BASE RETURN OLD TARGET POSITION (AS SECOND PLAYER) BEFORE MOVING IT
<span class="nc" id="L3308">                                        Player pp = new Player();</span>
<span class="nc" id="L3309">                                        pp.setPlayerPosition(ctarget);</span>
<span class="nc" id="L3310">                                        broadcast(&quot;\n&quot; + pp.getName() + &quot; is in &quot;+ctarget);</span>
<span class="nc" id="L3311">                                        targets.add(pp);</span>
<span class="nc" id="L3312">                                    }else{</span>
<span class="nc" id="L3313">                                        sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3314">                                        sendToClient(&quot;Sorry there are no cells.&quot;);</span>
<span class="nc" id="L3315">                                        numberofActionsMinusOne(w);</span>
<span class="nc" id="L3316">                                        return new LinkedList&lt;&gt;();</span>
                                    }
<span class="nc" id="L3318">                                    return targets;</span>
                                }
<span class="nc" id="L3320">                            }else{</span>
<span class="nc" id="L3321">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3322">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3323">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L3324">                                return new LinkedList&lt;&gt;();</span>
                            }

                        }
<span class="nc bnc" id="L3328" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.OP2) {</span>
<span class="nc bnc" id="L3329" title="All 2 branches missed.">                            if(pastTargets.isEmpty()) { // PRIMA OP2- (NULLA PASSATO) SCEGLI UNA CELLA, COLPISCILI E POI RITORNA LA CELLA (COME GIOCATORE)</span>
<span class="nc" id="L3330">                                cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
                                // CHIEDI 1 CELLA, COLPISCILI, RITORNA CELLA COME GIOCATORE
<span class="nc bnc" id="L3332" title="All 2 branches missed.">                                if (!cells.isEmpty()) {</span>
<span class="nc" id="L3333">                                    sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L3334">                                    sendListToClient(fromCellsToNames(cells)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3335">                                    int xg = (int)inputStream.readObject();</span>
<span class="nc" id="L3336">                                    xg--;</span>
<span class="nc" id="L3337">                                    CoordinatesWithRoom d = cells.get(xg);</span>
<span class="nc" id="L3338">                                    cells.clear();</span>
<span class="nc" id="L3339">                                    cells.add(d);</span>
<span class="nc" id="L3340">                                    targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc" id="L3341">                                    w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3342">                                    useTargetingScope(p,targets);</span>

<span class="nc" id="L3344">                                    Player p2 = new Player();</span>
<span class="nc" id="L3345">                                    p2.setPlayerPosition(d);</span>
<span class="nc" id="L3346">                                    lock.unlock();</span>
<span class="nc" id="L3347">                                    broadcast(&quot;\n&quot; + p2.getName() + &quot; is in &quot;+d.toString());</span>
<span class="nc" id="L3348">                                    List&lt;Object&gt; lis7 = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L3349">                                    lis7.add(p2);</span>
<span class="nc" id="L3350">                                    lock.unlock();</span>
<span class="nc" id="L3351">                                    return lis7;</span>
                                }else{
<span class="nc" id="L3353">                                    sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3354">                                    sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3355">                                    numberofActionsMinusOne(w);</span>
<span class="nc" id="L3356">                                    lock.unlock();</span>
<span class="nc" id="L3357">                                    return new LinkedList&lt;&gt;();</span>
                                }

                            }else{  // PRIMA BASE- PRENDI POSIZIONE VECCHIA DI TARGET (PASSATA COME GIOCATORE)
<span class="nc" id="L3361">                                cells = w.getPossibleTargetCells(((Player)pastTargets.get(1)).getCoordinatesWithRooms(),e,g);</span>
<span class="nc" id="L3362">                                targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc bnc" id="L3363" title="All 2 branches missed.">                                if(!targets.contains(pastTargets.get(0))){</span>
<span class="nc" id="L3364">                                    targets.add(pastTargets.get(0));    // OLD TARGET ALSO DAMAGED</span>
                                }
<span class="nc" id="L3366">                                w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3367">                                useTargetingScope(p,targets);</span>
<span class="nc" id="L3368">                                lock.unlock();</span>
                            }
                        }
<span class="nc bnc" id="L3371" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.OP1){</span>
<span class="nc" id="L3372">                            cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc bnc" id="L3373" title="All 2 branches missed.">                            if (!cells.isEmpty()) {</span>
                                // ASK WHERE TO MOVE
<span class="nc" id="L3375">                                sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L3376">                                sendListToClient(fromCellsToNames(cells)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3377">                                int xg = (int)inputStream.readObject();</span>
<span class="nc" id="L3378">                                xg--;</span>
<span class="nc" id="L3379">                                p.setPlayerPosition(cells.get(xg));</span>
<span class="nc" id="L3380">                                lock.unlock();</span>
<span class="nc" id="L3381">                                broadcast(&quot;\n&quot; + p.getName() + &quot; is in &quot;+cells.get(xg).toString());</span>
<span class="nc" id="L3382">                            }else{</span>
<span class="nc" id="L3383">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3384">                                sendToClient(&quot;Sorry there are no cells.&quot;);</span>
<span class="nc" id="L3385">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L3386">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }
                        break;

                    case &quot;Shockwave&quot;:
<span class="nc" id="L3392">                        lock.lock();</span>
<span class="nc bnc" id="L3393" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.BASE) {</span>
<span class="nc" id="L3394">                            cells = w.getPossibleTargetCells(playerPosition, e, g);</span>
<span class="nc" id="L3395">                            targets = w.fromCellsToTargets(cells, playerPosition, g, p, model, e);</span>

<span class="nc bnc" id="L3397" title="All 2 branches missed.">                            if (!targets.isEmpty()) {</span>

                                // ASK WHICH TARGETS TO DAMAGE - UP TO 3
<span class="nc" id="L3400">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3401">                                sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3402">                                int nm = (int) inputStream.readObject();</span>
<span class="nc" id="L3403">                                nm--;</span>
<span class="nc" id="L3404">                                Object ot = targets.get(nm);</span>
<span class="nc" id="L3405">                                List&lt;Object&gt; list2 = new LinkedList&lt;&gt;(targets);</span>
<span class="nc" id="L3406">                                targets.clear();</span>
<span class="nc" id="L3407">                                targets.add(ot);</span>
<span class="nc" id="L3408">                                list2.remove(ot);</span>

<span class="nc bnc" id="L3410" title="All 2 branches missed.">                                for (int v = 0; v &lt; 2; v++) {</span>
<span class="nc" id="L3411">                                    sendToClient(&quot;CHOOSEANOTHER&quot;);</span>
<span class="nc" id="L3412">                                    String rs = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L3413" title="All 2 branches missed.">                                    if (rs.toUpperCase().equals(&quot;Y&quot;)) {</span>
<span class="nc bnc" id="L3414" title="All 2 branches missed.">                                        if (!list2.isEmpty()) {</span>
<span class="nc" id="L3415">                                            sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3416">                                            sendListToClient(fromTargetsToNames(list2)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3417">                                            int ye = (int) inputStream.readObject();</span>
<span class="nc" id="L3418">                                            ye--;</span>
<span class="nc" id="L3419">                                            targets.add(list2.get(ye));</span>
<span class="nc" id="L3420">                                            list2.remove(ye);</span>
<span class="nc" id="L3421">                                        }else{</span>
<span class="nc" id="L3422">                                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3423">                                            sendToClient(&quot;Sorry there are no more targets.&quot;);</span>

<span class="nc" id="L3425">                                            w.applyDamage(targets, p, e);</span>
<span class="nc" id="L3426">                                            useTargetingScope(p, targets);</span>
<span class="nc" id="L3427">                                            return new LinkedList&lt;&gt;();</span>
                                        }
                                    } else {
                                        break;
                                    }
                                }
<span class="nc" id="L3433">                                boolean ok = false;</span>
<span class="nc bnc" id="L3434" title="All 4 branches missed.">                                while (!ok || !targets.isEmpty()) {</span>
<span class="nc bnc" id="L3435" title="All 2 branches missed.">                                    if ((targets.size() == 3 &amp;&amp;</span>
<span class="nc bnc" id="L3436" title="All 2 branches missed.">                                            !((Player) targets.get(0)).getCoordinatesWithRooms().equals(((Player) targets.get(1)).getCoordinatesWithRooms())</span>
<span class="nc bnc" id="L3437" title="All 2 branches missed.">                                            &amp;&amp; !((Player) targets.get(0)).getCoordinatesWithRooms().equals(((Player) targets.get(2)).getCoordinatesWithRooms())</span>
<span class="nc bnc" id="L3438" title="All 2 branches missed.">                                            &amp;&amp; !((Player) targets.get(1)).getCoordinatesWithRooms().equals(((Player) targets.get(2)).getCoordinatesWithRooms())) ||</span>
<span class="nc bnc" id="L3439" title="All 2 branches missed.">                                            (targets.size() == 2 &amp;&amp;</span>
<span class="nc bnc" id="L3440" title="All 2 branches missed.">                                                    !((Player) targets.get(0)).getCoordinatesWithRooms().equals(((Player) targets.get(1)).getCoordinatesWithRooms())</span>
                                            )) {
<span class="nc" id="L3442">                                        ok = true;</span>
                                    } else {    // SE SBAGLIA TOLGO I TARGET E BASTA
<span class="nc bnc" id="L3444" title="All 2 branches missed.">                                        if (targets.size() == 2) {</span>
<span class="nc" id="L3445">                                            targets.remove(1);</span>
                                        }
<span class="nc bnc" id="L3447" title="All 2 branches missed.">                                        if (targets.size() == 3) {</span>
<span class="nc" id="L3448">                                            targets.remove(2);</span>
                                        }
                                    }
                                }
<span class="nc" id="L3452">                                w.applyDamage(targets, p, e);</span>
<span class="nc" id="L3453">                                useTargetingScope(p, targets);</span>

<span class="nc" id="L3455">                            }else{</span>
<span class="nc" id="L3456">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3457">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3458">                                numberofActionsMinusOne(w);</span>
                                //return Collections.emptyList();
<span class="nc" id="L3460">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }
<span class="nc bnc" id="L3463" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.ALT) {</span>
<span class="nc" id="L3464">                            cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L3465">                            targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc" id="L3466">                            w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3467">                            useTargetingScope(p,targets);</span>
                        }
<span class="nc" id="L3469">                        lock.unlock();</span>
<span class="nc" id="L3470">                        break;</span>

<span class="nc" id="L3472">                    case &quot;Shotgun&quot;:lock.lock();</span>
<span class="nc" id="L3473">                        cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L3474">                        targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc bnc" id="L3475" title="All 2 branches missed.">                        if (!targets.isEmpty()) {</span>
                            // ASK WHICH 1 TARGET TO DAMAGE
<span class="nc" id="L3477">                            sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3478">                            sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3479">                            int nm = (int)inputStream.readObject();</span>
<span class="nc" id="L3480">                            nm--;</span>
<span class="nc" id="L3481">                            Object ot = targets.get(nm);</span>
<span class="nc" id="L3482">                            targets.clear();</span>
<span class="nc" id="L3483">                            targets.add(ot);</span>

<span class="nc" id="L3485">                            w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3486">                            useTargetingScope(p,targets);</span>

<span class="nc bnc" id="L3488" title="All 2 branches missed.">                            if(e.getEffect()== AmmoCube.Effect.BASE) {</span>
                                // ASK -IF- THEY WANT TO MOVE THAT TARGET 1 SQUARE
<span class="nc" id="L3490">                                sendToClient(&quot;MOVETARGET&quot;);</span>
<span class="nc" id="L3491">                                String rs = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L3492" title="All 2 branches missed.">                                if (rs.toUpperCase().equals(&quot;Y&quot;)) {</span>

<span class="nc" id="L3494">                                    List&lt;CoordinatesWithRoom&gt; one = playerPosition.oneTileDistant(g,false);</span>
<span class="nc bnc" id="L3495" title="All 2 branches missed.">                                    if (!one.isEmpty()) {</span>
<span class="nc" id="L3496">                                        sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L3497">                                        sendListToClient(fromCellsToNames(one)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3498">                                        int xf = (int)inputStream.readObject();</span>
<span class="nc" id="L3499">                                        xf--;</span>
<span class="nc" id="L3500">                                        ((Player)targets.get(0)).setPlayerPosition(one.get(xf));</span>
<span class="nc" id="L3501">                                        lock.unlock();</span>
<span class="nc" id="L3502">                                        broadcast(&quot;\n&quot; + ((Player)targets.get(0)).getName() + &quot; is in &quot;+one.get(xf).toString());</span>
<span class="nc" id="L3503">                                    }else{</span>
<span class="nc" id="L3504">                                        sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3505">                                        sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3506">                                        lock.unlock();</span>
<span class="nc" id="L3507">                                        return new LinkedList&lt;&gt;();</span>
                                    }
                                }
                            }
<span class="nc" id="L3511">                        }else{</span>
<span class="nc" id="L3512">                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3513">                            sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3514">                            numberofActionsMinusOne(w);</span>
<span class="nc" id="L3515">                            return new LinkedList&lt;&gt;();</span>
                        }
                        break;

<span class="nc" id="L3519">                    case &quot;Sledgehammer&quot;:lock.lock();</span>
<span class="nc" id="L3520">                        cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L3521">                        targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc bnc" id="L3522" title="All 2 branches missed.">                        if (!targets.isEmpty()) {</span>
                            // ASK WHICH 1 TARGET TO DAMAGE
<span class="nc" id="L3524">                            sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3525">                            sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3526">                            int num = (int)inputStream.readObject();</span>
<span class="nc" id="L3527">                            num--;</span>
<span class="nc" id="L3528">                            Object ojt = targets.get(num);</span>
<span class="nc" id="L3529">                            targets.clear();</span>
<span class="nc" id="L3530">                            targets.add(ojt);</span>
<span class="nc" id="L3531">                            w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3532">                            useTargetingScope(p,targets);</span>

<span class="nc bnc" id="L3534" title="All 2 branches missed.">                            if(e.getEffect()== AmmoCube.Effect.ALT) {</span>
                                // ASK TO MOVE THAT TARGET 0-1-2 SQUARE SAME DIRECTION
<span class="nc" id="L3536">                                List&lt;CoordinatesWithRoom&gt; possibleCells = playerPosition.tilesSameDirection(2,g,false);</span>
<span class="nc bnc" id="L3537" title="All 2 branches missed.">                                if (!possibleCells.isEmpty()) {</span>
<span class="nc" id="L3538">                                    sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L3539">                                    sendListToClient(fromCellsToNames(possibleCells)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3540">                                    int xj = (int)inputStream.readObject();</span>
<span class="nc" id="L3541">                                    xj--;</span>
<span class="nc" id="L3542">                                    ((Player)targets.get(0)).setPlayerPosition(possibleCells.get(xj));</span>
<span class="nc" id="L3543">                                    lock.unlock();</span>
<span class="nc" id="L3544">                                    broadcast(&quot;\n&quot; + ((Player)targets.get(0)).getName() + &quot; is in &quot;+possibleCells.get(xj).toString());</span>
<span class="nc" id="L3545">                                }else{</span>
<span class="nc" id="L3546">                                    sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3547">                                    sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3548">                                    numberofActionsMinusOne(w);</span>
<span class="nc" id="L3549">                                    return new LinkedList&lt;&gt;();</span>
                                }
                            }
<span class="nc" id="L3552">                        }else{</span>
<span class="nc" id="L3553">                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3554">                            sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3555">                            numberofActionsMinusOne(w);</span>
<span class="nc" id="L3556">                            return new LinkedList&lt;&gt;();</span>
                        }
<span class="nc" id="L3558">                        lock.unlock();</span>
<span class="nc" id="L3559">                        break;</span>

<span class="nc" id="L3561">                    case &quot;Thor&quot;:lock.lock();</span>
<span class="nc" id="L3562">                        cells = new LinkedList&lt;&gt;();</span>

<span class="nc bnc" id="L3564" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.BASE) {</span>
<span class="nc" id="L3565">                            cells = w.getPossibleTargetCells(playerPosition, e, g);</span>
                        }

<span class="nc bnc" id="L3568" title="All 4 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.OP1 || e.getEffect()== AmmoCube.Effect.OP2) {</span>
<span class="nc bnc" id="L3569" title="All 2 branches missed.">                            if(!pastTargets.isEmpty()) {</span>
                                // PUT HERE TARGET'S POSITION, GLIEL'HA PASSATA
<span class="nc" id="L3571">                                CoordinatesWithRoom targetPos = ((Player) pastTargets.get(0)).getCoordinatesWithRooms();</span>
<span class="nc" id="L3572">                                cells = w.getPossibleTargetCells(targetPos, e, g);</span>
<span class="nc" id="L3573">                            }else {</span>
<span class="nc" id="L3574">                                return new LinkedList&lt;&gt;();</span>
                            }

                        }
<span class="nc" id="L3578">                        targets = w.fromCellsToTargets(cells, playerPosition, g, p, model, e);</span>
<span class="nc bnc" id="L3579" title="All 2 branches missed.">                        if (!targets.isEmpty()) {</span>
                            // ASK WHICH 1 TARGET TO DAMAGE, REMOVE THE OTHERS
<span class="nc" id="L3581">                            sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3582">                            sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3583">                            int nr = (int)inputStream.readObject();</span>
<span class="nc" id="L3584">                            nr--;</span>
<span class="nc" id="L3585">                            Object oc = targets.get(nr);</span>
<span class="nc" id="L3586">                            targets.clear();</span>
<span class="nc" id="L3587">                            targets.add(oc);</span>
<span class="nc" id="L3588">                            w.applyDamage(targets, p, e);</span>
<span class="nc" id="L3589">                            useTargetingScope(p,targets);</span>
                            // RETURN THE TARGET (YOU'LL NEED TO CHECK THEY ARE DIFFERENT)
<span class="nc" id="L3591">                        }else{</span>
<span class="nc" id="L3592">                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3593">                            sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3594">                            numberofActionsMinusOne(w);</span>
<span class="nc" id="L3595">                            return new LinkedList&lt;&gt;();</span>
                        }
<span class="nc" id="L3597">                        lock.unlock();</span>
<span class="nc" id="L3598">                        return targets;</span>

<span class="nc" id="L3600">                    case &quot;TractorBeam&quot;:lock.lock();</span>
<span class="nc bnc" id="L3601" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.BASE) {</span>
<span class="nc" id="L3602">                            cells = w.getPossibleTargetCells(playerPosition,e,g);   // CELLS I SEE</span>
<span class="nc" id="L3603">                            targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);   // TARGETS DISTANTI MAX 2 DA CIò CHE VEDO(cioè che posso muovere)</span>
<span class="nc bnc" id="L3604" title="All 2 branches missed.">                            if (!targets.isEmpty()) {</span>
                                // ASK WHICH 1 TARGET TO DAMAGE, REMOVE THE OTHERS
<span class="nc" id="L3606">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3607">                                sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3608">                                int xy = (int)inputStream.readObject();</span>
<span class="nc" id="L3609">                                xy--;</span>
<span class="nc" id="L3610">                                Object trg = targets.get(xy);</span>
<span class="nc" id="L3611">                                targets.clear();</span>
<span class="nc" id="L3612">                                targets.add(trg);</span>

<span class="nc" id="L3614">                                CoordinatesWithRoom c1 = ((Player)trg).getCoordinatesWithRooms(); // SALVACI LA POS DEL TARGET</span>
<span class="nc" id="L3615">                                LinkedList&lt;CoordinatesWithRoom&gt; listOne = new LinkedList&lt;&gt;();</span>
                                List&lt;CoordinatesWithRoom&gt; listMoves;    // TARGET'S POSSIBLE MOVES

<span class="nc" id="L3618">                                listMoves = c1.oneTileDistant(g, false);</span>
<span class="nc" id="L3619">                                listMoves.addAll(c1.xTilesDistant(g, 2));</span>
<span class="nc" id="L3620">                                listMoves.add(c1);</span>
<span class="nc bnc" id="L3621" title="All 2 branches missed.">                                for(CoordinatesWithRoom c3: listMoves) {</span>
<span class="nc bnc" id="L3622" title="All 2 branches missed.">                                    if (cells.contains(c3)) {</span>
<span class="nc" id="L3623">                                        listOne.add(c3);    // IF I SEE, THEM I ADD THEM</span>
                                        // CHECK CELLS.CONTAINS(A POSSIBLE MOVE)
                                    }
<span class="nc" id="L3626">                                }</span>
<span class="nc bnc" id="L3627" title="All 2 branches missed.">                                if (!listOne.isEmpty()) {</span>
                                    // ASK WHERE TO MOVE
<span class="nc" id="L3629">                                    sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L3630">                                    sendListToClient(fromCellsToNames(listOne)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3631">                                    int xgy = (int)inputStream.readObject();</span>
<span class="nc" id="L3632">                                    xgy--;</span>
<span class="nc" id="L3633">                                    ((Player)trg).setPlayerPosition(listOne.get(xgy));</span>
<span class="nc" id="L3634">                                    lock.unlock();</span>
<span class="nc" id="L3635">                                    broadcast(&quot;\n&quot; + ((Player)trg).getName() + &quot; is in &quot;+listOne.get(xgy).toString());</span>
<span class="nc" id="L3636">                                }else{</span>
<span class="nc" id="L3637">                                    sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3638">                                    sendToClient(&quot;Sorry there are no cells.&quot;);</span>
<span class="nc" id="L3639">                                    lock.unlock();</span>
<span class="nc" id="L3640">                                    return new LinkedList&lt;&gt;();</span>
                                }
<span class="nc" id="L3642">                                w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3643">                                useTargetingScope(p,targets);</span>
<span class="nc" id="L3644">                            }else{</span>
<span class="nc" id="L3645">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3646">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3647">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L3648">                                lock.unlock();</span>
<span class="nc" id="L3649">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }
<span class="nc bnc" id="L3652" title="All 2 branches missed.">                        if(e.getEffect()== AmmoCube.Effect.ALT) {</span>
<span class="nc" id="L3653">                            cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L3654">                            targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc bnc" id="L3655" title="All 2 branches missed.">                            if (!targets.isEmpty()) {</span>
                                // ASK WHICH 1 TARGET TO DAMAGE, REMOVE THE OTHERS
<span class="nc" id="L3657">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3658">                                sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3659">                                int xz = (int)inputStream.readObject();</span>
<span class="nc" id="L3660">                                xz--;</span>
<span class="nc" id="L3661">                                Object tu = targets.get(xz);</span>
<span class="nc" id="L3662">                                targets.clear();</span>
<span class="nc" id="L3663">                                targets.add(tu);</span>
                                //MOVE IT TO YOUR SQUARE
<span class="nc" id="L3665">                                ((Player)targets.get(0)).setPlayerPosition(playerPosition);</span>
<span class="nc" id="L3666">                                lock.unlock();</span>
<span class="nc" id="L3667">                                broadcast(&quot;\n&quot; + ((Player)targets.get(0)).getName() + &quot; is in &quot;+playerPosition.toString());</span>
<span class="nc" id="L3668">                                w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3669">                                useTargetingScope(p,targets);</span>
<span class="nc" id="L3670">                            }else{</span>
<span class="nc" id="L3671">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3672">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3673">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L3674">                                lock.unlock();</span>
<span class="nc" id="L3675">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }
                        break;

<span class="nc" id="L3680">                    case &quot;VortexCannon&quot;:lock.lock();</span>
<span class="nc" id="L3681">                        cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc bnc" id="L3682" title="All 2 branches missed.">                        if (!cells.isEmpty()) {</span>
                            // CHOOSE A VORTEX
<span class="nc" id="L3684">                            sendToClient(&quot;CHOOSECELL&quot;);</span>
<span class="nc" id="L3685">                            sendListToClient(fromCellsToNames(cells)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3686">                            int xgt = (int)inputStream.readObject();</span>
<span class="nc" id="L3687">                            xgt--;</span>
<span class="nc" id="L3688">                            CoordinatesWithRoom vortex = cells.get(xgt);</span>
                            List&lt;CoordinatesWithRoom&gt; list;
<span class="nc" id="L3690">                            list = vortex.oneTileDistant(g,false);</span>
<span class="nc" id="L3691">                            list.add(vortex);</span>

<span class="nc" id="L3693">                            targets = w.fromCellsToTargets(list,playerPosition,g,p,model,e);</span>
<span class="nc bnc" id="L3694" title="All 2 branches missed.">                            if (!targets.isEmpty()) {</span>
                                // ASK FOR 1 TARGET IF BASE OR UP TO 2 IF OP1
<span class="nc" id="L3696">                                sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3697">                                sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3698">                                int xn = (int)inputStream.readObject();</span>
<span class="nc" id="L3699">                                xn--;</span>
<span class="nc" id="L3700">                                Object ty = targets.get(xn);</span>
<span class="nc" id="L3701">                                List&lt;Object&gt; targets1 = new LinkedList&lt;&gt;(targets);</span>
<span class="nc" id="L3702">                                targets.clear();</span>
<span class="nc" id="L3703">                                targets.add(ty);</span>
<span class="nc" id="L3704">                                targets1.remove(ty);</span>
<span class="nc bnc" id="L3705" title="All 2 branches missed.">                                if(e.getEffect()== AmmoCube.Effect.OP1){</span>
<span class="nc" id="L3706">                                    sendToClient(&quot;CHOOSEANOTHER&quot;);</span>
<span class="nc" id="L3707">                                    String rs = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L3708" title="All 2 branches missed.">                                    if (rs.toUpperCase().equals(&quot;Y&quot;)) {</span>
<span class="nc bnc" id="L3709" title="All 2 branches missed.">                                        if (!targets1.isEmpty()) {</span>
<span class="nc" id="L3710">                                            sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3711">                                            sendListToClient(fromTargetsToNames(targets1)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3712">                                            int ye = (int) inputStream.readObject();</span>
<span class="nc" id="L3713">                                            ye--;</span>
<span class="nc" id="L3714">                                            targets.add(targets1.get(ye));</span>
<span class="nc" id="L3715">                                        }else{</span>
<span class="nc" id="L3716">                                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3717">                                            sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3718">                                            return new LinkedList&lt;&gt;();</span>
                                        }
                                    }
                                }
<span class="nc bnc" id="L3722" title="All 2 branches missed.">                                if(!pastTargets.isEmpty()){</span>
                                    // CHECK DIFFERENTI DA QUELLI PASSATI
<span class="nc bnc" id="L3724" title="All 2 branches missed.">                                    for(Object o : targets){</span>
<span class="nc bnc" id="L3725" title="All 2 branches missed.">                                        for(Object u :pastTargets){</span>
<span class="nc bnc" id="L3726" title="All 2 branches missed.">                                            if(o==u){</span>
<span class="nc" id="L3727">                                                targets.remove(o);</span>
<span class="nc" id="L3728">                                                break;</span>
                                            }
<span class="nc" id="L3730">                                        }</span>
<span class="nc" id="L3731">                                    }</span>
                                }
<span class="nc" id="L3733">                                lock.unlock();</span>
                                // MOVE EVERY TARGET ON THE VORTEX
<span class="nc bnc" id="L3735" title="All 2 branches missed.">                                for(Object o : targets){</span>
<span class="nc" id="L3736">                                    ((Player)o).setPlayerPosition(vortex);</span>
<span class="nc" id="L3737">                                    broadcast(&quot;\n&quot; + ((Player)o).getName() + &quot; is in &quot;+vortex.toString());</span>

<span class="nc" id="L3739">                                }</span>

<span class="nc" id="L3741">                                w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3742">                                useTargetingScope(p,targets);</span>
<span class="nc" id="L3743">                                return targets;</span>
                            }else{
<span class="nc" id="L3745">                                sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3746">                                sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3747">                                numberofActionsMinusOne(w);</span>
<span class="nc" id="L3748">                                return new LinkedList&lt;&gt;();</span>
                            }
                        }else{
<span class="nc" id="L3751">                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3752">                            sendToClient(&quot;Sorry there are no cells.&quot;);</span>
<span class="nc" id="L3753">                            numberofActionsMinusOne(w);</span>
<span class="nc" id="L3754">                            return new LinkedList&lt;&gt;();</span>
                        }


<span class="nc" id="L3758">                    case &quot;Whisper&quot;:lock.lock();</span>
<span class="nc" id="L3759">                        cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L3760">                        targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc bnc" id="L3761" title="All 2 branches missed.">                        if (!targets.isEmpty()) {</span>
                            // ASK WHICH 1 TARGET TO DAMAGE
<span class="nc" id="L3763">                            sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3764">                            sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3765">                            int l = (int)inputStream.readObject();</span>
<span class="nc" id="L3766">                            l--;</span>
<span class="nc" id="L3767">                            Object b = targets.get(l);</span>
<span class="nc" id="L3768">                            targets.clear();</span>
<span class="nc" id="L3769">                            targets.add(b);</span>
<span class="nc" id="L3770">                            w.applyDamage(targets,p,e);</span>
<span class="nc" id="L3771">                            useTargetingScope(p,targets);</span>
<span class="nc" id="L3772">                        }else{</span>
<span class="nc" id="L3773">                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3774">                            sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3775">                            numberofActionsMinusOne(w);</span>
<span class="nc" id="L3776">                            return new LinkedList&lt;&gt;();</span>
                        }
<span class="nc" id="L3778">                        lock.unlock();</span>
<span class="nc" id="L3779">                        break;</span>

<span class="nc" id="L3781">                    case &quot;Zx_2&quot;:lock.lock();</span>
<span class="nc" id="L3782">                        cells = w.getPossibleTargetCells(playerPosition,e,g);</span>
<span class="nc" id="L3783">                        targets = w.fromCellsToTargets(cells,playerPosition,g,p,model,e);</span>
<span class="nc bnc" id="L3784" title="All 2 branches missed.">                        if (!targets.isEmpty()) {</span>
                            // ASK FOR 1 TARGET IF BASE OR UP TO 3 IF ALT
<span class="nc" id="L3786">                            sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3787">                            sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3788">                            int qw = (int)inputStream.readObject();</span>
<span class="nc" id="L3789">                            qw--;</span>
<span class="nc" id="L3790">                            Object tw = targets.get(qw);</span>
<span class="nc" id="L3791">                            List&lt;Object&gt; tar2 = new LinkedList&lt;&gt;(targets);</span>
<span class="nc" id="L3792">                            targets.clear();</span>
<span class="nc" id="L3793">                            targets.add(tw);</span>
<span class="nc" id="L3794">                            tar2.remove(tw);</span>

                            //ASK AGAIN IF ALT
<span class="nc bnc" id="L3797" title="All 2 branches missed.">                            if(e.getEffect()== AmmoCube.Effect.ALT) {</span>
<span class="nc bnc" id="L3798" title="All 2 branches missed.">                                for (int v = 0; v &lt; 2; v++) {</span>
<span class="nc" id="L3799">                                    sendToClient(&quot;CHOOSEANOTHER&quot;);</span>
<span class="nc" id="L3800">                                    String rs = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L3801" title="All 2 branches missed.">                                    if (rs.toUpperCase().equals(&quot;Y&quot;)) {</span>
<span class="nc bnc" id="L3802" title="All 2 branches missed.">                                        if (!tar2.isEmpty()) {</span>
<span class="nc" id="L3803">                                            sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3804">                                            sendListToClient(fromTargetsToNames(tar2)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3805">                                            int ye = (int) inputStream.readObject();</span>
<span class="nc" id="L3806">                                            ye--;</span>
<span class="nc" id="L3807">                                            targets.add(tar2.get(ye));</span>
<span class="nc" id="L3808">                                            tar2.remove(ye);</span>
<span class="nc" id="L3809">                                        }else{</span>
<span class="nc" id="L3810">                                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3811">                                            sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3812">                                            return new LinkedList&lt;&gt;();</span>
                                        }
                                    } else {
                                        break;
                                    }
                                }
                            }
<span class="nc" id="L3819">                            w.applyDamage(targets,p,e);</span>
<span class="nc bnc" id="L3820" title="All 2 branches missed.">                            if(e.getEffect()== AmmoCube.Effect.BASE){</span>
<span class="nc" id="L3821">                                useTargetingScope(p,targets);</span>
                            }
<span class="nc" id="L3823">                        }else{</span>
<span class="nc" id="L3824">                            sendToClient(&quot;MESSAGE&quot;);</span>
<span class="nc" id="L3825">                            sendToClient(&quot;Sorry there are no targets.&quot;);</span>
<span class="nc" id="L3826">                            numberofActionsMinusOne(w);</span>
<span class="nc" id="L3827">                            return new LinkedList&lt;&gt;();</span>
                        }
<span class="nc" id="L3829">                        lock.unlock();</span>
                        break;
                }
<span class="nc" id="L3832">            } catch (Exception ex) {</span>
<span class="nc" id="L3833">                System.out.println(&quot;Couldn't shoot.&quot;);</span>
<span class="nc" id="L3834">                numberofActionsMinusOne(w);</span>
<span class="nc" id="L3835">                ex.printStackTrace();</span>
<span class="nc" id="L3836">            }</span>
<span class="nc" id="L3837">            return new LinkedList&lt;&gt;(); // SE NON DIVERSAMENTE SPECIFICATO</span>
        }

        /**
         * This handles the TargetingScope powerup
         *
         * @param p player
         * @param targets possible targets
         */
        public void useTargetingScope(Player p, List&lt;Object&gt; targets){
<span class="nc bnc" id="L3847" title="All 2 branches missed.">            if(p.hasTargetingScope()){</span>
                try {
<span class="nc" id="L3849">                    lock.lock();</span>
                    // ASK USE TARGETING SCOPE
<span class="nc" id="L3851">                    sendToClient(&quot;TARGETINGSCOPE&quot;);</span>
<span class="nc" id="L3852">                    String res = (String) inputStream.readObject();</span>
<span class="nc bnc" id="L3853" title="All 2 branches missed.">                    if(res.toUpperCase().equals(&quot;Y&quot;)){</span>

<span class="nc" id="L3855">                        sendToClient(&quot;CUBE&quot;);</span>
<span class="nc" id="L3856">                        int r = (int) inputStream.readObject();</span>
<span class="nc" id="L3857">                        AmmoCube.CubeColor cube = AmmoCube.CubeColor.FREE;</span>
<span class="nc bnc" id="L3858" title="All 2 branches missed.">                        if(r==1){ cube = AmmoCube.CubeColor.BLUE;}</span>
<span class="nc bnc" id="L3859" title="All 2 branches missed.">                        if(r==2){ cube = AmmoCube.CubeColor.RED;}</span>
<span class="nc bnc" id="L3860" title="All 2 branches missed.">                        if(r==3){ cube = AmmoCube.CubeColor.YELLOW;}</span>

<span class="nc" id="L3862">                        action.canPayTargetingScope(cube,p);</span>

<span class="nc" id="L3864">                        sendToClient(&quot;CHOOSETARGET&quot;);</span>
<span class="nc" id="L3865">                        sendListToClient(fromTargetsToNames(targets)); // RITORNA 1 OPPURE 2 OPPURE 3 ....</span>
<span class="nc" id="L3866">                        int xyp = (int)inputStream.readObject();</span>
<span class="nc" id="L3867">                        xyp--;</span>
<span class="nc" id="L3868">                        lock.unlock();</span>
<span class="nc" id="L3869">                        p.getTargetingScope().plusOneDamage(p,targets.get(xyp));</span>
<span class="nc" id="L3870">                        PowerUpCard pow = p.getTargetingScope();</span>

<span class="nc" id="L3872">                        p.getPowerUp().remove(pow);</span>
<span class="nc" id="L3873">                        model.powerUpDeck.getUsedPowerUp().add(pow);</span>
                    }
<span class="nc" id="L3875">                } catch (Exception e) {</span>
<span class="nc" id="L3876">                    e.printStackTrace();</span>
<span class="nc" id="L3877">                    System.out.println(&quot;Couldn't use Targeting Scope.&quot;);</span>
<span class="nc" id="L3878">                }</span>
            }
<span class="nc" id="L3880">        }</span>



    } // REQUEST HANDLER


    /**
     * This Timer handles the Server countdown before the game starts.
     * It reads the TIME parameter that is given with the main in StartServer
     */
    private static class Countdown{
<span class="nc" id="L3892">        public Countdown(){</span>
<span class="nc" id="L3893">            final Timer timer = new Timer();</span>
            try {
<span class="nc" id="L3895">                timer.scheduleAtFixedRate(new TimerTask() {</span>
<span class="nc" id="L3896">                    int i = time;</span>

                    public void run() {
<span class="nc" id="L3899">                        System.out.println(i--);</span>
<span class="nc bnc" id="L3900" title="All 8 branches missed.">                        if (i&lt; 0 || connectionsCount&lt;3 || connectionsCount==5 &amp;&amp; colorsChosen.size()==5) {</span>
<span class="nc bnc" id="L3901" title="All 6 branches missed.">                            if(i&lt;0 || connectionsCount==5 &amp;&amp; colorsChosen.size()==5) {</span>
<span class="nc" id="L3902">                                System.out.println(&quot;Game is starting...&quot;);</span>

<span class="nc bnc" id="L3904" title="All 2 branches missed.">                                while (names.size()!=colorsChosen.size()){</span>
<span class="nc" id="L3905">                                    names.remove(names.size()-1);</span>
                                }
<span class="nc" id="L3907">                                setGameIsOn(true);</span>

                                //Server.startGame();
                                // DO SOMETHING TO START THE GAME
                            }
<span class="nc bnc" id="L3912" title="All 2 branches missed.">                            else if(connectionsCount&lt;3){</span>
<span class="nc" id="L3913">                                System.out.println(&quot;TIMER STOPPED: LESS THAN 3 CONNECTIONS&quot;);</span>
                            }
<span class="nc" id="L3915">                            timer.cancel();</span>
                        }
<span class="nc" id="L3917">                    }</span>
                }, 0, 1000);

<span class="nc" id="L3920">            } catch (Exception e) {</span>
                //
<span class="nc" id="L3922">            }</span>

<span class="nc" id="L3924">        }</span>
    }

    /**
     * This Timer handles the turns after the game starts.
     * It reads the same TIME parameter as the other timer but more seconds are given to the player.
     */
 private static class PlayerCountdown{
<span class="nc" id="L3932">     final Timer timer = new Timer();</span>
<span class="nc" id="L3933">        public PlayerCountdown(RequestHandler handler){</span>
            try {
<span class="nc" id="L3935">                timer.scheduleAtFixedRate(new TimerTask() {</span>
<span class="nc" id="L3936">                    int i = time*30;</span>

                    public void run() {
<span class="nc" id="L3939">                        System.out.println(i--);</span>
<span class="nc bnc" id="L3940" title="All 2 branches missed.">                        if (i&lt; 0) {</span>
<span class="nc" id="L3941">                            System.out.println(&quot;------TIME'S UP FOR &quot;+ handler.nickname);</span>
<span class="nc" id="L3942">                            timer.cancel();</span>
<span class="nc" id="L3943">                            System.out.println(&quot;          NEXT PLAYER&quot;);</span>

<span class="nc bnc" id="L3945" title="All 2 branches missed.">                            if(lock.isHeldByCurrentThread()) {</span>
<span class="nc bnc" id="L3946" title="All 2 branches missed.">                                while (lock.getHoldCount() &gt; 0) {</span>
<span class="nc" id="L3947">                                    lock.unlock();</span>
                                }
                            }

<span class="nc" id="L3951">                            handler.nextPlayer();</span>
<span class="nc" id="L3952">                            handler.disconnect();</span>
<span class="nc" id="L3953">                            handler.flagFalse();</span>
                        }
<span class="nc" id="L3955">                    }</span>
                }, 0, 1000);
<span class="nc" id="L3957">            } catch (Exception e) {</span>
                //
<span class="nc" id="L3959">            }</span>
<span class="nc" id="L3960">        }</span>
    }





    public boolean isBlank(String str) {
        int strLen;
<span class="nc bnc" id="L3969" title="All 4 branches missed.">        if (str == null || (strLen = str.length()) == 0) {</span>
<span class="nc" id="L3970">            return true;</span>
        }
<span class="nc bnc" id="L3972" title="All 2 branches missed.">        for (int i = 0; i &lt; strLen; i++) {</span>
<span class="nc bnc" id="L3973" title="All 2 branches missed.">            if ((Character.isWhitespace(str.charAt(i)) == false)) {</span>
<span class="nc" id="L3974">                return false;</span>
            }
        }
<span class="nc" id="L3977">        return true;</span>
    }
    public void setFrenzyChosen(){
<span class="nc" id="L3980">        frenzy=true;</span>
<span class="nc" id="L3981">    }</span>

    public static void setBoardChosen(int i){
<span class="nc" id="L3984">        boardChosen = i;</span>
<span class="nc" id="L3985">    }</span>

    /**
     * This handles the creation of the map, of the action controller and of the frenetic action controller
     * @param frenzyChoice
     */
    public void createBoard(boolean frenzyChoice){
<span class="nc" id="L3992">        model = new GameModel(GameModel.Mode.DEATHMATCH, GameModel.Bot.NOBOT,boardChosen, frenzyChoice);</span>
        //model.startingMap();
<span class="nc" id="L3994">        model.populateMap();</span>
        //printSomeAmmos();
<span class="nc" id="L3996">        action = new Action(model);</span>
<span class="nc" id="L3997">        freneticAction = new FreneticAction(model);</span>
<span class="nc" id="L3998">    }</span>

    public static String stringPlayerAmmo(Player p){
<span class="nc" id="L4001">        return p.toString()+&quot;: BLUE &quot;+p.getCubeBlue()+&quot; RED &quot;+p.getCubeRed()+&quot; YELLOW &quot;+p.getCubeYellow();</span>
    }
    public static void printPlayerAmmo(Player p){
<span class="fc" id="L4004">        System.out.println(p.toString()+&quot;: BLUE &quot;+p.getCubeBlue()+&quot; RED &quot;+p.getCubeRed()+&quot; YELLOW &quot;+p.getCubeYellow());</span>
<span class="fc" id="L4005">    }</span>

    public static void addCellToList(CoordinatesWithRoom c){
<span class="nc" id="L4008">        cellsWithoutTiles.add(c);</span>
<span class="nc" id="L4009">    }</span>

    public static void setGameIsOn(boolean state){
<span class="nc" id="L4012">        gameIsOn=state;</span>
<span class="nc" id="L4013">    }</span>
    public static void setEndgame(boolean state){
<span class="nc" id="L4015">        endgame=state;</span>
<span class="nc" id="L4016">    }</span>
}


</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>